<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Clinical Assessment Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    /* Prevent iOS zoom on input focus */
    input, select, textarea { font-size: 16px !important; }
    @media (min-width: 640px) { input, select, textarea { font-size: 14px !important; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

const CATEGORIES = {
  "Cardiovascular":      ["Chest pain","Palpitations","Syncope","Heart failure","Hypertension review","DVT/leg swelling","Peripheral vascular disease"],
  "Respiratory":         ["Dyspnea","Cough","Hemoptysis","Wheeze/asthma","Sleep apnea","Pleural effusion"],
  "Gastroenterology":    ["Abdominal pain","Nausea & vomiting","Diarrhea","Constipation","Rectal bleeding","Dysphagia","Jaundice","GERD/heartburn","Liver disease review","IBD review"],
  "Neurology":           ["Headache","Dizziness/vertigo","Seizure","Stroke/TIA","Weakness/numbness","Tremor","Cognitive decline/dementia","Elderly fall"],
  "Musculoskeletal":     ["Back pain","Neck pain","Knee pain","Shoulder pain","Hip pain","Ankle/foot pain","Hand/wrist pain","Joint pain/arthritis","Gout"],
  "Mental Health":       ["Depression","Anxiety","ADHD assessment","Psychosis","Eating disorder","Substance use disorder","PTSD","Mental health review","Insomnia","Burnout/stress","Suicidal crisis"],
  "Infectious Disease":  ["Fever","Fever in returned traveller","Urinary tract infection","Skin infection/cellulitis","Pneumonia","STI screen","HIV review","Tuberculosis","COVID-19","Sepsis","Anaphylaxis","Overdose/Toxidrome"],
  "Endocrine/Metabolic": ["Diabetes review","Thyroid disease","Obesity review","Metabolic syndrome","Hyperlipidemia review"],
  "Men's Health":        ["Erectile dysfunction","LUTS/prostate","Testicular pain","Scrotal swelling","PSA discussion","Testosterone deficiency"],
  "Women's Health":      ["1st trimester bleeding","Pelvic pain","Vaginal discharge","Abnormal uterine bleeding","Menopause","Breast lump","Cervical screening","Contraception review","Antenatal review","Postnatal review"],
  "Paediatrics":         ["Febrile child","4 year old developmental review","Newborn check","Growth concerns","Behavioural concerns","Childhood asthma review","Ear pain (child)","Rash (child)","Failure to thrive","Immunisation review"],
  "Dermatology":         ["Rash","Skin lesion","Acne","Eczema review","Psoriasis review","Skin cancer screening","Urticaria","Alopecia"],
  "Eyes/Ears/Nose/Throat":["Red eye","Visual disturbance","Ear pain","Hearing loss","Tinnitus","Sore throat","Sinusitis","Epistaxis","Hoarseness"],
  "Urology/Nephrology":  ["Haematuria","Renal colic","Chronic kidney disease review","Urinary incontinence","Recurrent UTI"],
  "General/Preventive":  ["Fatigue","Weight loss","Night sweats","Anaemia","Well adult check","Medication review","Travel medicine","Palliative care review"],
};

const DIAGNOSES = {
  "Chest pain":           "ACS, Aortic dissection, Pneumothorax, Pulmonary embolus, Esophageal rupture",
  "Palpitations":         "VT/VF, Complete heart block, WPW, Structural heart disease, Thyroid storm",
  "Syncope":              "Arrhythmia, Structural heart disease, PE, Aortic stenosis, ACS",
  "Heart failure":        "Acute decompensation, Arrhythmia, ACS, Valve disease",
  "Hypertension review":  "Hypertensive emergency, End organ damage, Secondary hypertension",
  "DVT/leg swelling":     "Pulmonary embolus, Phlegmasia cerulea dolens",
  "Peripheral vascular disease": "Critical limb ischemia, Gangrene, Amputation",
  "Dyspnea":              "PE, Pneumothorax, Acute heart failure, COPD exacerbation, Anaphylaxis",
  "Cough":                "Lung cancer, Pneumonia, Tuberculosis, PE, Heart failure",
  "Hemoptysis":           "Lung cancer, Tuberculosis, PE, Bronchiectasis",
  "Wheeze/asthma":        "Life-threatening asthma, Anaphylaxis, Foreign body",
  "Sleep apnea":          "Cardiovascular disease, Driving accident",
  "Pleural effusion":     "Malignancy, Empyema, Heart failure",
  "Abdominal pain":       "AAA, Bowel perforation, Bowel obstruction, Ectopic pregnancy, Mesenteric ischemia",
  "Nausea & vomiting":    "Bowel obstruction, Raised ICP, Appendicitis, Ectopic pregnancy",
  "Diarrhea":             "C. difficile, Inflammatory bowel disease, Colorectal cancer",
  "Constipation":         "Bowel obstruction, Colorectal cancer, Volvulus",
  "Rectal bleeding":      "Colorectal cancer, IBD, Diverticular bleeding, Upper GI bleed",
  "Dysphagia":            "Oesophageal cancer, Stroke, Motor neuron disease",
  "Jaundice":             "Cholangiocarcinoma, Pancreatic cancer, Acute liver failure",
  "GERD/heartburn":       "Oesophageal cancer, Barrett's oesophagus, Cardiac chest pain",
  "Liver disease review": "Hepatocellular carcinoma, Variceal bleed, Hepatic encephalopathy",
  "IBD review":           "Perforation, Toxic megacolon, Malignancy",
  "Headache":             "Subarachnoid haemorrhage, Meningitis, Temporal arteritis, Stroke, Hypertensive emergency",
  "Dizziness/vertigo":    "Stroke, Posterior circulation TIA, Cardiac arrhythmia",
  "Seizure":              "Status epilepticus, Meningitis, Encephalitis, Structural lesion",
  "Stroke/TIA":           "Malignant MCA syndrome, Cerebellar stroke, PICA infarct",
  "Weakness/numbness":    "Stroke, Spinal cord compression, GBS, MND",
  "Tremor":               "Wilson's disease, Parkinson's disease",
  "Cognitive decline/dementia": "Reversible causes (infection/metabolic/medication), Normal pressure hydrocephalus",
  "Back pain":            "Cauda equina, Spinal cord compression, Malignancy, Vertebral infection, AAA",
  "Neck pain":            "Cervical myelopathy, Meningitis, Carotid/vertebral artery dissection",
  "Knee pain":            "Septic arthritis, DVT, Compartment syndrome",
  "Shoulder pain":        "Septic arthritis, Rotator cuff tear, Referred cardiac pain",
  "Hip pain":             "Septic arthritis, Femoral neck fracture, AVN",
  "Ankle/foot pain":      "Fracture, Necrotising fasciitis, Septic arthritis",
  "Hand/wrist pain":      "Scaphoid fracture, Septic arthritis, Median nerve compression",
  "Joint pain/arthritis": "Septic arthritis, Crystal arthropathy, Systemic vasculitis",
  "Gout":                 "Septic arthritis, Pseudogout, Cellulitis",
  "Depression":           "Bipolar disorder, Suicidality, Psychotic depression",
  "Anxiety":              "Panic disorder, Cardiac arrhythmia, Thyroid disease, Suicidality",
  "ADHD assessment":      "ASD, Learning disability, Anxiety, Sleep disorder",
  "Psychosis":            "Acute psychotic episode, Suicide/homicide risk, Drug-induced psychosis",
  "Eating disorder":      "Cardiac arrhythmia (electrolytes), Refeeding syndrome, Suicide risk",
  "Substance use disorder":"Withdrawal seizure, Wernicke's encephalopathy, Overdose",
  "PTSD":                 "Suicide risk, Dissociative disorder, Substance use disorder",
  "Mental health review": "Suicide/self-harm risk, Medication toxicity",
  "Insomnia":             "Obstructive sleep apnea, Mood disorder, Substance misuse",
  "Burnout/stress":       "Suicidality, Severe depression, Breakdown",
  "Fever":                "Meningococcal disease, Sepsis, Endocarditis, Malignancy",
  "Fever in returned traveller": "Malaria, Typhoid, Dengue fever, Rickettsial disease, Meningococcal disease",
  "Urinary tract infection": "Urosepsis, Pyelonephritis, Renal abscess",
  "Skin infection/cellulitis": "Necrotising fasciitis, Sepsis, Osteomyelitis",
  "Pneumonia":            "Sepsis, Empyema, Respiratory failure",
  "STI screen":           "HIV, Pelvic inflammatory disease, Syphilis",
  "HIV review":           "Opportunistic infection, Lymphoma, Drug toxicity",
  "Tuberculosis":         "Miliary TB, CNS tuberculosis, Drug resistance",
  "COVID-19":             "Severe pneumonia, Cytokine storm, PE",
  "Sepsis":               "Septic shock, Multi-organ failure, Death",
  "Anaphylaxis":          "Cardiac arrest, Airway obstruction, Refractory anaphylaxis",
  "Overdose/Toxidrome":   "Respiratory arrest, Cardiac arrhythmia, Seizure, Death",
  "Suicidal crisis":      "Death by suicide, Serious self-harm, Psychotic break",
  "Elderly fall":         "Intracranial haemorrhage, Cervical spine injury, Subdural haematoma, Hip fracture, Rhabdomyolysis",
  "Diabetes review":      "DKA, HHS, Hypoglycemia, Renal failure",
  "Thyroid disease":      "Thyroid storm, Myxoedema coma",
  "Obesity review":       "OSA, T2DM, Cardiovascular event, Malignancy",
  "Metabolic syndrome":   "T2DM, Cardiovascular event, NAFLD/NASH",
  "Hyperlipidemia review":"Cardiovascular event, Statin myopathy, Rhabdomyolysis",
  "Erectile dysfunction":  "Cardiovascular disease (endothelial marker), Testosterone deficiency, Depression",
  "LUTS/prostate":        "Prostate cancer, Acute urinary retention, Urosepsis",
  "Testicular pain":      "Testicular torsion (surgical emergency), Epididymo-orchitis",
  "Scrotal swelling":     "Testicular torsion, Strangulated hernia, Testicular cancer",
  "PSA discussion":       "Prostate cancer",
  "Testosterone deficiency": "Pituitary tumour, Klinefelter syndrome",
  "1st trimester bleeding":"Ectopic pregnancy, Haemodynamic compromise",
  "Pelvic pain":          "Ectopic pregnancy, Ovarian torsion, Appendicitis, PID",
  "Vaginal discharge":    "PID, Ectopic pregnancy, Cervical cancer",
  "Abnormal uterine bleeding": "Endometrial cancer, Ectopic pregnancy, Coagulopathy",
  "Menopause":            "Premature ovarian insufficiency, Endometrial cancer (PMB)",
  "Breast lump":          "Breast cancer, Phyllodes tumour",
  "Cervical screening":   "Cervical cancer, CIN3",
  "Contraception review": "Thromboembolism (COCP), Ectopic pregnancy",
  "Antenatal review":     "Pre-eclampsia, Placental abruption, IUGR",
  "Postnatal review":     "Postnatal depression, Puerperal psychosis, Sepsis",
  "Febrile child":        "Meningococcal disease, Sepsis, Kawasaki disease",
  "4 year old developmental review": "ASD, Global developmental delay, Hearing/vision impairment",
  "Newborn check":        "Critical congenital heart disease, DDH, Retinoblastoma",
  "Growth concerns":      "Malignancy, Coeliac disease, Endocrine disorder",
  "Behavioural concerns": "ASD, ADHD, Abuse/neglect, Mood disorder",
  "Childhood asthma review": "Life-threatening asthma, Foreign body, Cardiac cause",
  "Ear pain (child)":     "Mastoiditis, Cholesteatoma, Meningitis",
  "Rash (child)":         "Meningococcal disease, Kawasaki, Stevens-Johnson syndrome",
  "Failure to thrive":    "Malignancy, Coeliac disease, Immune deficiency, Neglect",
  "Immunisation review":  "Vaccine-preventable disease, Anaphylaxis to vaccine",
  "Rash":                 "Meningococcal, Stevens-Johnson syndrome, Necrotising fasciitis",
  "Skin lesion":          "Melanoma, Squamous cell carcinoma, Merkel cell carcinoma",
  "Acne":                 "Acne fulminans, Psychological crisis",
  "Eczema review":        "Eczema herpeticum, Secondary sepsis",
  "Psoriasis review":     "Erythrodermic psoriasis, Psoriatic arthritis mutilans",
  "Skin cancer screening":"Melanoma, SCC, Kaposi sarcoma",
  "Urticaria":            "Anaphylaxis, C1 inhibitor deficiency",
  "Alopecia":             "Scarring alopecia (irreversible), Systemic lupus",
  "Red eye":              "Closed angle glaucoma, Corneal ulcer, Endophthalmitis",
  "Visual disturbance":   "Retinal detachment, Giant cell arteritis, Stroke, Closed angle glaucoma",
  "Ear pain":             "Mastoiditis, Cholesteatoma, Referred malignancy",
  "Hearing loss":         "Acoustic neuroma, Sudden SNHL (treatable if urgent), Malignancy",
  "Tinnitus":             "Acoustic neuroma, Vascular malformation",
  "Sore throat":          "Peritonsillar abscess, Epiglottitis, Ludwig's angina",
  "Sinusitis":            "Orbital cellulitis, Intracranial extension, Meningitis",
  "Epistaxis":            "Haematological malignancy, Nasopharyngeal carcinoma, Coagulopathy",
  "Hoarseness":           "Laryngeal cancer, Recurrent laryngeal nerve palsy, Anaphylaxis",
  "Haematuria":           "Bladder cancer, Renal cell carcinoma, Urothelial malignancy",
  "Renal colic":          "AAA, Ectopic pregnancy, Urosepsis",
  "Chronic kidney disease review": "AKI, Malignant hypertension, Dialysis requirement",
  "Urinary incontinence": "Cauda equina syndrome, Bladder malignancy",
  "Recurrent UTI":        "Bladder cancer, Urothelial malignancy, Structural abnormality",
  "Fatigue":              "Malignancy, Anaemia, Hypothyroidism, Adrenal insufficiency, Heart failure",
  "Weight loss":          "Malignancy, Tuberculosis, HIV, Diabetes, Addison's disease",
  "Night sweats":         "Lymphoma, Tuberculosis, HIV, Malignancy",
  "Anaemia":              "Haematological malignancy, GI malignancy, Haemolytic crisis",
  "Well adult check":     "Undiagnosed malignancy, Cardiovascular risk, Diabetes",
  "Medication review":    "Drug toxicity, Drug interactions, Polypharmacy harm",
  "Travel medicine":      "Malaria, Typhoid, Yellow fever, Meningococcal disease",
  "Palliative care review":"Uncontrolled pain, Dyspnoea emergency, Terminal agitation",
};

const MASTER_FEATURES = {
  "Chest pain": [
    { key:"cp_exertional", safe:"Not exertional", unsafe:"Exertional pain" },
    { key:"cp_rest_relief", safe:"Relieved by rest", unsafe:"Not relieved by rest" },
    { key:"cp_rad_arm", safe:"No radiation to arm", unsafe:"Radiates to arm" },
    { key:"cp_rad_jaw", safe:"No radiation to jaw", unsafe:"Radiates to jaw" },
    { key:"cp_rad_back", safe:"No radiation to back", unsafe:"Radiates to back" },
    { key:"cp_diaphoresis", safe:"No diaphoresis", unsafe:"Diaphoresis" },
    { key:"cp_dyspnea", safe:"No dyspnea", unsafe:"Associated dyspnea" },
    { key:"cp_nausea", safe:"No nausea/vomiting", unsafe:"Nausea/vomiting" },
    { key:"cp_palpitations", safe:"No palpitations", unsafe:"Palpitations" },
    { key:"cp_syncope", safe:"No syncope", unsafe:"Syncope" },
    { key:"cp_pleuritic", safe:"No pleuritic component", unsafe:"Pleuritic component" },
    { key:"cp_positional", safe:"Not positional", unsafe:"Positional pain" },
    { key:"cp_reproducible", safe:"Not reproducible", unsafe:"Reproducible on palpation" },
    { key:"cp_tearing", safe:"No tearing quality", unsafe:"Tearing quality (dissection)" },
  ],
  "Palpitations": [
    { key:"palp_chestpain", safe:"No chest pain", unsafe:"Associated chest pain" },
    { key:"palp_syncope", safe:"No syncope", unsafe:"Associated syncope" },
    { key:"palp_dizziness", safe:"No dizziness", unsafe:"Associated dizziness" },
    { key:"palp_exertional", safe:"Not exertional", unsafe:"Exertional palpitations" },
    { key:"palp_dyspnea", safe:"No dyspnea", unsafe:"Associated dyspnea" },
    { key:"palp_regular", safe:"Regular rhythm felt", unsafe:"Irregular rhythm felt" },
    { key:"palp_sudden", safe:"Gradual onset", unsafe:"Sudden onset/offset" },
    { key:"palp_family_scd", safe:"No family SCD", unsafe:"Family sudden cardiac death" },
    { key:"palp_thyroid", safe:"No thyroid symptoms", unsafe:"Thyroid symptoms" },
    { key:"palp_caffeine", safe:"Low caffeine", unsafe:"High caffeine/stimulants" },
    { key:"palp_anxiety", safe:"No anxiety symptoms", unsafe:"Anxiety symptoms" },
  ],
  "Syncope": [
    { key:"syn_exertional", safe:"Not exertional", unsafe:"Exertional syncope" },
    { key:"syn_supine", safe:"Not supine", unsafe:"Syncope while supine" },
    { key:"syn_prodrome", safe:"Prodrome present", unsafe:"No prodrome" },
    { key:"syn_duration", safe:"Brief LOC", unsafe:"Prolonged LOC" },
    { key:"syn_seizure", safe:"No seizure activity", unsafe:"Seizure-like activity" },
    { key:"syn_family_scd", safe:"No family SCD", unsafe:"Family sudden cardiac death" },
    { key:"syn_chestpain", safe:"No chest pain", unsafe:"Chest pain" },
    { key:"syn_palp", safe:"No palpitations", unsafe:"Palpitations" },
    { key:"syn_recovery", safe:"Rapid recovery", unsafe:"Prolonged recovery" },
    { key:"syn_dehydration", safe:"Euvolemic", unsafe:"Dehydration/volume depleted" },
    { key:"syn_newmeds", safe:"No new medications", unsafe:"Recent medication change" },
  ],
  "Heart failure": [
    { key:"hf_dyspnea", safe:"No dyspnea", unsafe:"Dyspnea on exertion" },
    { key:"hf_orthopnea", safe:"No orthopnea", unsafe:"Orthopnea" },
    { key:"hf_pnd", safe:"No PND", unsafe:"PND" },
    { key:"hf_edema", safe:"No peripheral edema", unsafe:"Peripheral edema" },
    { key:"hf_fatigue", safe:"Energy levels stable", unsafe:"Increasing fatigue" },
    { key:"hf_weight", safe:"Weight stable", unsafe:"Weight gain >2kg/week" },
    { key:"hf_compliance", safe:"Medication compliant", unsafe:"Non-compliant with medications" },
    { key:"hf_salt", safe:"Low salt diet", unsafe:"High salt intake" },
    { key:"hf_fluid", safe:"Fluid restriction met", unsafe:"Excess fluid intake" },
    { key:"hf_syncope", safe:"No syncope", unsafe:"Syncope/presyncope" },
    { key:"hf_palpitations", safe:"No palpitations", unsafe:"Palpitations" },
    { key:"hf_infection", safe:"No recent infection", unsafe:"Recent infection/illness" },
  ],
  "Hypertension review": [
    { key:"htn_headache", safe:"No headache", unsafe:"Headache" },
    { key:"htn_visual", safe:"No visual disturbance", unsafe:"Visual disturbance" },
    { key:"htn_chest", safe:"No chest pain", unsafe:"Chest pain" },
    { key:"htn_dyspnea", safe:"No dyspnea", unsafe:"Dyspnea" },
    { key:"htn_compliance", safe:"Medication compliant", unsafe:"Non-compliant" },
    { key:"htn_salt", safe:"Low salt diet", unsafe:"High salt intake" },
    { key:"htn_alcohol", safe:"Low alcohol", unsafe:"Excess alcohol" },
    { key:"htn_exercise", safe:"Regular exercise", unsafe:"Sedentary" },
    { key:"htn_smoking", safe:"Non-smoker", unsafe:"Smoker" },
    { key:"htn_monitor", safe:"Home monitoring done", unsafe:"No home monitoring" },
    { key:"htn_secondcause", safe:"No secondary cause features", unsafe:"Secondary cause features" },
  ],
  "DVT/leg swelling": [
    { key:"dvt_unilateral", safe:"Bilateral swelling", unsafe:"Unilateral swelling" },
    { key:"dvt_warmth", safe:"No warmth/erythema", unsafe:"Warmth/erythema" },
    { key:"dvt_tender", safe:"Non-tender", unsafe:"Calf tenderness" },
    { key:"dvt_pe", safe:"No dyspnea/chest pain", unsafe:"Dyspnea/pleuritic pain" },
    { key:"dvt_recent_surg", safe:"No recent surgery", unsafe:"Recent surgery/immobility" },
    { key:"dvt_malignancy", safe:"No active malignancy", unsafe:"Active malignancy" },
    { key:"dvt_prev_dvt", safe:"No previous DVT", unsafe:"Previous DVT/PE" },
    { key:"dvt_oc", safe:"No oral contraceptive", unsafe:"On oral contraceptive" },
    { key:"dvt_travel", safe:"No long travel", unsafe:"Recent long-haul travel" },
    { key:"dvt_pitting", safe:"Non-pitting edema", unsafe:"Pitting edema" },
  ],
  "Peripheral vascular disease": [
    { key:"pvd_claudication", safe:"No claudication", unsafe:"Claudication" },
    { key:"pvd_restpain", safe:"No rest pain", unsafe:"Rest pain" },
    { key:"pvd_ulcer", safe:"No ulceration", unsafe:"Ulceration present" },
    { key:"pvd_distance", safe:"Walking distance stable", unsafe:"Reduced walking distance" },
    { key:"pvd_smoking", safe:"Non-smoker", unsafe:"Current smoker" },
    { key:"pvd_diabetes", safe:"No diabetes", unsafe:"Diabetes" },
    { key:"pvd_cold", safe:"No cold extremities", unsafe:"Cold extremities" },
    { key:"pvd_colour", safe:"Normal skin colour", unsafe:"Pallor/cyanosis/gangrene" },
  ],
  "Dyspnea": [
    { key:"dys_pleuritic", safe:"No pleuritic pain", unsafe:"Pleuritic pain" },
    { key:"dys_cough", safe:"No cough", unsafe:"Cough present" },
    { key:"dys_hemoptysis", safe:"No hemoptysis", unsafe:"Hemoptysis" },
    { key:"dys_legswelling", safe:"No leg swelling", unsafe:"Leg swelling" },
    { key:"dys_orthopnea", safe:"No orthopnea", unsafe:"Orthopnea" },
    { key:"dys_pnd", safe:"No PND", unsafe:"PND present" },
    { key:"dys_dvt", safe:"No DVT symptoms", unsafe:"Unilateral leg swelling/pain" },
    { key:"dys_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"dys_wheeze", safe:"No wheeze", unsafe:"Wheeze" },
    { key:"dys_stridor", safe:"No stridor", unsafe:"Stridor" },
    { key:"dys_chestpain", safe:"No chest pain", unsafe:"Chest pain" },
    { key:"dys_acute", safe:"Gradual onset", unsafe:"Acute onset" },
  ],
  "Cough": [
    { key:"cough_hemoptysis", safe:"No hemoptysis", unsafe:"Hemoptysis" },
    { key:"cough_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"cough_nightsweat", safe:"No night sweats", unsafe:"Night sweats" },
    { key:"cough_productive", safe:"Dry cough", unsafe:"Productive cough" },
    { key:"cough_duration", safe:"Acute (<3 weeks)", unsafe:"Chronic (>8 weeks)" },
    { key:"cough_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"cough_wheeze", safe:"No wheeze", unsafe:"Wheeze" },
    { key:"cough_dyspnea", safe:"No dyspnea", unsafe:"Dyspnea" },
    { key:"cough_smoker", safe:"Non-smoker", unsafe:"Smoker/ex-smoker" },
    { key:"cough_nocturnal", safe:"No nocturnal cough", unsafe:"Nocturnal cough" },
    { key:"cough_ace", safe:"No ACE inhibitor", unsafe:"On ACE inhibitor" },
  ],
  "Hemoptysis": [
    { key:"hopt_amount", safe:"Streaky only", unsafe:"Frank hemoptysis" },
    { key:"hopt_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"hopt_nightsweat", safe:"No night sweats", unsafe:"Night sweats" },
    { key:"hopt_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"hopt_smoker", safe:"Non-smoker", unsafe:"Smoker/ex-smoker" },
    { key:"hopt_dvt", safe:"No DVT symptoms", unsafe:"DVT symptoms" },
    { key:"hopt_dyspnea", safe:"No dyspnea", unsafe:"Dyspnea" },
    { key:"hopt_recurrent", safe:"First episode", unsafe:"Recurrent episodes" },
    { key:"hopt_immuno", safe:"Immunocompetent", unsafe:"Immunocompromised" },
  ],
  "Wheeze/asthma": [
    { key:"wh_nocturnal", safe:"No nocturnal symptoms", unsafe:"Nocturnal wheeze/cough" },
    { key:"wh_exercise", safe:"No exercise limitation", unsafe:"Exercise-induced symptoms" },
    { key:"wh_frequency", safe:"Infrequent symptoms", unsafe:"Daily/frequent symptoms" },
    { key:"wh_reliever", safe:"Reliever <3x/week", unsafe:"Reliever >3x/week" },
    { key:"wh_preventer", safe:"Preventer compliant", unsafe:"Non-compliant with preventer" },
    { key:"wh_trigger", safe:"No identified triggers", unsafe:"Identified triggers" },
    { key:"wh_technique", safe:"Good inhaler technique", unsafe:"Poor inhaler technique" },
    { key:"wh_oral_steroid", safe:"No oral steroids", unsafe:"Recent oral steroids" },
    { key:"wh_ed", safe:"No ED presentations", unsafe:"Recent ED/hospital admission" },
    { key:"wh_plan", safe:"Asthma action plan in place", unsafe:"No asthma action plan" },
  ],
  "Sleep apnea": [
    { key:"osa_snoring", safe:"No snoring", unsafe:"Loud snoring" },
    { key:"osa_witnessed", safe:"No witnessed apneas", unsafe:"Witnessed apneas" },
    { key:"osa_daytime", safe:"No daytime sleepiness", unsafe:"Excessive daytime sleepiness" },
    { key:"osa_morning_ha", safe:"No morning headaches", unsafe:"Morning headaches" },
    { key:"osa_nocturia", safe:"No nocturia", unsafe:"Nocturia" },
    { key:"osa_concentration", safe:"Concentration normal", unsafe:"Poor concentration" },
    { key:"osa_cpap", safe:"CPAP compliant", unsafe:"Non-compliant with CPAP" },
    { key:"osa_driving", safe:"No driving concerns", unsafe:"Driving safety concern" },
    { key:"osa_alcohol", safe:"Low alcohol", unsafe:"Alcohol use" },
  ],
  "Pleural effusion": [
    { key:"plef_dyspnea", safe:"Minimal dyspnea", unsafe:"Significant dyspnea" },
    { key:"plef_pleuritic", safe:"No pleuritic pain", unsafe:"Pleuritic pain" },
    { key:"plef_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"plef_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"plef_malignancy", safe:"No known malignancy", unsafe:"Known malignancy" },
    { key:"plef_cardiac", safe:"No cardiac disease", unsafe:"Known cardiac disease" },
    { key:"plef_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
  ],
  "Abdominal pain": [
    { key:"ap_guarding", safe:"No guarding", unsafe:"Guarding" },
    { key:"ap_rebound", safe:"No rebound tenderness", unsafe:"Rebound tenderness" },
    { key:"ap_peritonism", safe:"No peritonism", unsafe:"Peritonism" },
    { key:"ap_vomiting", safe:"No vomiting", unsafe:"Vomiting" },
    { key:"ap_diarrhea", safe:"No diarrhea", unsafe:"Diarrhea" },
    { key:"ap_constipation", safe:"No constipation", unsafe:"Constipation" },
    { key:"ap_melaena", safe:"No melaena", unsafe:"Melaena" },
    { key:"ap_pr_bleed", safe:"No PR bleeding", unsafe:"PR bleeding" },
    { key:"ap_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"ap_anorexia", safe:"Appetite normal", unsafe:"Anorexia" },
    { key:"ap_jaundice", safe:"No jaundice", unsafe:"Jaundice" },
    { key:"ap_urinary", safe:"No urinary symptoms", unsafe:"Urinary symptoms" },
    { key:"ap_lmp", safe:"LMP normal", unsafe:"LMP abnormal/missed" },
    { key:"ap_radiation", safe:"No radiation", unsafe:"Radiation to back/groin" },
  ],
  "Nausea & vomiting": [
    { key:"nv_blood", safe:"No blood in vomit", unsafe:"Haematemesis" },
    { key:"nv_dehydration", safe:"No dehydration", unsafe:"Signs of dehydration" },
    { key:"nv_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"nv_abdo", safe:"No abdominal pain", unsafe:"Abdominal pain" },
    { key:"nv_headache", safe:"No headache", unsafe:"Headache" },
    { key:"nv_vertigo", safe:"No vertigo", unsafe:"Vertigo" },
    { key:"nv_pregnant", safe:"Not pregnant", unsafe:"Possibly pregnant" },
    { key:"nv_medication", safe:"No new medications", unsafe:"Recent new medication" },
    { key:"nv_bowel", safe:"Bowel movements normal", unsafe:"Bowel obstruction features" },
  ],
  "Diarrhea": [
    { key:"dia_blood", safe:"No blood in stool", unsafe:"Blood in stool" },
    { key:"dia_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"dia_dehydration", safe:"No dehydration", unsafe:"Dehydration" },
    { key:"dia_duration", safe:"Acute (<2 weeks)", unsafe:"Chronic (>4 weeks)" },
    { key:"dia_travel", safe:"No recent travel", unsafe:"Recent travel" },
    { key:"dia_contact", safe:"No sick contacts", unsafe:"Sick contacts" },
    { key:"dia_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"dia_nocturnal", safe:"No nocturnal symptoms", unsafe:"Nocturnal diarrhea" },
    { key:"dia_mucus", safe:"No mucus", unsafe:"Mucus in stool" },
    { key:"dia_antibiotics", safe:"No recent antibiotics", unsafe:"Recent antibiotics" },
  ],
  "Constipation": [
    { key:"con_blood", safe:"No rectal bleeding", unsafe:"Rectal bleeding" },
    { key:"con_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"con_bowel_habit", safe:"Bowel habit unchanged", unsafe:"Change in bowel habit" },
    { key:"con_pain", safe:"No abdominal pain", unsafe:"Abdominal pain" },
    { key:"con_vomiting", safe:"No vomiting", unsafe:"Vomiting" },
    { key:"con_overflow", safe:"No overflow diarrhea", unsafe:"Overflow diarrhea" },
    { key:"con_medication", safe:"No constipating meds", unsafe:"Constipating medications" },
    { key:"con_diet", safe:"Adequate fibre/fluids", unsafe:"Low fibre/fluid intake" },
    { key:"con_thyroid", safe:"No thyroid symptoms", unsafe:"Hypothyroid symptoms" },
  ],
  "Rectal bleeding": [
    { key:"rb_volume", safe:"Small amount", unsafe:"Large volume bleeding" },
    { key:"rb_melaena", safe:"No melaena", unsafe:"Melaena" },
    { key:"rb_haematemesis", safe:"No haematemesis", unsafe:"Haematemesis" },
    { key:"rb_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"rb_bowel_habit", safe:"No change in bowel habit", unsafe:"Change in bowel habit" },
    { key:"rb_fhx", safe:"No family history CRC", unsafe:"Family history of CRC" },
    { key:"rb_painful", safe:"Painless bleeding", unsafe:"Painful bleeding" },
    { key:"rb_mixed", safe:"Blood on paper only", unsafe:"Mixed with stool" },
    { key:"rb_anaemia", safe:"No anaemia symptoms", unsafe:"Anaemia symptoms" },
  ],
  "Dysphagia": [
    { key:"dysph_solid", safe:"Liquids only affected", unsafe:"Solids and liquids affected" },
    { key:"dysph_progressive", safe:"Stable", unsafe:"Progressive dysphagia" },
    { key:"dysph_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"dysph_regurg", safe:"No regurgitation", unsafe:"Regurgitation" },
    { key:"dysph_pain", safe:"No odynophagia", unsafe:"Odynophagia" },
    { key:"dysph_neuro", safe:"No neurological symptoms", unsafe:"Neurological symptoms" },
    { key:"dysph_duration", safe:"Acute onset", unsafe:"Longstanding" },
    { key:"dysph_aspiration", safe:"No aspiration", unsafe:"Cough on swallowing" },
  ],
  "Jaundice": [
    { key:"jaun_pain", safe:"Painless", unsafe:"Painful jaundice" },
    { key:"jaun_fever", safe:"Afebrile", unsafe:"Fever/rigors" },
    { key:"jaun_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"jaun_dark_urine", safe:"Normal urine colour", unsafe:"Dark urine" },
    { key:"jaun_pale_stool", safe:"Normal stool colour", unsafe:"Pale stools" },
    { key:"jaun_itch", safe:"No pruritus", unsafe:"Pruritus" },
    { key:"jaun_alcohol", safe:"No excess alcohol", unsafe:"Excess alcohol use" },
    { key:"jaun_medication", safe:"No hepatotoxic meds", unsafe:"Hepatotoxic medications" },
    { key:"jaun_travel", safe:"No recent travel", unsafe:"Recent travel" },
  ],
  "GERD/heartburn": [
    { key:"gerd_dysphagia", safe:"No dysphagia", unsafe:"Dysphagia" },
    { key:"gerd_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"gerd_anaemia", safe:"No anaemia symptoms", unsafe:"Anaemia symptoms" },
    { key:"gerd_vomiting", safe:"No vomiting", unsafe:"Vomiting" },
    { key:"gerd_nocturnal", safe:"No nocturnal symptoms", unsafe:"Nocturnal symptoms" },
    { key:"gerd_ppi", safe:"PPI effective", unsafe:"PPI ineffective" },
    { key:"gerd_alarm", safe:"No alarm symptoms", unsafe:"Alarm symptoms present" },
    { key:"gerd_bmi", safe:"Normal BMI", unsafe:"Overweight/obese" },
    { key:"gerd_trigger", safe:"No dietary triggers", unsafe:"Dietary triggers" },
  ],
  "Liver disease review": [
    { key:"liver_enceph", safe:"No encephalopathy", unsafe:"Encephalopathy features" },
    { key:"liver_ascites", safe:"No ascites", unsafe:"Ascites" },
    { key:"liver_varices", safe:"No variceal bleeding", unsafe:"Variceal bleeding history" },
    { key:"liver_alcohol", safe:"Alcohol abstinent", unsafe:"Ongoing alcohol use" },
    { key:"liver_fatigue", safe:"Fatigue stable", unsafe:"Worsening fatigue" },
    { key:"liver_jaundice", safe:"No jaundice", unsafe:"Jaundice" },
    { key:"liver_bleed", safe:"No bleeding tendency", unsafe:"Bleeding tendency" },
    { key:"liver_weightloss", safe:"Weight stable", unsafe:"Weight loss" },
  ],
  "IBD review": [
    { key:"ibd_flare", safe:"In remission", unsafe:"Active flare" },
    { key:"ibd_blood", safe:"No rectal bleeding", unsafe:"Rectal bleeding" },
    { key:"ibd_pain", safe:"No abdominal pain", unsafe:"Abdominal pain" },
    { key:"ibd_frequency", safe:"Normal bowel frequency", unsafe:"Increased frequency" },
    { key:"ibd_weightloss", safe:"Weight stable", unsafe:"Weight loss" },
    { key:"ibd_extraintest", safe:"No extraintestinal features", unsafe:"Extraintestinal features" },
    { key:"ibd_compliance", safe:"Medication compliant", unsafe:"Non-compliant" },
    { key:"ibd_scope", safe:"Recent colonoscopy done", unsafe:"Colonoscopy overdue" },
    { key:"ibd_steroid", safe:"No systemic steroids", unsafe:"On systemic steroids" },
  ],
  "Headache": [
    { key:"ha_onset", safe:"Gradual onset", unsafe:"Sudden thunderclap onset" },
    { key:"ha_severity", safe:"Typical severity", unsafe:"Worst headache ever" },
    { key:"ha_visual", safe:"No visual changes", unsafe:"Visual changes" },
    { key:"ha_focal", safe:"No focal neurology", unsafe:"Focal neurological signs" },
    { key:"ha_neck", safe:"No neck stiffness", unsafe:"Neck stiffness" },
    { key:"ha_photophobia", safe:"No photophobia", unsafe:"Photophobia" },
    { key:"ha_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"ha_trauma", safe:"No trauma", unsafe:"Recent head trauma" },
    { key:"ha_vomiting", safe:"No vomiting", unsafe:"Vomiting" },
    { key:"ha_postural", safe:"Not postural", unsafe:"Postural component" },
    { key:"ha_progressive", safe:"Not progressive", unsafe:"Progressive headache" },
    { key:"ha_morning", safe:"Not worse in morning", unsafe:"Worse in morning" },
    { key:"ha_exertional", safe:"Not exertional", unsafe:"Exertional headache" },
    { key:"ha_aura", safe:"No aura", unsafe:"Aura present" },
  ],
  "Dizziness/vertigo": [
    { key:"diz_focal", safe:"No focal neurology", unsafe:"Focal neurological signs" },
    { key:"diz_visual", safe:"No visual changes", unsafe:"Visual changes" },
    { key:"diz_hearing", safe:"No hearing loss", unsafe:"Hearing loss" },
    { key:"diz_tinnitus", safe:"No tinnitus", unsafe:"Tinnitus" },
    { key:"diz_positional", safe:"Not positional", unsafe:"Positional trigger" },
    { key:"diz_nausea", safe:"No nausea/vomiting", unsafe:"Nausea/vomiting" },
    { key:"diz_falls", safe:"No falls", unsafe:"Falls" },
    { key:"diz_acute", safe:"Gradual onset", unsafe:"Acute onset" },
    { key:"diz_headache", safe:"No headache", unsafe:"Headache" },
    { key:"diz_diplopia", safe:"No diplopia", unsafe:"Diplopia" },
    { key:"diz_syncope", safe:"No syncope", unsafe:"Syncope" },
  ],
  "Seizure": [
    { key:"sz_provoked", safe:"Unprovoked", unsafe:"Provoked seizure" },
    { key:"sz_focal", safe:"Generalised", unsafe:"Focal onset" },
    { key:"sz_postictal", safe:"Rapid recovery", unsafe:"Prolonged postictal" },
    { key:"sz_previous", safe:"First seizure", unsafe:"Previous seizures" },
    { key:"sz_fever", safe:"Afebrile", unsafe:"Fever/infection" },
    { key:"sz_head_trauma", safe:"No recent head trauma", unsafe:"Recent head trauma" },
    { key:"sz_toxic", safe:"No toxins/drugs", unsafe:"Toxin/drug exposure" },
    { key:"sz_compliance", safe:"Medication compliant", unsafe:"Non-compliant with AED" },
    { key:"sz_driving", safe:"Not driving", unsafe:"Driving concern" },
  ],
  "Stroke/TIA": [
    { key:"str_facial", safe:"No facial droop", unsafe:"Facial droop" },
    { key:"str_arm", safe:"No arm weakness", unsafe:"Arm weakness" },
    { key:"str_speech", safe:"Speech normal", unsafe:"Slurred/absent speech" },
    { key:"str_time", safe:"Symptoms >24h ago", unsafe:"Symptoms within 24h" },
    { key:"str_vision", safe:"No visual loss", unsafe:"Sudden visual loss" },
    { key:"str_resolved", safe:"Symptoms persisting", unsafe:"Symptoms fully resolved (TIA)" },
    { key:"str_headache", safe:"No severe headache", unsafe:"Severe headache" },
    { key:"str_af", safe:"No known AF", unsafe:"Known AF" },
    { key:"str_prev", safe:"No previous stroke/TIA", unsafe:"Previous stroke/TIA" },
    { key:"str_anticoag", safe:"On anticoagulation", unsafe:"Not anticoagulated" },
  ],
  "Weakness/numbness": [
    { key:"wn_onset", safe:"Gradual onset", unsafe:"Sudden onset" },
    { key:"wn_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
    { key:"wn_progressive", safe:"Stable", unsafe:"Progressive" },
    { key:"wn_level", safe:"No sensory level", unsafe:"Sensory level" },
    { key:"wn_bowel", safe:"Normal bowel/bladder", unsafe:"Bowel/bladder dysfunction" },
    { key:"wn_pain", safe:"No pain", unsafe:"Pain" },
    { key:"wn_upper_motor", safe:"No UMN signs", unsafe:"UMN signs" },
    { key:"wn_lower_motor", safe:"No LMN signs", unsafe:"LMN signs" },
  ],
  "Tremor": [
    { key:"tr_rest", safe:"No resting tremor", unsafe:"Resting tremor" },
    { key:"tr_action", safe:"No action tremor", unsafe:"Action tremor" },
    { key:"tr_medication", safe:"No tremorigenic meds", unsafe:"Tremorigenic medications" },
    { key:"tr_alcohol", safe:"No alcohol use", unsafe:"Alcohol use/withdrawal" },
    { key:"tr_thyroid", safe:"No thyroid symptoms", unsafe:"Thyroid symptoms" },
    { key:"tr_family", safe:"No family history", unsafe:"Family history of tremor" },
    { key:"tr_bradykinesia", safe:"No bradykinesia", unsafe:"Bradykinesia" },
    { key:"tr_rigidity", safe:"No rigidity", unsafe:"Rigidity" },
  ],
  "Cognitive decline/dementia": [
    { key:"cog_memory", safe:"Memory stable", unsafe:"Progressive memory loss" },
    { key:"cog_adl", safe:"ADLs preserved", unsafe:"ADLs impaired" },
    { key:"cog_sudden", safe:"Gradual onset", unsafe:"Sudden onset" },
    { key:"cog_fluctuating", safe:"Consistent", unsafe:"Fluctuating cognition" },
    { key:"cog_hallucinations", safe:"No hallucinations", unsafe:"Hallucinations" },
    { key:"cog_behaviour", safe:"Behaviour normal", unsafe:"Behavioural changes" },
    { key:"cog_depression", safe:"No depression", unsafe:"Depression features" },
    { key:"cog_driving", safe:"Driving safe", unsafe:"Driving safety concern" },
    { key:"cog_medications", safe:"No contributing meds", unsafe:"Contributing medications" },
    { key:"cog_vascular", safe:"No vascular risk factors", unsafe:"Vascular risk factors" },
    { key:"cog_family", safe:"No family history", unsafe:"Family history dementia" },
  ],
  "Back pain": [
    { key:"bp_bowel", safe:"Normal bowel/bladder", unsafe:"Bowel/bladder dysfunction" },
    { key:"bp_saddle", safe:"No saddle anaesthesia", unsafe:"Saddle anaesthesia" },
    { key:"bp_prog_neuro", safe:"No progressive neuro", unsafe:"Progressive neurological deficit" },
    { key:"bp_night_pain", safe:"No night pain", unsafe:"Severe night pain" },
    { key:"bp_mechanical", safe:"Mechanical pattern", unsafe:"Non-mechanical pattern" },
    { key:"bp_redflag_hx", safe:"No red flag history", unsafe:"Cancer/trauma/infection history" },
    { key:"bp_radiation", safe:"No leg radiation", unsafe:"Radiation to leg" },
    { key:"bp_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"bp_bilateral", safe:"Unilateral", unsafe:"Bilateral leg symptoms" },
    { key:"bp_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"bp_trauma", safe:"No trauma", unsafe:"Recent trauma" },
  ],
  "Neck pain": [
    { key:"np_myelopathy", safe:"No myelopathy signs", unsafe:"Myelopathy signs" },
    { key:"np_radiculopathy", safe:"No radiculopathy", unsafe:"Radiculopathy" },
    { key:"np_trauma", safe:"No trauma", unsafe:"Recent trauma" },
    { key:"np_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"np_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"np_dysphagia", safe:"No dysphagia", unsafe:"Dysphagia" },
    { key:"np_headache", safe:"No occipital headache", unsafe:"Occipital headache" },
    { key:"np_vascular", safe:"No vascular symptoms", unsafe:"Vascular symptoms" },
    { key:"np_cancer", safe:"No cancer history", unsafe:"Cancer history" },
    { key:"np_mechanical", safe:"Mechanical pattern", unsafe:"Non-mechanical pattern" },
  ],
  "Knee pain": [
    { key:"knee_trauma", safe:"No trauma", unsafe:"Traumatic onset" },
    { key:"knee_swelling", safe:"No swelling", unsafe:"Swelling/effusion" },
    { key:"knee_locking", safe:"No locking", unsafe:"Locking" },
    { key:"knee_giving", safe:"No giving way", unsafe:"Giving way" },
    { key:"knee_night", safe:"No night pain", unsafe:"Night pain" },
    { key:"knee_weightbear", safe:"Full weight bearing", unsafe:"Unable to weight bear" },
    { key:"knee_vascular", safe:"No vascular compromise", unsafe:"Vascular compromise" },
    { key:"knee_fever", safe:"Afebrile", unsafe:"Fever (septic arthritis)" },
  ],
  "Shoulder pain": [
    { key:"sh_trauma", safe:"No trauma", unsafe:"Traumatic onset" },
    { key:"sh_arc", safe:"No painful arc", unsafe:"Painful arc" },
    { key:"sh_night", safe:"No night pain", unsafe:"Night pain" },
    { key:"sh_weakness", safe:"No weakness", unsafe:"Weakness" },
    { key:"sh_rom", safe:"Full range of motion", unsafe:"Reduced range of motion" },
    { key:"sh_radiculopathy", safe:"No radiculopathy", unsafe:"Radiculopathy" },
    { key:"sh_instability", safe:"No instability", unsafe:"Instability/dislocation" },
    { key:"sh_fever", safe:"Afebrile", unsafe:"Fever (septic arthritis)" },
  ],
  "Hip pain": [
    { key:"hip_trauma", safe:"No trauma", unsafe:"Trauma/fall" },
    { key:"hip_weightbear", safe:"Full weight bearing", unsafe:"Unable to weight bear" },
    { key:"hip_rom", safe:"ROM preserved", unsafe:"Reduced ROM" },
    { key:"hip_night", safe:"No night pain", unsafe:"Night pain" },
    { key:"hip_groin", safe:"No groin pain", unsafe:"Groin pain" },
    { key:"hip_fever", safe:"Afebrile", unsafe:"Fever (septic arthritis)" },
    { key:"hip_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
  ],
  "Ankle/foot pain": [
    { key:"af_trauma", safe:"No trauma", unsafe:"Traumatic onset" },
    { key:"af_weightbear", safe:"Full weight bearing", unsafe:"Non-weight bearing" },
    { key:"af_swelling", safe:"No swelling", unsafe:"Swelling" },
    { key:"af_skin", safe:"Skin intact", unsafe:"Skin breakdown/ulcer" },
    { key:"af_vascular", safe:"Pulses present", unsafe:"Vascular compromise" },
    { key:"af_diabetes", safe:"No diabetes", unsafe:"Diabetes" },
    { key:"af_morning", safe:"Not worse in morning", unsafe:"Worse first steps (plantar fasciitis)" },
  ],
  "Hand/wrist pain": [
    { key:"hw_trauma", safe:"No trauma", unsafe:"Traumatic onset" },
    { key:"hw_weakness", safe:"No weakness", unsafe:"Grip weakness" },
    { key:"hw_numbness", safe:"No numbness/tingling", unsafe:"Numbness/tingling" },
    { key:"hw_night", safe:"No night symptoms", unsafe:"Night symptoms" },
    { key:"hw_swelling", safe:"No swelling", unsafe:"Joint swelling" },
    { key:"hw_morning_stiff", safe:"No morning stiffness", unsafe:"Morning stiffness >30 min" },
    { key:"hw_functional", safe:"Function preserved", unsafe:"Functional impairment" },
  ],
  "Joint pain/arthritis": [
    { key:"jt_morning_stiff", safe:"No morning stiffness", unsafe:"Morning stiffness >1 hour" },
    { key:"jt_symmetrical", safe:"Asymmetrical", unsafe:"Symmetrical joint involvement" },
    { key:"jt_swelling", safe:"No joint swelling", unsafe:"Joint swelling" },
    { key:"jt_systemic", safe:"No systemic symptoms", unsafe:"Systemic symptoms" },
    { key:"jt_rash", safe:"No rash", unsafe:"Rash" },
    { key:"jt_eye", safe:"No eye symptoms", unsafe:"Eye symptoms" },
    { key:"jt_bowel", safe:"No bowel symptoms", unsafe:"Bowel symptoms" },
    { key:"jt_warmth", safe:"No warmth/erythema", unsafe:"Warm/erythematous joint" },
    { key:"jt_fever", safe:"Afebrile", unsafe:"Fever" },
  ],
  "Gout": [
    { key:"gout_joint", safe:"Single joint", unsafe:"Polyarticular" },
    { key:"gout_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"gout_uric", safe:"Uric acid controlled", unsafe:"Elevated uric acid" },
    { key:"gout_alcohol", safe:"Low alcohol intake", unsafe:"Excess alcohol" },
    { key:"gout_diet", safe:"Low purine diet", unsafe:"High purine diet" },
    { key:"gout_diuretics", safe:"No diuretics", unsafe:"On diuretics" },
    { key:"gout_compliance", safe:"Allopurinol compliant", unsafe:"Non-compliant" },
    { key:"gout_tophi", safe:"No tophi", unsafe:"Tophi present" },
    { key:"gout_renal", safe:"Normal renal function", unsafe:"Renal impairment" },
  ],
  "Depression": [
    { key:"dep_mood", safe:"Mood euthymic", unsafe:"Persistent low mood" },
    { key:"dep_anhedonia", safe:"No anhedonia", unsafe:"Anhedonia" },
    { key:"dep_sleep", safe:"Sleep normal", unsafe:"Sleep disturbance" },
    { key:"dep_appetite", safe:"Appetite normal", unsafe:"Appetite/weight change" },
    { key:"dep_energy", safe:"Energy normal", unsafe:"Fatigue/low energy" },
    { key:"dep_concentration", safe:"Concentration normal", unsafe:"Poor concentration" },
    { key:"dep_worthless", safe:"No worthlessness/guilt", unsafe:"Worthlessness/guilt" },
    { key:"dep_si", safe:"No suicidal ideation", unsafe:"Suicidal ideation" },
    { key:"dep_function", safe:"Functioning preserved", unsafe:"Functional impairment" },
    { key:"dep_psychosis", safe:"No psychotic features", unsafe:"Psychotic features" },
    { key:"dep_bipolarity", safe:"No hypomanic symptoms", unsafe:"Hypomanic symptoms" },
    { key:"dep_substance", safe:"No substance use", unsafe:"Substance use" },
  ],
  "Anxiety": [
    { key:"anx_worry", safe:"Worry controlled", unsafe:"Excessive uncontrollable worry" },
    { key:"anx_panic", safe:"No panic attacks", unsafe:"Panic attacks" },
    { key:"anx_avoidance", safe:"No avoidance", unsafe:"Avoidance behaviour" },
    { key:"anx_phys", safe:"No physical symptoms", unsafe:"Somatic symptoms" },
    { key:"anx_sleep", safe:"Sleep normal", unsafe:"Sleep disturbance" },
    { key:"anx_function", safe:"Functioning preserved", unsafe:"Functional impairment" },
    { key:"anx_si", safe:"No suicidal ideation", unsafe:"Suicidal ideation" },
    { key:"anx_substance", safe:"No substance use", unsafe:"Substance use" },
    { key:"anx_ocd", safe:"No OCD features", unsafe:"OCD features" },
    { key:"anx_social", safe:"No social anxiety", unsafe:"Social anxiety" },
  ],
  "ADHD assessment": [
    { key:"adhd_inattention", safe:"Attention adequate", unsafe:"Persistent inattention" },
    { key:"adhd_hyperactivity", safe:"No hyperactivity", unsafe:"Hyperactivity/restlessness" },
    { key:"adhd_impulsivity", safe:"No impulsivity", unsafe:"Impulsivity" },
    { key:"adhd_childhood", safe:"No childhood symptoms", unsafe:"Symptoms since childhood" },
    { key:"adhd_pervasive", safe:"Situational only", unsafe:"Pervasive (multiple settings)" },
    { key:"adhd_academic", safe:"No academic/work impact", unsafe:"Academic/occupational impact" },
    { key:"adhd_relationships", safe:"Relationships intact", unsafe:"Relationship difficulties" },
    { key:"adhd_mood", safe:"Mood stable", unsafe:"Mood dysregulation" },
    { key:"adhd_sleep", safe:"Sleep normal", unsafe:"Sleep disturbance" },
    { key:"adhd_substance", safe:"No substance use", unsafe:"Substance use" },
    { key:"adhd_anxiety", safe:"No anxiety", unsafe:"Co-morbid anxiety" },
    { key:"adhd_rating", safe:"Rating scales completed", unsafe:"Rating scales not done" },
  ],
  "Psychosis": [
    { key:"psy_hallucinations", safe:"No hallucinations", unsafe:"Hallucinations" },
    { key:"psy_delusions", safe:"No delusions", unsafe:"Delusions" },
    { key:"psy_disorganised", safe:"Organised thought", unsafe:"Disorganised thought/speech" },
    { key:"psy_insight", safe:"Insight present", unsafe:"Poor insight" },
    { key:"psy_si", safe:"No SI/HI", unsafe:"Suicidal/homicidal ideation" },
    { key:"psy_compliance", safe:"Medication compliant", unsafe:"Non-compliant" },
    { key:"psy_substance", safe:"No substance use", unsafe:"Substance use" },
    { key:"psy_function", safe:"Functioning maintained", unsafe:"Functional decline" },
    { key:"psy_social", safe:"Social supports present", unsafe:"Social isolation" },
    { key:"psy_depot", safe:"Depot up to date", unsafe:"Depot overdue" },
  ],
  "Eating disorder": [
    { key:"ead_restriction", safe:"No dietary restriction", unsafe:"Significant restriction" },
    { key:"ead_purging", safe:"No purging", unsafe:"Purging behaviour" },
    { key:"ead_binge", safe:"No binge eating", unsafe:"Binge eating" },
    { key:"ead_weight", safe:"Weight stable", unsafe:"Significant weight loss" },
    { key:"ead_bmi", safe:"BMI >17.5", unsafe:"BMI <17.5" },
    { key:"ead_cardiac", safe:"No cardiac symptoms", unsafe:"Palpitations/syncope" },
    { key:"ead_electrolytes", safe:"Electrolytes normal", unsafe:"Electrolyte abnormality" },
    { key:"ead_menses", safe:"Menses regular", unsafe:"Amenorrhoea" },
    { key:"ead_insight", safe:"Insight present", unsafe:"Poor insight" },
    { key:"ead_si", safe:"No suicidal ideation", unsafe:"Suicidal ideation" },
  ],
  "Substance use disorder": [
    { key:"sud_type", safe:"Single substance", unsafe:"Polysubstance use" },
    { key:"sud_dependence", safe:"Harmful use only", unsafe:"Dependence features" },
    { key:"sud_withdrawal", safe:"No withdrawal symptoms", unsafe:"Withdrawal symptoms" },
    { key:"sud_function", safe:"Functioning preserved", unsafe:"Functional impairment" },
    { key:"sud_injecting", safe:"Non-injecting", unsafe:"Injecting drug use" },
    { key:"sud_legal", safe:"No legal issues", unsafe:"Legal issues" },
    { key:"sud_motivation", safe:"Motivated to change", unsafe:"Pre-contemplative" },
    { key:"sud_mental_health", safe:"No mental health comorbidity", unsafe:"Mental health comorbidity" },
    { key:"sud_social", safe:"Social supports present", unsafe:"Social isolation" },
  ],
  "PTSD": [
    { key:"ptsd_intrusion", safe:"No intrusive symptoms", unsafe:"Intrusive memories/nightmares" },
    { key:"ptsd_avoidance", safe:"No avoidance", unsafe:"Avoidance" },
    { key:"ptsd_hyperarousal", safe:"No hyperarousal", unsafe:"Hyperarousal/hypervigilance" },
    { key:"ptsd_mood", safe:"Mood normal", unsafe:"Negative mood/cognition" },
    { key:"ptsd_function", safe:"Functioning preserved", unsafe:"Functional impairment" },
    { key:"ptsd_si", safe:"No suicidal ideation", unsafe:"Suicidal ideation" },
    { key:"ptsd_substance", safe:"No substance use", unsafe:"Substance use" },
    { key:"ptsd_safety", safe:"Safe environment", unsafe:"Ongoing safety concerns" },
    { key:"ptsd_sleep", safe:"Sleep adequate", unsafe:"Sleep disturbance" },
  ],
  "Mental health review": [
    { key:"mhr_mood", safe:"Mood stable", unsafe:"Mood disturbance" },
    { key:"mhr_si", safe:"No suicidal ideation", unsafe:"Suicidal ideation" },
    { key:"mhr_compliance", safe:"Medication compliant", unsafe:"Non-compliant" },
    { key:"mhr_sideeffects", safe:"No side effects", unsafe:"Medication side effects" },
    { key:"mhr_function", safe:"Functioning well", unsafe:"Functional decline" },
    { key:"mhr_sleep", safe:"Sleep normal", unsafe:"Sleep disturbance" },
    { key:"mhr_substance", safe:"No substance use", unsafe:"Substance use" },
    { key:"mhr_social", safe:"Social supports adequate", unsafe:"Social isolation" },
    { key:"mhr_insight", safe:"Insight present", unsafe:"Poor insight" },
    { key:"mhr_psychologist", safe:"Seeing psychologist", unsafe:"Not engaged with psychology" },
  ],
  "Insomnia": [
    { key:"ins_sleep_onset", safe:"No sleep onset difficulty", unsafe:"Sleep onset >30 min" },
    { key:"ins_maintenance", safe:"No night waking", unsafe:"Frequent night waking" },
    { key:"ins_early_waking", safe:"No early morning waking", unsafe:"Early morning waking" },
    { key:"ins_daytime", safe:"No daytime impairment", unsafe:"Daytime fatigue/impairment" },
    { key:"ins_duration", safe:"Acute (<3 months)", unsafe:"Chronic (>3 months)" },
    { key:"ins_sleep_hygiene", safe:"Good sleep hygiene", unsafe:"Poor sleep hygiene" },
    { key:"ins_anxiety", safe:"No anxiety/rumination", unsafe:"Anxiety/rumination at night" },
    { key:"ins_osa", safe:"No OSA features", unsafe:"OSA features" },
    { key:"ins_substance", safe:"No caffeine/alcohol", unsafe:"Caffeine/alcohol use" },
  ],
  "Burnout/stress": [
    { key:"bur_exhaustion", safe:"Energy adequate", unsafe:"Emotional exhaustion" },
    { key:"bur_cynicism", safe:"Engaged at work", unsafe:"Cynicism/detachment" },
    { key:"bur_sleep", safe:"Sleep adequate", unsafe:"Sleep disturbance" },
    { key:"bur_physical", safe:"No somatic symptoms", unsafe:"Somatic symptoms" },
    { key:"bur_function", safe:"Functioning at work", unsafe:"Unable to function at work" },
    { key:"bur_si", safe:"No suicidal ideation", unsafe:"Suicidal ideation" },
    { key:"bur_support", safe:"Adequate support", unsafe:"Lack of support" },
    { key:"bur_workload", safe:"Workload manageable", unsafe:"Unsustainable workload" },
  ],
  "Fever": [
    { key:"fev_rigors", safe:"No rigors", unsafe:"Rigors" },
    { key:"fev_source", safe:"Localising symptoms", unsafe:"No localising source" },
    { key:"fev_rash", safe:"No rash", unsafe:"Rash" },
    { key:"fev_neck", safe:"No neck stiffness", unsafe:"Neck stiffness" },
    { key:"fev_photophobia", safe:"No photophobia", unsafe:"Photophobia" },
    { key:"fev_joint", safe:"No joint pain", unsafe:"Joint pain" },
    { key:"fev_lymph", safe:"No lymphadenopathy", unsafe:"Lymphadenopathy" },
    { key:"fev_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
    { key:"fev_travel", safe:"No recent travel", unsafe:"Recent travel" },
    { key:"fev_sepsis", safe:"No sepsis features", unsafe:"Sepsis features" },
    { key:"fev_duration", safe:"<5 days", unsafe:">5 days" },
  ],
  "Fever in returned traveller": [
    { key:"frt_malaria", safe:"Low malaria risk area", unsafe:"Malaria endemic area" },
    { key:"frt_prophylaxis", safe:"Prophylaxis taken", unsafe:"No/incomplete prophylaxis" },
    { key:"frt_duration", safe:"Fever <5 days", unsafe:"Fever >5 days" },
    { key:"frt_rigors", safe:"No rigors", unsafe:"Rigors/cyclical fever" },
    { key:"frt_rash", safe:"No rash", unsafe:"Rash" },
    { key:"frt_jaundice", safe:"No jaundice", unsafe:"Jaundice" },
    { key:"frt_diarrhea", safe:"No diarrhea", unsafe:"Diarrhea" },
    { key:"frt_headache", safe:"No headache", unsafe:"Headache" },
    { key:"frt_meningism", safe:"No meningism", unsafe:"Meningism" },
    { key:"frt_eschar", safe:"No eschar", unsafe:"Eschar present (rickettsial)" },
    { key:"frt_insect", safe:"No insect/animal bite", unsafe:"Insect/animal bite" },
    { key:"frt_freshwater", safe:"No freshwater exposure", unsafe:"Freshwater exposure (leptospirosis)" },
    { key:"frt_sexual", safe:"No unprotected sex overseas", unsafe:"Unprotected sex overseas" },
    { key:"frt_timing", safe:"Post 3 months travel", unsafe:"Within 3 months of return" },
  ],
  "Urinary tract infection": [
    { key:"uti_dysuria", safe:"No dysuria", unsafe:"Dysuria" },
    { key:"uti_frequency", safe:"Normal frequency", unsafe:"Urinary frequency" },
    { key:"uti_fever", safe:"Afebrile", unsafe:"Fever/rigors" },
    { key:"uti_loin", safe:"No loin pain", unsafe:"Loin pain/tenderness" },
    { key:"uti_haematuria", safe:"No haematuria", unsafe:"Haematuria" },
    { key:"uti_discharge", safe:"No discharge", unsafe:"Discharge" },
    { key:"uti_recurrent", safe:"First episode", unsafe:"Recurrent UTI (>3/year)" },
    { key:"uti_catheter", safe:"No catheter", unsafe:"Indwelling catheter" },
    { key:"uti_pregnant", safe:"Not pregnant", unsafe:"Pregnant" },
    { key:"uti_diabetes", safe:"No diabetes", unsafe:"Diabetes" },
  ],
  "Skin infection/cellulitis": [
    { key:"skin_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"skin_spreading", safe:"Not spreading", unsafe:"Rapidly spreading" },
    { key:"skin_fluctuance", safe:"No fluctuance", unsafe:"Fluctuance (abscess)" },
    { key:"skin_lymph", safe:"No lymphangitis", unsafe:"Lymphangitis" },
    { key:"skin_crepitus", safe:"No crepitus", unsafe:"Crepitus (necrotising fasciitis)" },
    { key:"skin_entry", safe:"No entry point", unsafe:"Entry point identified" },
    { key:"skin_diabetes", safe:"No diabetes", unsafe:"Diabetes" },
    { key:"skin_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
    { key:"skin_previous", safe:"No previous episodes", unsafe:"Recurrent episodes" },
  ],
  "Pneumonia": [
    { key:"pneu_dyspnea", safe:"No dyspnea", unsafe:"Dyspnea" },
    { key:"pneu_pleuritic", safe:"No pleuritic pain", unsafe:"Pleuritic pain" },
    { key:"pneu_confusion", safe:"No confusion", unsafe:"Confusion" },
    { key:"pneu_hypoxia", safe:"SpO2 normal", unsafe:"Hypoxia" },
    { key:"pneu_productive", safe:"Dry cough", unsafe:"Productive cough" },
    { key:"pneu_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
    { key:"pneu_aspiration", safe:"No aspiration risk", unsafe:"Aspiration risk" },
    { key:"pneu_prev", safe:"No previous pneumonia", unsafe:"Previous pneumonia" },
  ],
  "STI screen": [
    { key:"sti_discharge", safe:"No discharge", unsafe:"Discharge" },
    { key:"sti_dysuria", safe:"No dysuria", unsafe:"Dysuria" },
    { key:"sti_sores", safe:"No genital sores/ulcers", unsafe:"Genital sores/ulcers" },
    { key:"sti_rash", safe:"No rash", unsafe:"Rash" },
    { key:"sti_partners", safe:"Single partner", unsafe:"Multiple partners" },
    { key:"sti_condom", safe:"Consistent condom use", unsafe:"Inconsistent condom use" },
    { key:"sti_prev_sti", safe:"No previous STI", unsafe:"Previous STI" },
    { key:"sti_hiv_risk", safe:"Low HIV risk", unsafe:"High HIV risk (MSM/sex work)" },
    { key:"sti_prep", safe:"On PrEP if indicated", unsafe:"Not on PrEP (high risk)" },
    { key:"sti_lymphadenopathy", safe:"No lymphadenopathy", unsafe:"Inguinal lymphadenopathy" },
  ],
  "HIV review": [
    { key:"hiv_vl", safe:"Viral load undetectable", unsafe:"Detectable viral load" },
    { key:"hiv_cd4", safe:"CD4 >350", unsafe:"CD4 <350" },
    { key:"hiv_compliance", safe:"ART compliant", unsafe:"Non-compliant with ART" },
    { key:"hiv_side_effects", safe:"No side effects", unsafe:"ART side effects" },
    { key:"hiv_oi", safe:"No opportunistic infections", unsafe:"Opportunistic infection" },
    { key:"hiv_sexual", safe:"Safe sex practices", unsafe:"Unsafe sex practices" },
    { key:"hiv_mental_health", safe:"Mental health stable", unsafe:"Mental health concerns" },
    { key:"hiv_screening", safe:"Screening up to date", unsafe:"Screening overdue" },
    { key:"hiv_hepatitis", safe:"No Hep B/C co-infection", unsafe:"Hep B/C co-infection" },
  ],
  "Tuberculosis": [
    { key:"tb_cough", safe:"No cough", unsafe:"Cough >3 weeks" },
    { key:"tb_haemoptysis", safe:"No haemoptysis", unsafe:"Haemoptysis" },
    { key:"tb_nightsweats", safe:"No night sweats", unsafe:"Night sweats" },
    { key:"tb_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"tb_fever", safe:"Afebrile", unsafe:"Low-grade fever" },
    { key:"tb_contact", safe:"No TB contact", unsafe:"Known TB contact" },
    { key:"tb_endemic", safe:"Low prevalence area", unsafe:"TB endemic country" },
    { key:"tb_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised/HIV" },
    { key:"tb_prev", safe:"No previous TB", unsafe:"Previous TB" },
    { key:"tb_compliance", safe:"Treatment compliant", unsafe:"Non-compliant" },
  ],
  "COVID-19": [
    { key:"covid_dyspnea", safe:"No dyspnea", unsafe:"Dyspnea" },
    { key:"covid_hypoxia", safe:"SpO2 normal", unsafe:"Hypoxia" },
    { key:"covid_anosmia", safe:"Smell/taste normal", unsafe:"Anosmia/ageusia" },
    { key:"covid_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"covid_highrisk", safe:"No high-risk features", unsafe:"High risk (elderly/immunocomp)" },
    { key:"covid_antiviral", safe:"Not eligible for antivirals", unsafe:"Eligible for antivirals" },
    { key:"covid_longcovid", safe:"No long COVID symptoms", unsafe:"Long COVID symptoms" },
    { key:"covid_vaccinated", safe:"Vaccinated", unsafe:"Unvaccinated" },
  ],
  "Sepsis": [
    { key:"sep_source", safe:"Source identified", unsafe:"No clear source" },
    { key:"sep_hypotension", safe:"BP normal", unsafe:"Hypotension" },
    { key:"sep_tachycardia", safe:"HR normal", unsafe:"Tachycardia" },
    { key:"sep_tachypnea", safe:"RR normal", unsafe:"Tachypnea" },
    { key:"sep_confusion", safe:"No confusion", unsafe:"Altered mental status" },
    { key:"sep_oliguria", safe:"Urine output normal", unsafe:"Oliguria" },
    { key:"sep_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
    { key:"sep_lactate", safe:"Lactate normal", unsafe:"Elevated lactate" },
  ],
  "Anaphylaxis": [
    { key:"ana_airway", safe:"Airway patent", unsafe:"Airway compromise" },
    { key:"ana_breathing", safe:"Breathing adequate", unsafe:"Respiratory distress" },
    { key:"ana_bp", safe:"BP maintained", unsafe:"Hypotension/shock" },
    { key:"ana_skin", safe:"No urticaria/angioedema", unsafe:"Urticaria/angioedema" },
    { key:"ana_trigger", safe:"No trigger identified", unsafe:"Trigger identified" },
    { key:"ana_prior", safe:"No prior anaphylaxis", unsafe:"Prior anaphylaxis" },
    { key:"ana_adrenaline", safe:"Adrenaline not required", unsafe:"Adrenaline given" },
    { key:"ana_epipen", safe:"No epipen prescribed", unsafe:"Epipen prescribed" },
    { key:"ana_biphasic", safe:"No biphasic reaction", unsafe:"Biphasic reaction" },
    { key:"ana_obs", safe:"Obs stable post-treatment", unsafe:"Obs unstable post-treatment" },
  ],
  "Overdose/Toxidrome": [
    { key:"tox_conscious", safe:"GCS 15", unsafe:"Reduced GCS" },
    { key:"tox_airway", safe:"Airway protected", unsafe:"Airway at risk" },
    { key:"tox_breathing", safe:"Breathing adequate", unsafe:"Respiratory depression" },
    { key:"tox_pupils", safe:"Pupils normal", unsafe:"Miosis/mydriasis" },
    { key:"tox_agent", safe:"Agent unknown", unsafe:"Agent identified" },
    { key:"tox_intentional", safe:"Accidental", unsafe:"Intentional ingestion" },
    { key:"tox_time", safe:"Time of ingestion unknown", unsafe:"Time of ingestion known" },
    { key:"tox_coingestant", safe:"No co-ingestants", unsafe:"Co-ingestants present" },
    { key:"tox_naloxone", safe:"Naloxone not required", unsafe:"Naloxone given/required" },
    { key:"tox_ecg", safe:"ECG normal", unsafe:"ECG abnormal (QTc/QRS)" },
    { key:"tox_seizure", safe:"No seizures", unsafe:"Seizures" },
    { key:"tox_psych", safe:"No psychiatric history", unsafe:"Psychiatric history" },
  ],
  "Suicidal crisis": [
    { key:"sc_ideation", safe:"No suicidal ideation", unsafe:"Suicidal ideation present" },
    { key:"sc_plan", safe:"No plan", unsafe:"Plan formulated" },
    { key:"sc_means", safe:"No access to means", unsafe:"Access to means" },
    { key:"sc_intent", safe:"No intent to act", unsafe:"Intent to act" },
    { key:"sc_attempt", safe:"No current attempt", unsafe:"Current/recent attempt" },
    { key:"sc_selfharm", safe:"No self-harm", unsafe:"Active self-harm" },
    { key:"sc_protective", safe:"Protective factors present", unsafe:"No protective factors" },
    { key:"sc_supports", safe:"Social supports present", unsafe:"Socially isolated" },
    { key:"sc_substances", safe:"No substance use", unsafe:"Substance use" },
    { key:"sc_psych", safe:"No prior psychiatric history", unsafe:"Prior psychiatric history" },
    { key:"sc_storage", safe:"Means safety plan in place", unsafe:"No safe storage plan" },
    { key:"sc_insight", safe:"Insight present", unsafe:"Poor insight/refuses help" },
  ],
  "Elderly fall": [
    //  Mechanism & Head Strike 
    { key:"ef_witnessed",   safe:"Witnessed fall",               unsafe:"Unwitnessed fall",           isRF:true },
    { key:"ef_headstrike",  safe:"No head strike",               unsafe:"Head strike confirmed",       isRF:true },
    { key:"ef_loc",         safe:"No loss of consciousness",     unsafe:"Loss of consciousness",       isRF:true },
    { key:"ef_amnesia",     safe:"No amnesia for event",         unsafe:"Amnesia for event",           isRF:true },
    { key:"ef_vomiting",    safe:"No post-fall vomiting",        unsafe:"Post-fall vomiting",          isRF:true },
    { key:"ef_seizure",     safe:"No seizure activity",          unsafe:"Seizure activity",            isRF:true },
    //  Precipitating Cause 
    { key:"ef_cause_mech",  safe:"Mechanical trip/slip",         unsafe:"No clear mechanical cause" },
    { key:"ef_presyncope",  safe:"No presyncope/dizziness",      unsafe:"Presyncope/dizziness prior" },
    { key:"ef_cardiac",     safe:"No cardiac symptoms prior",    unsafe:"Chest pain/palpitations prior" },
    { key:"ef_neuro",       safe:"No focal neuro symptoms",      unsafe:"Focal neuro symptoms prior",  isRF:true },
    { key:"ef_postural",    safe:"No postural symptoms",         unsafe:"Postural dizziness on standing" },
    { key:"ef_medications", safe:"No contributing medications",  unsafe:"Likely contributing medications" },
    //  Injury Assessment 
    { key:"ef_neck_pain",   safe:"No neck pain/tenderness",      unsafe:"Neck pain/tenderness",        isRF:true },
    { key:"ef_hip_pain",    safe:"No hip pain",                  unsafe:"Hip pain/unable to WB",       isRF:true },
    { key:"ef_laceration",  safe:"No scalp laceration",          unsafe:"Scalp laceration" },
    { key:"ef_other_injury",safe:"No other injuries",            unsafe:"Other injuries identified" },
    //  Anticoagulation 
    { key:"ef_anticoag",    safe:"Not anticoagulated",           unsafe:"On anticoagulation",          isRF:true },
    { key:"ef_antiplatelet",safe:"No antiplatelet therapy",      unsafe:"On antiplatelet therapy" },
    //  Neurological Status 
    { key:"ef_gcs_full",    safe:"GCS 15/15",                    unsafe:"GCS <15",                    isRF:true },
    { key:"ef_neuro_intact",safe:"Neuro exam intact",            unsafe:"Focal neuro deficit",         isRF:true },
    { key:"ef_confusion",   safe:"Baseline cognition",           unsafe:"Acute confusion/delirium",    isRF:true },
    //  Frailty & Context 
    { key:"ef_frailty",     safe:"Not frail (CFS 1-3)",          unsafe:"Frail (CFS 4+)" },
    { key:"ef_recurrent",   safe:"First fall",                   unsafe:"Recurrent falls (2+ in 12mo)" },
    { key:"ef_alone",       safe:"Not found on floor",           unsafe:"Found on floor  long lie",   isRF:true },
    { key:"ef_osteoporosis",safe:"No known osteoporosis",        unsafe:"Known osteoporosis/prev fracture" },
    { key:"ef_anticoag_reversal", safe:"Reversal not indicated", unsafe:"Anticoagulation reversal considered", isRF:true },
    //  Disposition Factors 
    { key:"ef_safe_home",   safe:"Safe to return home",          unsafe:"Unsafe home environment" },
    { key:"ef_carer",       safe:"Adequate carer support",       unsafe:"Lives alone/inadequate support" },
    { key:"ef_otp_referral",safe:"Falls OT/physio referral done",unsafe:"Falls OT/physio referral pending" },
  ],
  "Diabetes review": [
    { key:"dm_hypo", safe:"No hypoglycemia", unsafe:"Hypoglycemic episodes" },
    { key:"dm_hba1c", safe:"HbA1c at target", unsafe:"HbA1c above target" },
    { key:"dm_compliance", safe:"Medication compliant", unsafe:"Non-compliant" },
    { key:"dm_monitoring", safe:"Regular BGLs monitored", unsafe:"Not monitoring BGLs" },
    { key:"dm_eye", safe:"Eye review up to date", unsafe:"Eye review overdue" },
    { key:"dm_foot", safe:"Foot exam normal", unsafe:"Foot exam abnormal" },
    { key:"dm_renal", safe:"Renal function stable", unsafe:"Renal decline" },
    { key:"dm_bp", safe:"BP at target", unsafe:"BP above target" },
    { key:"dm_lipids", safe:"Lipids at target", unsafe:"Lipids above target" },
    { key:"dm_symptoms", safe:"No hyperglycemic symptoms", unsafe:"Hyperglycemic symptoms" },
    { key:"dm_lifestyle", safe:"Lifestyle goals met", unsafe:"Lifestyle goals not met" },
    { key:"dm_sick_day", safe:"Sick day plan in place", unsafe:"No sick day plan" },
  ],
  "Thyroid disease": [
    { key:"thy_hyper", safe:"No hyperthyroid symptoms", unsafe:"Hyperthyroid symptoms" },
    { key:"thy_hypo", safe:"No hypothyroid symptoms", unsafe:"Hypothyroid symptoms" },
    { key:"thy_palpitations", safe:"No palpitations", unsafe:"Palpitations" },
    { key:"thy_weightchange", safe:"Weight stable", unsafe:"Weight change" },
    { key:"thy_compliance", safe:"Medication compliant", unsafe:"Non-compliant" },
    { key:"thy_pregnancy", safe:"Not pregnant/planning", unsafe:"Pregnant or planning pregnancy" },
    { key:"thy_goitre", safe:"No goitre", unsafe:"Goitre" },
    { key:"thy_eye", safe:"No eye signs", unsafe:"Eye signs (Graves)" },
    { key:"thy_bone", safe:"No bone concerns", unsafe:"Osteoporosis risk" },
  ],
  "Obesity review": [
    { key:"ob_comorbidities", safe:"No obesity comorbidities", unsafe:"Obesity comorbidities" },
    { key:"ob_osa", safe:"No OSA", unsafe:"OSA" },
    { key:"ob_t2dm", safe:"No type 2 diabetes", unsafe:"Type 2 diabetes" },
    { key:"ob_htn", safe:"No hypertension", unsafe:"Hypertension" },
    { key:"ob_joint", safe:"No joint pain", unsafe:"Joint pain" },
    { key:"ob_diet", safe:"Diet reviewed", unsafe:"Diet not reviewed" },
    { key:"ob_exercise", safe:"Regular exercise", unsafe:"Sedentary" },
    { key:"ob_motivation", safe:"Motivated to change", unsafe:"Low motivation" },
    { key:"ob_mental_health", safe:"Mental health stable", unsafe:"Mental health concerns" },
  ],
  "Metabolic syndrome": [
    { key:"ms_waist", safe:"Waist circumference normal", unsafe:"Central obesity" },
    { key:"ms_bp", safe:"BP controlled", unsafe:"BP elevated" },
    { key:"ms_glucose", safe:"Fasting glucose normal", unsafe:"Fasting glucose elevated" },
    { key:"ms_hdl", safe:"HDL normal", unsafe:"HDL low" },
    { key:"ms_triglycerides", safe:"Triglycerides normal", unsafe:"Triglycerides elevated" },
    { key:"ms_lifestyle", safe:"Lifestyle goals met", unsafe:"Lifestyle goals not met" },
    { key:"ms_nafld", safe:"No NAFLD features", unsafe:"NAFLD features" },
  ],
  "Hyperlipidemia review": [
    { key:"hl_compliance", safe:"Statin compliant", unsafe:"Non-compliant" },
    { key:"hl_myopathy", safe:"No myopathy symptoms", unsafe:"Myopathy/myalgia" },
    { key:"hl_liver", safe:"No liver symptoms", unsafe:"Liver symptoms" },
    { key:"hl_diet", safe:"Low fat diet", unsafe:"High fat diet" },
    { key:"hl_exercise", safe:"Regular exercise", unsafe:"Sedentary" },
    { key:"hl_target", safe:"LDL at target", unsafe:"LDL above target" },
    { key:"hl_cardiovascular", safe:"No new CV events", unsafe:"New CV event" },
  ],
  "Erectile dysfunction": [
    { key:"ed_onset", safe:"Gradual onset", unsafe:"Sudden onset" },
    { key:"ed_morning", safe:"Morning erections present", unsafe:"No morning erections" },
    { key:"ed_libido", safe:"Libido normal", unsafe:"Reduced libido" },
    { key:"ed_cardiovascular", safe:"No cardiovascular symptoms", unsafe:"Cardiovascular symptoms" },
    { key:"ed_depression", safe:"No depression", unsafe:"Depression/anxiety" },
    { key:"ed_medication", safe:"No contributing medications", unsafe:"Contributing medications" },
    { key:"ed_smoking", safe:"Non-smoker", unsafe:"Smoker" },
    { key:"ed_alcohol", safe:"Low alcohol", unsafe:"Excess alcohol" },
    { key:"ed_diabetes", safe:"No diabetes", unsafe:"Diabetes" },
    { key:"ed_testosterone", safe:"No testosterone deficiency features", unsafe:"Testosterone deficiency features" },
  ],
  "LUTS/prostate": [
    { key:"luts_storage", safe:"No storage symptoms", unsafe:"Storage symptoms (frequency/urgency/nocturia)" },
    { key:"luts_voiding", safe:"No voiding symptoms", unsafe:"Voiding symptoms (hesitancy/poor stream)" },
    { key:"luts_haematuria", safe:"No haematuria", unsafe:"Haematuria" },
    { key:"luts_pain", safe:"No pelvic/perineal pain", unsafe:"Pelvic/perineal pain" },
    { key:"luts_retention", safe:"No retention", unsafe:"Acute/chronic retention" },
    { key:"luts_uti", safe:"No UTI symptoms", unsafe:"UTI symptoms" },
    { key:"luts_back", safe:"No bone/back pain", unsafe:"Bone pain/back pain" },
    { key:"luts_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"luts_psa", safe:"PSA not elevated", unsafe:"Elevated PSA" },
    { key:"luts_ipss", safe:"IPSS mild (0-7)", unsafe:"IPSS moderate-severe (>8)" },
  ],
  "Testicular pain": [
    { key:"test_sudden", safe:"Gradual onset", unsafe:"Sudden onset pain" },
    { key:"test_torsion", safe:"No torsion features", unsafe:"Torsion features (high-riding/transverse)" },
    { key:"test_swelling", safe:"No swelling", unsafe:"Swelling" },
    { key:"test_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"test_discharge", safe:"No urethral discharge", unsafe:"Urethral discharge" },
    { key:"test_trauma", safe:"No trauma", unsafe:"Recent trauma" },
    { key:"test_age", safe:"Age >30", unsafe:"Age 12-30 (torsion risk)" },
    { key:"test_nausea", safe:"No nausea/vomiting", unsafe:"Nausea/vomiting" },
  ],
  "Scrotal swelling": [
    { key:"scrot_transillum", safe:"Non-transilluminable", unsafe:"Transilluminable (hydrocele)" },
    { key:"scrot_separate", safe:"Can get above swelling", unsafe:"Cannot get above swelling" },
    { key:"scrot_tender", safe:"Non-tender", unsafe:"Tender" },
    { key:"scrot_cough", safe:"No cough impulse", unsafe:"Cough impulse (hernia)" },
    { key:"scrot_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"scrot_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
    { key:"scrot_duration", safe:"Acute", unsafe:"Longstanding" },
  ],
  "PSA discussion": [
    { key:"psa_symptoms", safe:"No LUTS", unsafe:"LUTS present" },
    { key:"psa_fhx", safe:"No family history PCa", unsafe:"Family history of PCa" },
    { key:"psa_bone_pain", safe:"No bone pain", unsafe:"Bone pain" },
    { key:"psa_previous", safe:"No previous biopsy", unsafe:"Previous biopsy" },
    { key:"psa_rising", safe:"PSA stable", unsafe:"Rising PSA" },
    { key:"psa_informed", safe:"Informed consent given", unsafe:"Informed consent not given" },
  ],
  "Testosterone deficiency": [
    { key:"testo_libido", safe:"Libido normal", unsafe:"Low libido" },
    { key:"testo_ed", safe:"No erectile dysfunction", unsafe:"Erectile dysfunction" },
    { key:"testo_fatigue", safe:"Energy normal", unsafe:"Fatigue/low energy" },
    { key:"testo_mood", safe:"Mood normal", unsafe:"Low mood/irritability" },
    { key:"testo_muscle", safe:"Muscle mass normal", unsafe:"Reduced muscle mass" },
    { key:"testo_sleep", safe:"Sleep normal", unsafe:"Sleep disturbance" },
    { key:"testo_prostate", safe:"No prostate concerns", unsafe:"Prostate concerns" },
    { key:"testo_haematocrit", safe:"Haematocrit normal", unsafe:"Elevated haematocrit" },
  ],
  "1st trimester bleeding": [
    { key:"ftb_volume", safe:"Light spotting", unsafe:"Heavy bleeding/clots" },
    { key:"ftb_pain", safe:"No pain", unsafe:"Pelvic/abdominal pain" },
    { key:"ftb_shoulder_tip", safe:"No shoulder tip pain", unsafe:"Shoulder tip pain (ectopic)" },
    { key:"ftb_syncope", safe:"No syncope", unsafe:"Syncope/presyncope" },
    { key:"ftb_viability", safe:"Viable pregnancy on USS", unsafe:"Viability not confirmed" },
    { key:"ftb_ectopic_risk", safe:"Low ectopic risk", unsafe:"Ectopic risk factors (IVF/PID/prev ectopic)" },
    { key:"ftb_rhesus", safe:"Rhesus positive", unsafe:"Rhesus negative" },
    { key:"ftb_cervix", safe:"Cervix closed", unsafe:"Cervix open (inevitable miscarriage)" },
    { key:"ftb_hcg", safe:"hCG rising appropriately", unsafe:"hCG not rising/falling" },
  ],
  "Pelvic pain": [
    { key:"pp_acute", safe:"Gradual onset", unsafe:"Acute severe onset" },
    { key:"pp_lmp", safe:"LMP normal", unsafe:"Missed/abnormal LMP" },
    { key:"pp_discharge", safe:"No discharge", unsafe:"Discharge" },
    { key:"pp_dyspareunia", safe:"No dyspareunia", unsafe:"Dyspareunia" },
    { key:"pp_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"pp_peritonism", safe:"No peritonism", unsafe:"Peritonism" },
    { key:"pp_shoulder", safe:"No shoulder tip pain", unsafe:"Shoulder tip pain (ectopic)" },
    { key:"pp_cyclical", safe:"Non-cyclical", unsafe:"Cyclical pain (endometriosis)" },
    { key:"pp_bowel", safe:"Normal bowel symptoms", unsafe:"Bowel symptoms (endometriosis)" },
    { key:"pp_sti_risk", safe:"Low STI risk", unsafe:"STI risk (PID)" },
  ],
  "Vaginal discharge": [
    { key:"vd_colour", safe:"Normal colour/consistency", unsafe:"Abnormal colour/consistency" },
    { key:"vd_odour", safe:"No offensive odour", unsafe:"Offensive odour (BV)" },
    { key:"vd_itch", safe:"No vulval itch", unsafe:"Vulval itch (candida)" },
    { key:"vd_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"vd_pelvic", safe:"No pelvic pain", unsafe:"Pelvic pain (PID)" },
    { key:"vd_partner", safe:"Single partner", unsafe:"Multiple partners/STI risk" },
    { key:"vd_post_coital", safe:"No post-coital bleeding", unsafe:"Post-coital bleeding" },
    { key:"vd_recurrent", safe:"First episode", unsafe:"Recurrent episodes" },
  ],
  "Abnormal uterine bleeding": [
    { key:"aub_volume", safe:"Normal volume", unsafe:"Heavy bleeding" },
    { key:"aub_frequency", safe:"Regular cycle", unsafe:"Irregular cycle" },
    { key:"aub_intermenstrual", safe:"No intermenstrual bleeding", unsafe:"Intermenstrual bleeding" },
    { key:"aub_postcoital", safe:"No post-coital bleeding", unsafe:"Post-coital bleeding" },
    { key:"aub_postmenopausal", safe:"Pre-menopausal", unsafe:"Post-menopausal bleeding" },
    { key:"aub_pregnant", safe:"Not pregnant", unsafe:"Possibly pregnant" },
    { key:"aub_structural", safe:"No pelvic mass/pain", unsafe:"Pelvic mass/pain" },
    { key:"aub_anaemia", safe:"No anaemia symptoms", unsafe:"Anaemia symptoms" },
    { key:"aub_endometrial", safe:"No endometrial cancer risk", unsafe:"Endometrial cancer risk factors" },
  ],
  "Menopause": [
    { key:"men_hot_flushes", safe:"No hot flushes", unsafe:"Hot flushes/night sweats" },
    { key:"men_mood", safe:"Mood stable", unsafe:"Mood disturbance" },
    { key:"men_sleep", safe:"Sleep normal", unsafe:"Sleep disturbance" },
    { key:"men_vaginal", safe:"No vaginal symptoms", unsafe:"Vaginal dryness/dyspareunia" },
    { key:"men_cognitive", safe:"Cognition normal", unsafe:"Cognitive symptoms" },
    { key:"men_cardiovascular", safe:"Low cardiovascular risk", unsafe:"Cardiovascular risk factors" },
    { key:"men_bone", safe:"No osteoporosis risk", unsafe:"Osteoporosis risk" },
    { key:"men_hrt", safe:"No HRT contraindications", unsafe:"HRT contraindications" },
    { key:"men_bleeding", safe:"No post-menopausal bleeding", unsafe:"Post-menopausal bleeding" },
    { key:"men_libido", safe:"Libido normal", unsafe:"Reduced libido" },
  ],
  "Breast lump": [
    { key:"bl_skin_changes", safe:"No skin changes", unsafe:"Skin changes (peau d'orange/tethering)" },
    { key:"bl_nipple", safe:"No nipple changes", unsafe:"Nipple discharge/inversion" },
    { key:"bl_lymph", safe:"No axillary nodes", unsafe:"Axillary lymphadenopathy" },
    { key:"bl_fhx", safe:"No family history", unsafe:"Family history of breast cancer" },
    { key:"bl_pain", safe:"Painless lump", unsafe:"Painful lump" },
    { key:"bl_mobile", safe:"Mobile lump", unsafe:"Fixed/irregular lump" },
    { key:"bl_previous", safe:"No previous breast cancer", unsafe:"Previous breast cancer" },
    { key:"bl_age", safe:"Age <30", unsafe:"Age >30" },
  ],
  "Cervical screening": [
    { key:"cs_previous", safe:"Previous result normal", unsafe:"Previous abnormal result" },
    { key:"cs_hpv", safe:"HPV negative", unsafe:"HPV positive" },
    { key:"cs_symptoms", safe:"No cervical symptoms", unsafe:"Intermenstrual/post-coital bleeding" },
    { key:"cs_vaccinated", safe:"HPV vaccinated", unsafe:"Not HPV vaccinated" },
    { key:"cs_interval", safe:"Screening up to date", unsafe:"Screening overdue" },
    { key:"cs_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
  ],
  "Contraception review": [
    { key:"contr_effective", safe:"Effective contraception used", unsafe:"Inconsistent use" },
    { key:"contr_side_effects", safe:"No side effects", unsafe:"Side effects" },
    { key:"contr_bp", safe:"BP normal", unsafe:"BP elevated" },
    { key:"contr_migraines", safe:"No migraines with aura", unsafe:"Migraines with aura (COCP risk)" },
    { key:"contr_smoking", safe:"Non-smoker", unsafe:"Smoker >35 (COCP risk)" },
    { key:"contr_planning", safe:"Not planning pregnancy", unsafe:"Planning pregnancy <12 months" },
    { key:"contr_sti", safe:"Low STI risk", unsafe:"STI risk" },
  ],
  "Antenatal review": [
    { key:"ant_fetal_mov", safe:"Fetal movements normal", unsafe:"Reduced fetal movements" },
    { key:"ant_pv_bleed", safe:"No PV bleeding", unsafe:"PV bleeding" },
    { key:"ant_bp", safe:"BP normal", unsafe:"Hypertension" },
    { key:"ant_protein", safe:"No proteinuria", unsafe:"Proteinuria" },
    { key:"ant_headache", safe:"No headache/visual disturbance", unsafe:"Headache/visual disturbance (PET)" },
    { key:"ant_epigastric", safe:"No epigastric pain", unsafe:"Epigastric pain" },
    { key:"ant_growth", safe:"Fetal growth normal", unsafe:"Growth concern" },
    { key:"ant_presentation", safe:"Cephalic presentation", unsafe:"Non-cephalic presentation" },
    { key:"ant_mental_health", safe:"Mental health stable", unsafe:"Mental health concerns" },
  ],
  "Postnatal review": [
    { key:"pn_mood", safe:"Mood normal", unsafe:"Low mood/tearfulness" },
    { key:"pn_pnd", safe:"No PND features", unsafe:"PND features" },
    { key:"pn_bonding", safe:"Bonding normal", unsafe:"Bonding concerns" },
    { key:"pn_feeding", safe:"Feeding well", unsafe:"Feeding difficulties" },
    { key:"pn_lochia", safe:"Lochia normal", unsafe:"Abnormal lochia" },
    { key:"pn_wound", safe:"Wound healing well", unsafe:"Wound infection/dehiscence" },
    { key:"pn_contraception", safe:"Contraception discussed", unsafe:"Contraception not discussed" },
    { key:"pn_support", safe:"Adequate support", unsafe:"Inadequate support" },
  ],
  "Febrile child": [
    { key:"fc_age", safe:"Age >3 months", unsafe:"Age <3 months (T38C high risk)" },
    { key:"fc_source", safe:"Source identified", unsafe:"No focus identified" },
    { key:"fc_rash", safe:"No non-blanching rash", unsafe:"Non-blanching rash" },
    { key:"fc_neck", safe:"No neck stiffness", unsafe:"Neck stiffness" },
    { key:"fc_photophobia", safe:"No photophobia", unsafe:"Photophobia" },
    { key:"fc_alert", safe:"Alert and interactive", unsafe:"Lethargic/irritable" },
    { key:"fc_appearance", safe:"Looks well", unsafe:"Toxic/unwell appearance" },
    { key:"fc_hydration", safe:"Well hydrated", unsafe:"Dehydrated" },
    { key:"fc_perfusion", safe:"Good perfusion", unsafe:"Mottled/ashen/cyanotic" },
    { key:"fc_breathing", safe:"Breathing normal", unsafe:"Increased WOB/grunting" },
    { key:"fc_fontanelle", safe:"Fontanelle normal", unsafe:"Bulging fontanelle" },
    { key:"fc_seizure", safe:"No seizure", unsafe:"Seizure/status epilepticus" },
    { key:"fc_limb", safe:"Weight bearing/using limb", unsafe:"Non-weight bearing/limb not used" },
    { key:"fc_immunised", safe:"Fully immunised", unsafe:"Unimmunised/incomplete" },
    { key:"fc_duration", safe:"Fever <5 days", unsafe:"Fever >5 days (Kawasaki risk)" },
  ],
  "4 year old developmental review": [
    { key:"dev4_speech", safe:"Speech intelligible to strangers", unsafe:"Speech not intelligible to strangers" },
    { key:"dev4_sentences", safe:"Using 4-5 word sentences", unsafe:"Not using sentences" },
    { key:"dev4_hearing", safe:"Hearing normal", unsafe:"Hearing concerns" },
    { key:"dev4_vision", safe:"Vision normal", unsafe:"Vision concerns" },
    { key:"dev4_gross_motor", safe:"Running/climbing/hopping", unsafe:"Gross motor delay" },
    { key:"dev4_fine_motor", safe:"Drawing/using scissors", unsafe:"Fine motor delay" },
    { key:"dev4_toilet", safe:"Toilet trained", unsafe:"Not toilet trained" },
    { key:"dev4_social", safe:"Plays with other children", unsafe:"Social concerns" },
    { key:"dev4_imaginary", safe:"Imaginative play present", unsafe:"No imaginative play" },
    { key:"dev4_behaviour", safe:"Behaviour manageable", unsafe:"Significant behaviour concerns" },
    { key:"dev4_asd_screen", safe:"No ASD features", unsafe:"ASD features present" },
    { key:"dev4_immunised", safe:"Immunisations up to date", unsafe:"Immunisations overdue" },
    { key:"dev4_dental", safe:"Dental review done", unsafe:"Dental review not done" },
    { key:"dev4_family", safe:"Family functioning well", unsafe:"Family stress/concerns" },
  ],
  "Newborn check": [
    { key:"nb_feeding", safe:"Feeding well", unsafe:"Feeding difficulties" },
    { key:"nb_jaundice", safe:"No jaundice", unsafe:"Jaundice" },
    { key:"nb_weight", safe:"Weight gain adequate", unsafe:"Weight loss/poor gain" },
    { key:"nb_hips", safe:"Hips normal", unsafe:"Hip click/instability" },
    { key:"nb_heart", safe:"Heart sounds normal", unsafe:"Murmur detected" },
    { key:"nb_eyes", safe:"Red reflex present", unsafe:"Red reflex absent" },
    { key:"nb_testes", safe:"Testes descended", unsafe:"Undescended testes" },
    { key:"nb_palate", safe:"Palate intact", unsafe:"Cleft palate" },
    { key:"nb_newborn_screen", safe:"Newborn screening done", unsafe:"Newborn screening not done" },
    { key:"nb_vitamin_k", safe:"Vitamin K given", unsafe:"Vitamin K not given" },
    { key:"nb_maternal", safe:"Mother well/bonding", unsafe:"Maternal concerns" },
  ],
  "Growth concerns": [
    { key:"gc_centile", safe:"On centile", unsafe:"Crossing centiles" },
    { key:"gc_weight", safe:"Weight appropriate", unsafe:"Underweight/overweight" },
    { key:"gc_height", safe:"Height appropriate", unsafe:"Short/tall stature" },
    { key:"gc_diet", safe:"Diet adequate", unsafe:"Dietary concerns" },
    { key:"gc_pubertal", safe:"Pubertal development normal", unsafe:"Pubertal delay/precocity" },
    { key:"gc_family", safe:"Parental heights appropriate", unsafe:"Parental height discordance" },
    { key:"gc_chronic", safe:"No chronic illness", unsafe:"Chronic illness affecting growth" },
    { key:"gc_psychosocial", safe:"Psychosocial environment adequate", unsafe:"Psychosocial concerns" },
  ],
  "Behavioural concerns": [
    { key:"beh_school", safe:"School functioning well", unsafe:"School difficulties" },
    { key:"beh_home", safe:"Behaviour manageable at home", unsafe:"Unmanageable at home" },
    { key:"beh_sleep", safe:"Sleep adequate", unsafe:"Sleep problems" },
    { key:"beh_asd_features", safe:"No ASD features", unsafe:"ASD features" },
    { key:"beh_adhd_features", safe:"No ADHD features", unsafe:"ADHD features" },
    { key:"beh_trauma", safe:"No trauma history", unsafe:"Trauma history" },
    { key:"beh_family", safe:"Family stable", unsafe:"Family stress" },
    { key:"beh_development", safe:"Development normal", unsafe:"Developmental delay" },
    { key:"beh_aggression", safe:"No aggression", unsafe:"Aggression/self-harm" },
  ],
  "Childhood asthma review": [
    { key:"cash_nocturnal", safe:"No nocturnal symptoms", unsafe:"Nocturnal cough/wheeze" },
    { key:"cash_exercise", safe:"No exercise limitation", unsafe:"Exercise-induced symptoms" },
    { key:"cash_school", safe:"No school days missed", unsafe:"School days missed" },
    { key:"cash_reliever", safe:"Reliever <3x/week", unsafe:"Reliever >3x/week" },
    { key:"cash_preventer", safe:"Preventer compliant", unsafe:"Non-compliant with preventer" },
    { key:"cash_technique", safe:"Good inhaler technique", unsafe:"Poor inhaler technique" },
    { key:"cash_spacer", safe:"Spacer used", unsafe:"No spacer" },
    { key:"cash_plan", safe:"Asthma plan in place", unsafe:"No asthma action plan" },
    { key:"cash_triggers", safe:"Triggers identified", unsafe:"Triggers not identified" },
    { key:"cash_ed", safe:"No ED presentations", unsafe:"ED/hospital admissions" },
  ],
  "Ear pain (child)": [
    { key:"earc_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"earc_discharge", safe:"No discharge", unsafe:"Ear discharge" },
    { key:"earc_hearing", safe:"Hearing normal", unsafe:"Hearing loss" },
    { key:"earc_recurrent", safe:"First episode", unsafe:"Recurrent otitis media" },
    { key:"earc_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
    { key:"earc_vomiting", safe:"No vomiting", unsafe:"Vomiting" },
    { key:"earc_mastoid", safe:"No mastoid tenderness", unsafe:"Mastoid tenderness" },
    { key:"earc_grommets", safe:"No grommets", unsafe:"Previous grommets" },
  ],
  "Rash (child)": [
    { key:"rashc_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"rashc_blanching", safe:"Blanching", unsafe:"Non-blanching (meningococcal risk)" },
    { key:"rashc_meningism", safe:"No meningism", unsafe:"Meningism" },
    { key:"rashc_distribution", safe:"Localised", unsafe:"Widespread/mucosal involvement" },
    { key:"rashc_itchy", safe:"Non-pruritic", unsafe:"Pruritic" },
    { key:"rashc_unwell", safe:"Well child", unsafe:"Unwell child" },
    { key:"rashc_contact", safe:"No sick contacts", unsafe:"Sick contacts" },
    { key:"rashc_immunised", safe:"Fully immunised", unsafe:"Unimmunised/incomplete" },
    { key:"rashc_new_meds", safe:"No new medications", unsafe:"Recent new medication (drug rash)" },
  ],
  "Failure to thrive": [
    { key:"ftt_centile", safe:"Following centile", unsafe:"Falling centiles" },
    { key:"ftt_feeding", safe:"Feeding adequate", unsafe:"Feeding difficulties" },
    { key:"ftt_vomiting", safe:"No vomiting", unsafe:"Vomiting/regurgitation" },
    { key:"ftt_stool", safe:"Stool normal", unsafe:"Abnormal stools (coeliac/CF)" },
    { key:"ftt_recurrent", safe:"No recurrent infections", unsafe:"Recurrent infections (immune deficiency)" },
    { key:"ftt_psychosocial", safe:"Psychosocial factors absent", unsafe:"Psychosocial factors present" },
    { key:"ftt_neglect", safe:"No safeguarding concerns", unsafe:"Safeguarding concerns" },
    { key:"ftt_development", safe:"Development normal", unsafe:"Developmental delay" },
  ],
  "Immunisation review": [
    { key:"imm_schedule", safe:"Up to date", unsafe:"Overdue immunisations" },
    { key:"imm_adverse", safe:"No previous adverse reactions", unsafe:"Previous adverse reaction" },
    { key:"imm_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised (live vaccines contraindicated)" },
    { key:"imm_fever", safe:"Afebrile today", unsafe:"Febrile today (defer)" },
    { key:"imm_consent", safe:"Informed consent given", unsafe:"Consent not obtained" },
    { key:"imm_parent", safe:"Parent accepts vaccines", unsafe:"Vaccine hesitancy" },
  ],
  "Rash": [
    { key:"rash_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"rash_blanching", safe:"Blanching", unsafe:"Non-blanching" },
    { key:"rash_mucosal", safe:"No mucosal involvement", unsafe:"Mucosal involvement (SJS)" },
    { key:"rash_blistering", safe:"No blistering", unsafe:"Blistering" },
    { key:"rash_spread", safe:"Localised", unsafe:"Rapidly spreading" },
    { key:"rash_systemic", safe:"No systemic symptoms", unsafe:"Systemic symptoms" },
    { key:"rash_new_meds", safe:"No new medications", unsafe:"New medication (SJS risk)" },
    { key:"rash_itch", safe:"Non-pruritic", unsafe:"Pruritic" },
    { key:"rash_contact", safe:"No contact history", unsafe:"Contact history" },
  ],
  "Skin lesion": [
    { key:"sl_asymm", safe:"Symmetrical", unsafe:"Asymmetrical" },
    { key:"sl_border", safe:"Regular border", unsafe:"Irregular border" },
    { key:"sl_colour", safe:"Uniform colour", unsafe:"Multiple colours" },
    { key:"sl_diameter", safe:"<6mm", unsafe:">6mm" },
    { key:"sl_evolving", safe:"Stable", unsafe:"Changing/evolving" },
    { key:"sl_bleed", safe:"Not bleeding", unsafe:"Bleeding/ulcerated" },
    { key:"sl_itch", safe:"Not itchy", unsafe:"Itchy" },
    { key:"sl_sun_exposure", safe:"Minimal sun exposure", unsafe:"High cumulative sun exposure" },
    { key:"sl_fhx", safe:"No family history melanoma", unsafe:"Family history melanoma" },
    { key:"sl_prev_skin_ca", safe:"No previous skin cancer", unsafe:"Previous skin cancer" },
    { key:"sl_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
  ],
  "Acne": [
    { key:"acne_inflam", safe:"Comedonal only", unsafe:"Inflammatory acne" },
    { key:"acne_nodular", safe:"No nodules/cysts", unsafe:"Nodular/cystic acne" },
    { key:"acne_scarring", safe:"No scarring", unsafe:"Scarring" },
    { key:"acne_psychosocial", safe:"No psychosocial impact", unsafe:"Significant psychosocial impact" },
    { key:"acne_treatment", safe:"Responding to treatment", unsafe:"Not responding to treatment" },
    { key:"acne_isotretinoin", safe:"Not on isotretinoin", unsafe:"On isotretinoin (monitoring)" },
    { key:"acne_female_hormones", safe:"No hormonal features", unsafe:"Hormonal features (female)" },
    { key:"acne_pregnancy", safe:"Not pregnant", unsafe:"Pregnant (isotretinoin contraindicated)" },
  ],
  "Eczema review": [
    { key:"eczema_control", safe:"Well controlled", unsafe:"Poorly controlled" },
    { key:"eczema_sleep", safe:"Sleep not affected", unsafe:"Sleep affected by itch" },
    { key:"eczema_trigger", safe:"Triggers identified", unsafe:"Triggers not identified" },
    { key:"eczema_infection", safe:"No secondary infection", unsafe:"Secondary infection (impetiginised)" },
    { key:"eczema_compliance", safe:"Emollient/steroid compliant", unsafe:"Non-compliant" },
    { key:"eczema_diet", safe:"No food allergy trigger", unsafe:"Food allergy trigger" },
    { key:"eczema_psychosocial", safe:"No psychosocial impact", unsafe:"Significant psychosocial impact" },
  ],
  "Psoriasis review": [
    { key:"pso_severity", safe:"Mild severity", unsafe:"Moderate-severe (BSA >10%)" },
    { key:"pso_joints", safe:"No joint symptoms", unsafe:"Joint symptoms (PsA)" },
    { key:"pso_nails", safe:"No nail involvement", unsafe:"Nail involvement" },
    { key:"pso_scalp", safe:"No scalp involvement", unsafe:"Scalp involvement" },
    { key:"pso_compliance", safe:"Treatment compliant", unsafe:"Non-compliant" },
    { key:"pso_metabolic", safe:"No metabolic comorbidities", unsafe:"Metabolic comorbidities" },
    { key:"pso_depression", safe:"No depression", unsafe:"Depression" },
    { key:"pso_biologic", safe:"Not on biologics", unsafe:"On biologics (screening required)" },
    { key:"pso_trigger", safe:"No current triggers", unsafe:"Trigger identified" },
  ],
  "Skin cancer screening": [
    { key:"scs_new_lesion", safe:"No new/changing lesions", unsafe:"New/changing lesion" },
    { key:"scs_prev_skin_ca", safe:"No previous skin cancer", unsafe:"Previous skin cancer" },
    { key:"scs_sun_history", safe:"Low sun exposure history", unsafe:"High sun exposure/burns" },
    { key:"scs_fhx", safe:"No family history", unsafe:"Family history melanoma" },
    { key:"scs_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
    { key:"scs_sun_protect", safe:"Uses sun protection", unsafe:"No sun protection" },
  ],
  "Urticaria": [
    { key:"urti_angioedema", safe:"No angioedema", unsafe:"Angioedema" },
    { key:"urti_anaphylaxis", safe:"No anaphylaxis features", unsafe:"Anaphylaxis features" },
    { key:"urti_trigger", safe:"Trigger identified", unsafe:"No trigger identified" },
    { key:"urti_medication", safe:"No causative medications", unsafe:"NSAID/ACEI trigger" },
    { key:"urti_chronic", safe:"Acute (<6 weeks)", unsafe:"Chronic (>6 weeks)" },
    { key:"urti_autoimmune", safe:"No autoimmune features", unsafe:"Autoimmune features" },
  ],
  "Alopecia": [
    { key:"alop_pattern", safe:"Diffuse loss", unsafe:"Patchy loss" },
    { key:"alop_scarring", safe:"Non-scarring", unsafe:"Scarring alopecia" },
    { key:"alop_thyroid", safe:"No thyroid symptoms", unsafe:"Thyroid symptoms" },
    { key:"alop_iron", safe:"No iron deficiency features", unsafe:"Iron deficiency features" },
    { key:"alop_stress", safe:"No recent major stress", unsafe:"Telogen effluvium trigger" },
    { key:"alop_family", safe:"No family history", unsafe:"Family history (androgenic)" },
    { key:"alop_medication", safe:"No causative medications", unsafe:"Causative medications" },
    { key:"alop_psych", safe:"No psychosocial impact", unsafe:"Significant psychosocial impact" },
  ],
  "Red eye": [
    { key:"re_vision", safe:"Vision normal", unsafe:"Visual disturbance" },
    { key:"re_pain", safe:"Painless", unsafe:"Painful" },
    { key:"re_photophobia", safe:"No photophobia", unsafe:"Photophobia (iritis/keratitis)" },
    { key:"re_discharge", safe:"No discharge", unsafe:"Discharge (conjunctivitis)" },
    { key:"re_contacts", safe:"Not contact lens wearer", unsafe:"Contact lens wearer" },
    { key:"re_subconj", safe:"No subconjunctival haemorrhage", unsafe:"Subconjunctival haemorrhage" },
    { key:"re_trauma", safe:"No trauma", unsafe:"Trauma" },
    { key:"re_iop", safe:"No raised IOP features", unsafe:"Raised IOP features (closed angle glaucoma)" },
  ],
  "Visual disturbance": [
    { key:"vis_sudden", safe:"Gradual onset", unsafe:"Sudden onset" },
    { key:"vis_painless", safe:"Painless", unsafe:"Painful" },
    { key:"vis_unilateral", safe:"Bilateral", unsafe:"Unilateral" },
    { key:"vis_transient", safe:"Persistent", unsafe:"Transient (amaurosis fugax)" },
    { key:"vis_curtain", safe:"No curtain effect", unsafe:"Curtain/shadow effect (retinal detachment)" },
    { key:"vis_floaters", safe:"No new floaters", unsafe:"Sudden new floaters/flashes" },
    { key:"vis_central", safe:"Peripheral loss only", unsafe:"Central vision loss" },
    { key:"vis_diplopia", safe:"No diplopia", unsafe:"Diplopia" },
    { key:"vis_headache", safe:"No headache", unsafe:"Headache (giant cell arteritis)" },
    { key:"vis_neuro", safe:"No neurological symptoms", unsafe:"Neurological symptoms" },
  ],
  "Ear pain": [
    { key:"ear_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"ear_discharge", safe:"No discharge", unsafe:"Ear discharge" },
    { key:"ear_hearing", safe:"Hearing normal", unsafe:"Hearing loss" },
    { key:"ear_vertigo", safe:"No vertigo", unsafe:"Vertigo" },
    { key:"ear_tinnitus", safe:"No tinnitus", unsafe:"Tinnitus" },
    { key:"ear_mastoid", safe:"No mastoid tenderness", unsafe:"Mastoid tenderness (mastoiditis)" },
    { key:"ear_jaw", safe:"No jaw symptoms", unsafe:"Jaw symptoms (TMJ/referred)" },
    { key:"ear_swimmer", safe:"No water exposure", unsafe:"Swimming/water exposure (OE)" },
  ],
  "Hearing loss": [
    { key:"hlos_sudden", safe:"Gradual onset", unsafe:"Sudden onset (<72h)" },
    { key:"hlos_unilateral", safe:"Bilateral", unsafe:"Unilateral" },
    { key:"hlos_tinnitus", safe:"No tinnitus", unsafe:"Tinnitus" },
    { key:"hlos_vertigo", safe:"No vertigo", unsafe:"Vertigo" },
    { key:"hlos_discharge", safe:"No discharge", unsafe:"Ear discharge" },
    { key:"hlos_noise", safe:"No noise exposure", unsafe:"Noise exposure" },
    { key:"hlos_ototoxic", safe:"No ototoxic medications", unsafe:"Ototoxic medications" },
    { key:"hlos_neuro", safe:"No neurological symptoms", unsafe:"Neurological symptoms" },
  ],
  "Tinnitus": [
    { key:"tin_unilateral", safe:"Bilateral", unsafe:"Unilateral tinnitus" },
    { key:"tin_pulsatile", safe:"Non-pulsatile", unsafe:"Pulsatile tinnitus" },
    { key:"tin_hearing", safe:"Hearing normal", unsafe:"Hearing loss" },
    { key:"tin_vertigo", safe:"No vertigo", unsafe:"Vertigo" },
    { key:"tin_sudden", safe:"Gradual onset", unsafe:"Sudden onset" },
    { key:"tin_noise", safe:"No noise exposure", unsafe:"Noise exposure" },
    { key:"tin_sleep", safe:"Sleep not affected", unsafe:"Sleep affected" },
    { key:"tin_psychological", safe:"No psychological impact", unsafe:"Significant psychological impact" },
    { key:"tin_medication", safe:"No causative medications", unsafe:"Causative medications" },
    { key:"tin_neuro", safe:"No neurological symptoms", unsafe:"Neurological symptoms" },
  ],
  "Sore throat": [
    { key:"st_fever", safe:"Afebrile", unsafe:"Fever >38.5C" },
    { key:"st_exudate", safe:"No exudate", unsafe:"Tonsillar exudate" },
    { key:"st_lymph", safe:"No anterior cervical lymphadenopathy", unsafe:"Anterior cervical lymphadenopathy" },
    { key:"st_trismus", safe:"No trismus", unsafe:"Trismus (peritonsillar abscess)" },
    { key:"st_drooling", safe:"No drooling/stridor", unsafe:"Drooling/stridor (epiglottitis)" },
    { key:"st_rash", safe:"No rash", unsafe:"Scarlatiniform rash" },
    { key:"st_cough", safe:"Cough absent", unsafe:"Cough present (viral likely)" },
    { key:"st_mono", safe:"No mononucleosis features", unsafe:"Mononucleosis features" },
  ],
  "Sinusitis": [
    { key:"sin_purulent", safe:"Clear discharge", unsafe:"Purulent discharge" },
    { key:"sin_facial_pain", safe:"No facial pain", unsafe:"Facial pain/pressure" },
    { key:"sin_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"sin_duration", safe:"<10 days (viral likely)", unsafe:"Persisting >10 days" },
    { key:"sin_orbital", safe:"No orbital symptoms", unsafe:"Orbital symptoms (orbital cellulitis)" },
    { key:"sin_vision", safe:"Vision normal", unsafe:"Visual disturbance" },
    { key:"sin_headache", safe:"Mild headache", unsafe:"Severe headache" },
    { key:"sin_neuro", safe:"No neurological symptoms", unsafe:"Neurological symptoms (intracranial extension)" },
  ],
  "Epistaxis": [
    { key:"epis_volume", safe:"Minor bleeding", unsafe:"Major/significant bleeding" },
    { key:"epis_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
    { key:"epis_posterior", safe:"Anterior bleeding", unsafe:"Posterior bleeding" },
    { key:"epis_anticoagulant", safe:"No anticoagulant", unsafe:"On anticoagulant" },
    { key:"epis_bp", safe:"BP normal", unsafe:"Hypertension" },
    { key:"epis_recurrent", safe:"First episode", unsafe:"Recurrent episodes" },
    { key:"epis_haematological", safe:"No haematological disease", unsafe:"Haematological disease" },
    { key:"epis_trauma", safe:"No trauma", unsafe:"Trauma" },
  ],
  "Hoarseness": [
    { key:"hoar_duration", safe:"Acute onset (<3 weeks)", unsafe:"Chronic (>3 weeks)" },
    { key:"hoar_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"hoar_dysphagia", safe:"No dysphagia", unsafe:"Dysphagia" },
    { key:"hoar_stridor", safe:"No stridor", unsafe:"Stridor" },
    { key:"hoar_smoker", safe:"Non-smoker", unsafe:"Smoker" },
    { key:"hoar_neck_mass", safe:"No neck mass", unsafe:"Neck mass" },
    { key:"hoar_neuro", safe:"No neurological symptoms", unsafe:"Neurological symptoms (RLN palsy)" },
    { key:"hoar_haemoptysis", safe:"No haemoptysis", unsafe:"Haemoptysis" },
  ],
  "Haematuria": [
    { key:"haem_visible", safe:"Microscopic only", unsafe:"Visible haematuria" },
    { key:"haem_pain", safe:"Painless", unsafe:"Painful (loin - stone; dysuria - infection)" },
    { key:"haem_clots", safe:"No clots", unsafe:"Clots passed" },
    { key:"haem_age", safe:"Age <40", unsafe:"Age >40" },
    { key:"haem_smoker", safe:"Non-smoker", unsafe:"Smoker" },
    { key:"haem_occupation", safe:"No risk occupation", unsafe:"High risk occupation (dyes/rubber)" },
    { key:"haem_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"haem_uti_symptoms", safe:"No UTI symptoms", unsafe:"UTI symptoms" },
    { key:"haem_anticoagulant", safe:"No anticoagulant", unsafe:"On anticoagulant" },
  ],
  "Renal colic": [
    { key:"rc_severity", safe:"Mild pain", unsafe:"Severe colicky flank pain" },
    { key:"rc_nausea", safe:"No nausea/vomiting", unsafe:"Nausea/vomiting" },
    { key:"rc_haematuria", safe:"No haematuria", unsafe:"Haematuria" },
    { key:"rc_fever", safe:"Afebrile", unsafe:"Fever (obstructive uropathy)" },
    { key:"rc_bilateral", safe:"Unilateral", unsafe:"Bilateral" },
    { key:"rc_previous", safe:"First episode", unsafe:"Previous renal stones" },
    { key:"rc_solitary", safe:"Two kidneys", unsafe:"Solitary kidney" },
    { key:"rc_obstruction", safe:"No obstruction features", unsafe:"Obstruction features" },
  ],
  "Chronic kidney disease review": [
    { key:"ckd_progression", safe:"Stable GFR", unsafe:"Declining GFR" },
    { key:"ckd_bp", safe:"BP controlled", unsafe:"BP above target" },
    { key:"ckd_proteinuria", safe:"Proteinuria controlled", unsafe:"Worsening proteinuria" },
    { key:"ckd_anaemia", safe:"No anaemia", unsafe:"Renal anaemia" },
    { key:"ckd_bone", safe:"No renal bone disease", unsafe:"Renal bone disease" },
    { key:"ckd_fluid", safe:"Euvolemic", unsafe:"Fluid overload" },
    { key:"ckd_electrolytes", safe:"Electrolytes normal", unsafe:"Electrolyte abnormality" },
    { key:"ckd_nephrotoxins", safe:"No nephrotoxins", unsafe:"Nephrotoxin exposure" },
    { key:"ckd_dialysis", safe:"Not approaching dialysis", unsafe:"Approaching dialysis" },
    { key:"ckd_transplant", safe:"No transplant consideration", unsafe:"Transplant workup" },
  ],
  "Urinary incontinence": [
    { key:"ui_type", safe:"Urge incontinence", unsafe:"Stress incontinence" },
    { key:"ui_frequency", safe:"Normal frequency", unsafe:"Urinary frequency" },
    { key:"ui_nocturia", safe:"No nocturia", unsafe:"Nocturia" },
    { key:"ui_volume", safe:"Small leaks", unsafe:"Large volume leaks" },
    { key:"ui_cauda_equina", safe:"No cauda equina features", unsafe:"Cauda equina features" },
    { key:"ui_haematuria", safe:"No haematuria", unsafe:"Haematuria" },
    { key:"ui_pain", safe:"No pelvic pain", unsafe:"Pelvic pain" },
    { key:"ui_prolapse", safe:"No prolapse symptoms", unsafe:"Prolapse symptoms" },
    { key:"ui_medication", safe:"No causative medications", unsafe:"Causative medications" },
    { key:"ui_constipation", safe:"No constipation", unsafe:"Constipation" },
  ],
  "Recurrent UTI": [
    { key:"ruti_frequency", safe:"<3 UTIs/year", unsafe:">3 UTIs/year" },
    { key:"ruti_haematuria", safe:"No haematuria", unsafe:"Persistent haematuria" },
    { key:"ruti_structural", safe:"No structural abnormality", unsafe:"Structural abnormality" },
    { key:"ruti_pelvic", safe:"No pelvic floor symptoms", unsafe:"Pelvic floor dysfunction" },
    { key:"ruti_diabetes", safe:"No diabetes", unsafe:"Diabetes" },
    { key:"ruti_immunocomp", safe:"Immunocompetent", unsafe:"Immunocompromised" },
    { key:"ruti_catheter", safe:"No catheter", unsafe:"Indwelling catheter" },
    { key:"ruti_sex", safe:"Not sex-related", unsafe:"Post-coital UTIs" },
    { key:"ruti_prophylaxis", safe:"On prophylaxis", unsafe:"Not on prophylaxis" },
  ],
  "Fatigue": [
    { key:"fat_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"fat_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"fat_nightsweats", safe:"No night sweats", unsafe:"Night sweats" },
    { key:"fat_sleep", safe:"Adequate sleep", unsafe:"Poor sleep" },
    { key:"fat_lymph", safe:"No lymphadenopathy", unsafe:"Lymphadenopathy" },
    { key:"fat_mood", safe:"Mood normal", unsafe:"Low mood/depression" },
    { key:"fat_appetite", safe:"Appetite normal", unsafe:"Reduced appetite" },
    { key:"fat_dyspnea", safe:"No dyspnea on exertion", unsafe:"Dyspnea on exertion" },
    { key:"fat_cognitive", safe:"No cognitive symptoms", unsafe:"Cognitive symptoms" },
    { key:"fat_exercise", safe:"Exercise tolerance normal", unsafe:"Reduced exercise tolerance" },
  ],
  "Weight loss": [
    { key:"wl_amount", safe:"Minor loss", unsafe:">5% body weight" },
    { key:"wl_appetite", safe:"Appetite preserved", unsafe:"Reduced appetite" },
    { key:"wl_diarrhea", safe:"No diarrhea", unsafe:"Diarrhea/malabsorption" },
    { key:"wl_dysphagia", safe:"No dysphagia", unsafe:"Dysphagia" },
    { key:"wl_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"wl_nightsweats", safe:"No night sweats", unsafe:"Night sweats" },
    { key:"wl_lymph", safe:"No lymphadenopathy", unsafe:"Lymphadenopathy" },
    { key:"wl_social", safe:"Eating adequate", unsafe:"Social isolation/poor access to food" },
    { key:"wl_mood", safe:"Mood normal", unsafe:"Depression" },
    { key:"wl_diabetes", safe:"No diabetes symptoms", unsafe:"Diabetes symptoms" },
  ],
  "Night sweats": [
    { key:"ns_fever", safe:"Afebrile", unsafe:"Fever" },
    { key:"ns_weightloss", safe:"No weight loss", unsafe:"Weight loss" },
    { key:"ns_lymph", safe:"No lymphadenopathy", unsafe:"Lymphadenopathy" },
    { key:"ns_menopause", safe:"Not menopausal", unsafe:"Menopausal symptoms" },
    { key:"ns_medication", safe:"No causative medications", unsafe:"Causative medications" },
    { key:"ns_alcohol", safe:"No excess alcohol", unsafe:"Excess alcohol" },
    { key:"ns_hiv_risk", safe:"Low HIV risk", unsafe:"HIV risk factors" },
    { key:"ns_tb_risk", safe:"No TB risk factors", unsafe:"TB risk factors" },
    { key:"ns_malignancy", safe:"No malignancy features", unsafe:"Malignancy features" },
  ],
  "Anaemia": [
    { key:"an_iron", safe:"No iron deficiency features", unsafe:"Iron deficiency features" },
    { key:"an_b12", safe:"No B12/folate deficiency features", unsafe:"B12/folate deficiency features" },
    { key:"an_haematological", safe:"No haematological disease features", unsafe:"Haematological disease features" },
    { key:"an_bleeding", safe:"No bleeding source", unsafe:"Bleeding source identified" },
    { key:"an_symptoms", safe:"Asymptomatic", unsafe:"Symptomatic anaemia" },
    { key:"an_cardiac", safe:"No cardiac symptoms", unsafe:"Cardiac symptoms (angina/HF)" },
    { key:"an_chronic_disease", safe:"No chronic disease", unsafe:"Chronic disease anaemia" },
    { key:"an_haemolysis", safe:"No haemolysis features", unsafe:"Haemolysis features" },
  ],
  "Well adult check": [
    { key:"wac_cardiovascular", safe:"Low CV risk", unsafe:"Elevated CV risk" },
    { key:"wac_diabetes", safe:"No diabetes risk factors", unsafe:"Diabetes risk factors" },
    { key:"wac_cancer_screen", safe:"Cancer screening up to date", unsafe:"Cancer screening overdue" },
    { key:"wac_smoking", safe:"Non-smoker", unsafe:"Smoker" },
    { key:"wac_alcohol", safe:"Low risk alcohol", unsafe:"Hazardous alcohol use" },
    { key:"wac_bmi", safe:"BMI normal", unsafe:"BMI abnormal" },
    { key:"wac_exercise", safe:"Regular exercise", unsafe:"Sedentary" },
    { key:"wac_mental_health", safe:"Mental health well", unsafe:"Mental health concerns" },
    { key:"wac_immunisations", safe:"Immunisations up to date", unsafe:"Immunisations overdue" },
    { key:"wac_social", safe:"Social supports adequate", unsafe:"Social isolation" },
  ],
  "Medication review": [
    { key:"mr_indication", safe:"All medications indicated", unsafe:"Medications without indication" },
    { key:"mr_interactions", safe:"No interactions", unsafe:"Drug interactions present" },
    { key:"mr_side_effects", safe:"No side effects", unsafe:"Side effects present" },
    { key:"mr_adherence", safe:"Adherent", unsafe:"Non-adherent" },
    { key:"mr_duplication", safe:"No therapeutic duplication", unsafe:"Therapeutic duplication" },
    { key:"mr_renal", safe:"Renally appropriate", unsafe:"Renal dose adjustment needed" },
    { key:"mr_age", safe:"Age-appropriate", unsafe:"Potentially inappropriate for age" },
    { key:"mr_falls", safe:"No falls risk medications", unsafe:"Falls risk medications" },
  ],
  "Travel medicine": [
    { key:"trav_malaria", safe:"No malaria prophylaxis needed", unsafe:"Malaria prophylaxis required" },
    { key:"trav_vaccines", safe:"Vaccines up to date", unsafe:"Vaccines required" },
    { key:"trav_diarrhea", safe:"Low GI risk area", unsafe:"High GI risk area" },
    { key:"trav_altitude", safe:"No altitude risk", unsafe:"High altitude destination" },
    { key:"trav_water", safe:"Safe water available", unsafe:"Unsafe water (filtration/purification)" },
    { key:"trav_sun", safe:"Low UV exposure", unsafe:"High UV exposure" },
    { key:"trav_insurance", safe:"Travel insurance arranged", unsafe:"No travel insurance" },
    { key:"trav_comorbidity", safe:"No significant comorbidity", unsafe:"Comorbidity affecting travel" },
  ],
  "Palliative care review": [
    { key:"pal_pain", safe:"Pain controlled", unsafe:"Uncontrolled pain" },
    { key:"pal_dyspnea", safe:"Dyspnea controlled", unsafe:"Uncontrolled dyspnea" },
    { key:"pal_nausea", safe:"Nausea controlled", unsafe:"Uncontrolled nausea" },
    { key:"pal_agitation", safe:"No agitation", unsafe:"Terminal agitation" },
    { key:"pal_goals", safe:"Goals of care documented", unsafe:"Goals of care not documented" },
    { key:"pal_medication", safe:"Comfort medications prescribed", unsafe:"Comfort medications not prescribed" },
    { key:"pal_family", safe:"Family aware of prognosis", unsafe:"Family not informed" },
    { key:"pal_spiritual", safe:"Spiritual needs addressed", unsafe:"Spiritual needs not addressed" },
    { key:"pal_preferred_place", safe:"Preferred place of death documented", unsafe:"Preferred place not documented" },
  ],
};
const DEFAULT_CONFIG = {};
Object.keys(MASTER_FEATURES).forEach(pres => {
  DEFAULT_CONFIG[pres] = { enabled: MASTER_FEATURES[pres].map(f => f.key), redFlags: [] };
});

function App() {
  const [mode, setMode] = useState("assess");
  const [presentation, setPresentation] = useState("");
  const [configPresentation, setConfigPresentation] = useState(Object.keys(MASTER_FEATURES)[0]);
  const [configCategory, setConfigCategory] = useState(Object.keys(CATEGORIES)[0]);
  const [configTab, setConfigTab] = useState("presentation"); // "presentation" | "ros" | "exam"

  const [userConfig, setUserConfig] = useState(() => {
    try { const s = localStorage.getItem("clinicalConfigV5"); return s ? JSON.parse(s) : DEFAULT_CONFIG; }
    catch { return DEFAULT_CONFIG; }
  });
  useEffect(() => {
    try { localStorage.setItem("clinicalConfigV5", JSON.stringify(userConfig)); } catch {}
  }, [userConfig]);

  const [bedNumber, setBedNumber] = useState("");
  const [patientInitials, setPatientInitials] = useState("");
  const [patientAge, setPatientAge] = useState("");
  const [patientSex, setPatientSex] = useState("");
  const [hopc, setHopc] = useState("");
  const [medications, setMedications] = useState("");
  const [noRegularMeds, setNoRegularMeds] = useState(false);
  const [allergies, setAllergies] = useState("");
  const [nkda, setNkda] = useState(false);
  const [pmhx, setPmhx] = useState("");
  const [nsmh, setNsmh] = useState(false);
  const [diagnosis, setDiagnosis] = useState("");
  const [plan, setPlan] = useState("");
  const [output, setOutput] = useState("");
  const [isGenerating, setIsGenerating] = useState(false);
  const [aiError, setAiError] = useState("");
  const [showKeyInput, setShowKeyInput] = useState(false);
  const [apiKeyInput, setApiKeyInput] = useState("");

  //  Long-press custom text 
  const [customText, setCustomText] = useState({});     // { [key]: "user typed string" }
  const [lpEditingKey, setLpEditingKey] = useState(null); // which key is open for long-press editing
  const lpTimer = React.useRef(null);

  const startLongPress = (key) => {
    lpTimer.current = setTimeout(() => {
      setLpEditingKey(key);
    }, 500);
  };
  const cancelLongPress = () => clearTimeout(lpTimer.current);

  //  Nested child features 
  const [childFeatures, setChildFeatures] = useState({}); // { [childKey]: "null"|"safe"|"unsafe" }
  const toggleChild = (key) => {
    setChildFeatures(prev => {
      const cur = prev[key] || "null";
      return { ...prev, [key]: cur === "null" ? "safe" : cur === "safe" ? "unsafe" : "null" };
    });
  };

  // Parent keys that trigger nested expansion  child button arrays
  const NESTED_FEATURES = {
    // Cranial nerves  exam button ex_cn
    "ex_cn": [
      { key:"cn_i",   safe:"CN I intact",    unsafe:"CN I deficit (olfaction)" },
      { key:"cn_ii",  safe:"CN II intact",   unsafe:"CN II deficit (vision/acuity)" },
      { key:"cn_iii", safe:"CN III intact",  unsafe:"CN III deficit (ptosis/mydriasis/EOM)" },
      { key:"cn_iv",  safe:"CN IV intact",   unsafe:"CN IV deficit (superior oblique)" },
      { key:"cn_v",   safe:"CN V intact",    unsafe:"CN V deficit (facial sensation/masseter)" },
      { key:"cn_vi",  safe:"CN VI intact",   unsafe:"CN VI deficit (lateral gaze)" },
      { key:"cn_vii", safe:"CN VII intact",  unsafe:"CN VII deficit (facial movement)" },
      { key:"cn_viii",safe:"CN VIII intact", unsafe:"CN VIII deficit (hearing/balance)" },
      { key:"cn_ix",  safe:"CN IX intact",   unsafe:"CN IX deficit (gag/palate)" },
      { key:"cn_x",   safe:"CN X intact",    unsafe:"CN X deficit (voice/swallow)" },
      { key:"cn_xi",  safe:"CN XI intact",   unsafe:"CN XI deficit (SCM/trapezius)" },
      { key:"cn_xii", safe:"CN XII intact",  unsafe:"CN XII deficit (tongue)" },
    ],
    // Abdominal regions  exam button ex_soft (generalised peritonism parent)
    "ex_soft": [
      { key:"abd_ruq",  safe:"RUQ non-tender",    unsafe:"RUQ tenderness" },
      { key:"abd_epig", safe:"Epigastrium non-tender", unsafe:"Epigastric tenderness" },
      { key:"abd_luq",  safe:"LUQ non-tender",    unsafe:"LUQ tenderness" },
      { key:"abd_rlq",  safe:"RLQ non-tender",    unsafe:"RLQ tenderness" },
      { key:"abd_central",safe:"Central non-tender", unsafe:"Central/periumbilical tenderness" },
      { key:"abd_llq",  safe:"LLQ non-tender",    unsafe:"LLQ tenderness" },
      { key:"abd_supr", safe:"Suprapubic non-tender", unsafe:"Suprapubic tenderness" },
      { key:"abd_gen",  safe:"No generalised peritonism", unsafe:"Generalised peritonism" },
    ],
    // Cranial nerves in feature toggle (for neuro presentations)
    "nf_cn": [
      { key:"fnc_i",   safe:"CN I intact",    unsafe:"CN I deficit" },
      { key:"fnc_ii",  safe:"CN II intact",   unsafe:"CN II deficit" },
      { key:"fnc_iii", safe:"CN III intact",  unsafe:"CN III deficit" },
      { key:"fnc_iv",  safe:"CN IV intact",   unsafe:"CN IV deficit" },
      { key:"fnc_v",   safe:"CN V intact",    unsafe:"CN V deficit" },
      { key:"fnc_vi",  safe:"CN VI intact",   unsafe:"CN VI deficit" },
      { key:"fnc_vii", safe:"CN VII intact",  unsafe:"CN VII deficit" },
      { key:"fnc_viii",safe:"CN VIII intact", unsafe:"CN VIII deficit" },
      { key:"fnc_ix",  safe:"CN IX intact",   unsafe:"CN IX deficit" },
      { key:"fnc_x",   safe:"CN X intact",    unsafe:"CN X deficit" },
      { key:"fnc_xi",  safe:"CN XI intact",   unsafe:"CN XI deficit" },
      { key:"fnc_xii", safe:"CN XII intact",  unsafe:"CN XII deficit" },
    ],
  };
  const [temp, setTemp] = useState("");
  const [bp, setBp] = useState("");
  const [dbp, setDbp] = useState("");
  const [hr, setHr] = useState("");
  const [rr, setRr] = useState("");
  const [spo2, setSpo2] = useState("");
  const [ecgComment, setEcgComment] = useState("");
  const [cxrComment, setCxrComment] = useState("");
  const [features, setFeatures] = useState({});

  // Review of Systems
  const [ros, setRos] = useState({});
  const toggleRos = (key) => setRos(prev => ({ ...prev, [key]: prev[key] === "safe" ? "unsafe" : prev[key] === "unsafe" ? null : "safe" }));

  // Universal edit state for config mode
  const [editingKey, setEditingKey] = useState(null); // key being edited
  const [editDraft, setEditDraft] = useState({ safe:"", unsafe:"" });

  // ROS custom items per system
  const [rosCustom, setRosCustom] = useState({}); // { systemName: [{safe,unsafe},...] }
  const [rosAddInput, setRosAddInput] = useState({}); // { systemName: {safe,unsafe} }

  // Exam custom items per section
  const [examCustom, setExamCustom] = useState({}); // { sectionKey: [{key,safe,unsafe},...] }
  const [examAddInput, setExamAddInput] = useState({});

  // Custom question builder for presentation history features
  const [customQInput, setCustomQInput] = useState({ safe: "", unsafe: "", isRF: false });

  // Feature label overrides: { key: { safe, unsafe } }
  const getLabel = (key, field, defaultVal) => {
    const ov = userConfig.__overrides?.[key];
    return (ov && ov[field] !== undefined) ? ov[field] : defaultVal;
  };
  const saveOverride = (key, safe, unsafe) => {
    setUserConfig(prev => ({
      ...prev,
      __overrides: { ...(prev.__overrides||{}), [key]: { safe, unsafe } }
    }));
    setEditingKey(null);
  };
  const resetOverride = (key) => {
    setUserConfig(prev => {
      const ov = { ...(prev.__overrides||{}) };
      delete ov[key];
      return { ...prev, __overrides: ov };
    });
  };

  const addRosItem = (system) => {
    const inp = rosAddInput[system];
    if (!inp?.safe?.trim() || !inp?.unsafe?.trim()) return;
    setRosCustom(prev => ({ ...prev, [system]: [...(prev[system]||[]), { safe: inp.safe.trim(), unsafe: inp.unsafe.trim() }] }));
    setRosAddInput(prev => ({ ...prev, [system]: { safe:"", unsafe:"" } }));
  };
  const removeRosItem = (system, idx) => {
    setRosCustom(prev => { const arr=[...(prev[system]||[])]; arr.splice(idx,1); return {...prev,[system]:arr}; });
    setRos(prev => { const n={...prev}; delete n[`custom_${system}_${idx}`]; return n; });
  };

  const addExamItem = (section) => {
    const inp = examAddInput[section];
    if (!inp?.safe?.trim() || !inp?.unsafe?.trim()) return;
    const key = `ex_custom_${section}_${Date.now()}`;
    setExamCustom(prev => ({ ...prev, [section]: [...(prev[section]||[]), { key, safe: inp.safe.trim(), unsafe: inp.unsafe.trim() }] }));
    setExamAddInput(prev => ({ ...prev, [section]: { safe:"", unsafe:"" } }));
  };
  const removeExamItem = (section, key) => {
    setExamCustom(prev => ({ ...prev, [section]: (prev[section]||[]).filter(b=>b.key!==key) }));
    setFeatures(prev => { const n={...prev}; delete n[key]; return n; });
  };
  const addCustomQuestion = (pres) => {
    if (!customQInput.safe.trim() || !customQInput.unsafe.trim()) return;
    const key = `custom_${pres.replace(/\W/g,"_")}_${Date.now()}`;
    // Add to MASTER_FEATURES dynamically
    if (!MASTER_FEATURES[pres]) return;
    MASTER_FEATURES[pres].push({ key, safe: customQInput.safe.trim(), unsafe: customQInput.unsafe.trim(), custom: true });
    // Enable it and optionally mark as red flag
    setUserConfig(prev => {
      const enabled = [...(prev[pres]?.enabled || MASTER_FEATURES[pres].map(f=>f.key).filter(k=>k!==key)), key];
      const redFlags = customQInput.isRF ? [...(prev[pres]?.redFlags||[]), key] : (prev[pres]?.redFlags||[]);
      return { ...prev, [pres]: { ...prev[pres], enabled, redFlags } };
    });
    setCustomQInput({ safe: "", unsafe: "", isRF: false });
  };
  const deleteCustomQuestion = (pres, key) => {
    const idx = MASTER_FEATURES[pres]?.findIndex(f=>f.key===key);
    if (idx > -1) MASTER_FEATURES[pres].splice(idx, 1);
    setUserConfig(prev => ({
      ...prev,
      [pres]: {
        enabled: (prev[pres]?.enabled||[]).filter(k=>k!==key),
        redFlags: (prev[pres]?.redFlags||[]).filter(k=>k!==key),
      }
    }));
  };

  // Social history expanded
  const [packYears, setPackYears] = useState("");
  const [cigsPerDay, setCigsPerDay] = useState("");
  const [smokingYears, setSmokingYears] = useState("");
  const [exSmokingYears, setExSmokingYears] = useState("");
  const [alcoholUnits, setAlcoholUnits] = useState("");
  const [alcoholType, setAlcoholType] = useState("");
  const [drugDetails, setDrugDetails] = useState("");
  // Functional independence drill-down
  const [walkingAid, setWalkingAid] = useState("");
  const [formalSupports, setFormalSupports] = useState("");
  const [stairsInHome, setStairsInHome] = useState("");
  const [livesWithWhom, setLivesWithWhom] = useState("");
  const [independentShower, setIndependentShower] = useState(null);
  const [independentBills, setIndependentBills] = useState(null);
  const [fallsHistory, setFallsHistory] = useState(null);
  const [frailty, setFrailty] = useState(null);
  const [driving, setDriving] = useState(null);
  const [housingInsecurity, setHousingInsecurity] = useState(null);
  const [carerResponsibilities, setCarerResponsibilities] = useState(null);

  // Serial troponins
  const [trop1Result, setTrop1Result] = useState("");
  const [trop1Time, setTrop1Time] = useState("");
  const [trop2Result, setTrop2Result] = useState("");
  const [trop2Time, setTrop2Time] = useState("");
  const [trop2Delta, setTrop2Delta] = useState("");
  const [trop3Result, setTrop3Result] = useState("");
  const [trop3Time, setTrop3Time] = useState("");
  const [trop3Delta, setTrop3Delta] = useState("");

  const pmhxButtons = [
    { key:"pmhx_cad",    safe:"No CAD",           unsafe:"Known CAD" },
    { key:"pmhx_dm",     safe:"No diabetes",      unsafe:"Diabetes" },
    { key:"pmhx_htn",    safe:"No hypertension",  unsafe:"Hypertension" },
    { key:"pmhx_asthma", safe:"No asthma",        unsafe:"Asthma" },
    { key:"pmhx_copd",   safe:"No COPD",          unsafe:"COPD" },
    { key:"pmhx_cancer", safe:"No cancer",        unsafe:"Cancer history" },
    { key:"pmhx_stroke", safe:"No stroke/TIA",    unsafe:"Previous stroke/TIA" },
    { key:"pmhx_af",     safe:"No AF",             unsafe:"Atrial fibrillation" },
  ];
  const socialButtons = [
    { key:"soc_smoker",   safe:"Non-smoker",               unsafe:"Current smoker" },
    { key:"soc_alcohol",  safe:"No excess alcohol",        unsafe:"Excess alcohol" },
    { key:"soc_drugs",    safe:"No illicit drugs",         unsafe:"Illicit drug use" },
    { key:"soc_function", safe:"Functionally independent", unsafe:"Functional dependence" },
  ];
  const examButtons = {
    general: [
      { key:"ex_alert",    safe:"Alert & oriented",          unsafe:"Altered consciousness" },
      { key:"ex_well",     safe:"Appears well",              unsafe:"Appears unwell" },
      { key:"ex_distress", safe:"Not distressed",            unsafe:"In distress" },
      { key:"ex_euvolemic",safe:"Euvolemic",                 unsafe:"Hypo/hypervolemic" },
    ],
    cvs: [
      { key:"ex_hs",      safe:"Heart sounds normal",        unsafe:"Abnormal heart sounds" },
      { key:"ex_murmur",  safe:"No murmur",                  unsafe:"Murmur present" },
      { key:"ex_rhythm",  safe:"Regular rhythm",             unsafe:"Irregular rhythm" },
      { key:"ex_jvp",     safe:"JVP normal",                 unsafe:"JVP elevated" },
      { key:"ex_pulses",  safe:"Peripheral pulses normal",   unsafe:"Peripheral pulses abnormal" },
      { key:"ex_edema",   safe:"No peripheral edema",        unsafe:"Peripheral edema" },
      { key:"ex_cap",     safe:"Cap refill <2s",             unsafe:"Cap refill >2s" },
    ],
    resp: [
      { key:"ex_chest",   safe:"Chest clear bilaterally",    unsafe:"Abnormal breath sounds" },
      { key:"ex_wheeze",  safe:"No wheeze",                  unsafe:"Wheeze" },
      { key:"ex_crackles",safe:"No crackles",                unsafe:"Crackles" },
      { key:"ex_air",     safe:"Air entry equal",            unsafe:"Reduced air entry" },
      { key:"ex_perc",    safe:"Resonant percussion",        unsafe:"Dull/hyperresonant" },
      { key:"ex_wob",     safe:"No increased WOB",           unsafe:"Increased work of breathing" },
      { key:"ex_cyanosis",safe:"No cyanosis",                unsafe:"Cyanosis" },
    ],
    abdo: [
      { key:"ex_soft",    safe:"Soft non-tender",            unsafe:"Peritonism/guarding" },
      { key:"ex_rebound", safe:"No rebound tenderness",      unsafe:"Rebound tenderness" },
      { key:"ex_ruq",     safe:"No RUQ tenderness",          unsafe:"RUQ tenderness/Murphy's+" },
      { key:"ex_rlq",     safe:"No RLQ tenderness",          unsafe:"RLQ tenderness" },
      { key:"ex_cva",     safe:"No CVA tenderness",          unsafe:"CVA tenderness" },
      { key:"ex_aaa",     safe:"No pulsatile mass",          unsafe:"Pulsatile abdominal mass" },
      { key:"ex_bs",      safe:"Bowel sounds normal",        unsafe:"Abnormal bowel sounds" },
      { key:"ex_organs",  safe:"No organomegaly",            unsafe:"Organomegaly" },
    ],
    neuro: [
      { key:"ex_gcs",     safe:"GCS 15/15",                  unsafe:"GCS <15" },
      { key:"ex_cn",      safe:"Cranial nerves intact",      unsafe:"Cranial nerve deficit" },
      { key:"ex_facial",  safe:"No facial droop",            unsafe:"Facial droop" },
      { key:"ex_speech",  safe:"Speech normal",              unsafe:"Speech disturbance" },
      { key:"ex_drift",   safe:"No pronator drift",          unsafe:"Pronator drift" },
      { key:"ex_power",   safe:"Power 5/5 all limbs",        unsafe:"Reduced power" },
      { key:"ex_sensation",safe:"Sensation intact",          unsafe:"Sensory deficit" },
      { key:"ex_reflexes",safe:"Reflexes normal",            unsafe:"Abnormal reflexes" },
      { key:"ex_plantar", safe:"Plantars downgoing",         unsafe:"Upgoing plantar" },
      { key:"ex_meningism",safe:"No meningism",              unsafe:"Meningism present" },
      { key:"ex_coord",   safe:"Coordination normal",        unsafe:"Coordination impaired" },
      { key:"ex_nystagmus",safe:"No nystagmus",              unsafe:"Nystagmus" },
      { key:"ex_gait",    safe:"Gait normal",                unsafe:"Gait abnormal" },
    ],
    msk: [
      { key:"ex_tender",   safe:"No tenderness",             unsafe:"Tenderness" },
      { key:"ex_rom",      safe:"Full ROM",                  unsafe:"Restricted ROM" },
      { key:"ex_swelling", safe:"No swelling",               unsafe:"Swelling" },
      { key:"ex_deformity",safe:"No deformity",              unsafe:"Deformity" },
    ],
  };
  const invButtons = [
    { key:"inv_bgl",    safe:"BGL normal",        unsafe:"BGL abnormal" },
    { key:"inv_trop",   safe:"Troponin negative",  unsafe:"Troponin elevated" },
    { key:"inv_ddimer", safe:"D-dimer normal",     unsafe:"D-dimer elevated" },
    { key:"inv_fbc",    safe:"FBC normal",         unsafe:"FBC abnormal" },
    { key:"inv_ump",    safe:"UMP normal",         unsafe:"UMP abnormal" },
    { key:"inv_lft",    safe:"LFT normal",         unsafe:"LFT abnormal" },
    { key:"inv_crp",    safe:"CRP normal",         unsafe:"CRP elevated" },
    { key:"inv_lactate",safe:"Lactate normal",     unsafe:"Lactate elevated" },
    { key:"inv_lipase", safe:"Lipase normal",      unsafe:"Lipase elevated" },
    { key:"inv_bnp",    safe:"BNP normal",         unsafe:"BNP elevated" },
    { key:"inv_bhcg",   safe:"Beta-hCG negative",  unsafe:"Beta-hCG positive" },
    { key:"inv_ck",     safe:"CK normal",          unsafe:"CK elevated" },
    { key:"inv_inr",    safe:"INR normal",         unsafe:"INR elevated" },
    { key:"inv_urine",  safe:"Urinalysis normal",  unsafe:"Urinalysis abnormal" },
    { key:"inv_cultures",safe:"Cultures pending",  unsafe:"Cultures positive" },
  ];

  const toggleFeature = (key) => {
    setFeatures(prev => {
      const cur = prev[key] || "null";
      const next = cur === "null" ? "safe" : cur === "safe" ? "unsafe" : "null";
      return { ...prev, [key]: next };
    });
  };

  const getButtonClass = (state, isRF, hasCustom) => {
    const base = "text-white text-xs md:text-sm px-3 py-3 md:py-2 rounded transition-all w-full text-left touch-manipulation font-medium";
    if (hasCustom)           return `${base} bg-teal-600 hover:bg-teal-700`;
    if (state === "safe")    return `${base} bg-green-600 hover:bg-green-700`;
    if (state === "unsafe")  return `${base} bg-red-600 hover:bg-red-700`;
    if (isRF)                return `${base} bg-gray-400 hover:bg-gray-500 ring-2 ring-yellow-400`;
    return `${base} bg-gray-500 hover:bg-gray-600`;
  };
  const getBtnText = (btn, state) => {
    const safe   = getLabel(btn.key, "safe",   btn.safe);
    const unsafe = getLabel(btn.key, "unsafe", btn.unsafe);
    if (state === "safe")   return safe;
    if (state === "unsafe") return unsafe;
    return `${safe} / ${unsafe}`;
  };
  const isRedFlag = (key) => {
    if (!presentation || !userConfig[presentation]) return false;
    return (userConfig[presentation].redFlags || []).includes(key);
  };
  const getEnabledFeatures = (pres) => {
    if (!pres || !MASTER_FEATURES[pres]) return [];
    const enabled = userConfig[pres]?.enabled || MASTER_FEATURES[pres].map(f => f.key);
    return MASTER_FEATURES[pres].filter(f => enabled.includes(f.key));
  };

  const Btn = ({ btn, featureState, onToggle }) => {
    const state    = featureState !== undefined ? featureState : (features[btn.key] || "null");
    const toggle   = onToggle || (() => toggleFeature(btn.key));
    const hasCustom = !!(customText[btn.key]);
    const isRF     = isRedFlag(btn.key);
    const nested   = NESTED_FEATURES[btn.key];
    const showNested = nested && state === "unsafe";

    const handlePress = () => {
      cancelLongPress();
      if (lpEditingKey === btn.key) return; // don't toggle while editing
      toggle();
    };

    return (
      <div className={showNested ? "col-span-2 md:col-span-3" : ""}>
        {/* Main button */}
        <button
          type="button"
          onClick={handlePress}
          onMouseDown={() => startLongPress(btn.key)}
          onMouseUp={cancelLongPress}
          onMouseLeave={cancelLongPress}
          onTouchStart={() => startLongPress(btn.key)}
          onTouchEnd={() => { cancelLongPress(); }}
          className={getButtonClass(state, isRF, hasCustom)}
        >
          {hasCustom ? customText[btn.key] : getBtnText(btn, state)}
        </button>

        {/* Inline custom text editor  shown when long-pressed */}
        {lpEditingKey === btn.key && (
          <div className="mt-1 flex gap-1">
            <input
              autoFocus
              type="text"
              defaultValue={customText[btn.key] || ""}
              placeholder="Type custom label..."
              className="flex-1 px-2 py-1.5 border border-teal-400 rounded text-xs"
              autoCorrect="off" autoCapitalize="none" spellCheck="false"
              onKeyDown={e => {
                if (e.key === "Enter") {
                  const val = e.target.value.trim();
                  setCustomText(prev => val ? {...prev, [btn.key]: val} : Object.fromEntries(Object.entries(prev).filter(([k])=>k!==btn.key)));
                  if (val && state === "null") toggle(); // activate button
                  setLpEditingKey(null);
                }
                if (e.key === "Escape") setLpEditingKey(null);
              }}
            />
            <button
              type="button"
              className="px-2 py-1 bg-teal-600 text-white rounded text-xs"
              onClick={e => {
                const inp = e.currentTarget.previousSibling;
                const val = inp.value.trim();
                setCustomText(prev => val ? {...prev, [btn.key]: val} : Object.fromEntries(Object.entries(prev).filter(([k])=>k!==btn.key)));
                if (val && state === "null") toggle();
                setLpEditingKey(null);
              }}
            ></button>
            <button type="button" className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs"
              onClick={() => { setCustomText(prev => { const n={...prev}; delete n[btn.key]; return n; }); setLpEditingKey(null); }}></button>
          </div>
        )}

        {/* Nested child buttons */}
        {showNested && (
          <div className="mt-2 ml-2 pl-2 border-l-2 border-red-300 grid grid-cols-2 md:grid-cols-3 gap-1.5">
            {nested.map(child => {
              const cs = childFeatures[child.key] || "null";
              return (
                <button key={child.key} type="button"
                  onClick={() => toggleChild(child.key)}
                  onMouseDown={() => startLongPress(child.key)}
                  onMouseUp={cancelLongPress}
                  onMouseLeave={cancelLongPress}
                  onTouchStart={() => startLongPress(child.key)}
                  onTouchEnd={cancelLongPress}
                  className={getButtonClass(cs, false, !!(customText[child.key]))}>
                  {customText[child.key] || getBtnText(child, cs)}
                </button>
              );
            })}
          </div>
        )}
      </div>
    );
  };

  const generateReport = () => {
    const lines = [];
    const add = (l) => lines.push(l);
    const blank = () => lines.push("");
    // Demographics header  bed and initials intentionally excluded from report
    const demoParts = [];
    if (patientAge) demoParts.push(`${patientAge}yo`);
    if (patientSex) demoParts.push(patientSex);
    if (demoParts.length > 0) { add(demoParts.join("  ")); blank(); }
    const ef = getEnabledFeatures(presentation);
    const historyFindings = ef.filter(f => (features[f.key]||"null") !== "null")
      .map(f => {
        if (customText[f.key]) return customText[f.key];
        return features[f.key] === "safe" ? f.safe : f.unsafe;
      });
    add("PRESENTING COMPLAINT");
    if (presentation) add(`  ${presentation}`);
    if (hopc.trim()) add(`  ${hopc.trim()}`);
    historyFindings.forEach(f => add(`  ${f}`));
    // Add any child feature findings (nested from feature toggles)
    Object.entries(childFeatures).filter(([,v])=>v!=="null").forEach(([key,state]) => {
      const allChildren = Object.values(NESTED_FEATURES).flat();
      const child = allChildren.find(c=>c.key===key);
      if (child) {
        const txt = customText[key] || (state==="safe" ? child.safe : child.unsafe);
        add(`    ${txt}`);
      }
    });
    blank();

    // Review of Systems - build safeunsafe lookup then output correct text
    const rosLookup = {
      "No weight loss":"Weight loss","No weight gain":"Weight gain","No fatigue":"Fatigue","Afebrile":"Fever/chills",
      "No night sweats":"Night sweats","Sleeping well":"Insomnia","No chronic pain":"Chronic pain",
      "Vision normal":"Vision change",
      "No double vision":"Double vision","No red eye":"Red eye","No eye discharge":"Eye discharge",
      "Hearing normal":"Hearing change","No ear pain/discharge":"Ear pain/discharge","No nasal congestion":"Nasal congestion",
      "No sore throat":"Sore throat","Voice normal":"Hoarseness","No mouth sores":"Mouth sores","No dysphagia":"Dysphagia",
      "No chest pain":"Chest pain","No palpitations":"Palpitations","No orthopnea":"Orthopnea","No PND":"PND",
      "No leg edema":"Leg edema","No claudication":"Claudication","No syncope":"Syncope",
      "No dyspnea at rest":"Dyspnea at rest","No dyspnea on exertion":"Dyspnea on exertion",
      "No cough":"Cough","No haemoptysis":"Haemoptysis","No wheeze":"Wheeze","No snoring":"Snoring",
      "No heartburn":"Heartburn","No abdominal pain":"Abdominal pain","No nausea/vomiting":"Nausea/vomiting",
      "No difficulty swallowing":"Dysphagia","No melaena":"Melaena","No PR bleeding":"PR bleeding",
      "No diarrhea":"Diarrhea","No constipation":"Constipation","No jaundice":"Jaundice",
      "No haematuria":"Haematuria","No dysuria":"Dysuria","No nocturia":"Nocturia","No incontinence":"Incontinence",
      "No incomplete emptying":"Incomplete emptying","Normal urinary frequency":"Urinary frequency","No urinary urgency":"Urinary urgency",
      "No joint pain/swelling":"Joint pain/swelling","No muscle ache":"Muscle ache","No back pain":"Back pain",
      "No knee pain":"Knee pain","No shoulder pain":"Shoulder pain","No hip pain":"Hip pain",
      "No rash":"Rash","No hair loss":"Hair loss","No skin growths":"Skin growths",
      "No non-healing sores":"Non-healing sores","No itching":"Itching",
      "No headache":"Headache","No dizziness":"Dizziness","No numbness/tingling":"Numbness/tingling",
      "No weakness":"Weakness","No balance problems":"Balance problems","No seizures":"Seizures","No sudden neuro deficit":"Sudden neuro deficit",
      "Mood normal":"Low mood/depression","No anxiety":"Anxiety","Memory intact":"Memory problems","No suicidal ideation":"Suicidal ideation","No substance use":"Substance use",
      "No polyuria":"Polyuria","No polydipsia":"Polydipsia","No polyphagia":"Polyphagia",
      "No heat/cold intolerance":"Heat/cold intolerance","Weight stable":"Weight change",
      "No abnormal bleeding/bruising":"Abnormal bleeding/bruising","No new lumps/bumps":"New lumps/bumps",
      "No recurrent infections":"Recurrent infections","No hypercoagulability":"Hypercoagulability",
      "No seasonal allergies":"Seasonal allergies","No food allergies":"Food allergies",
      "No frequent infections":"Frequent infections","No autoimmune symptoms":"Autoimmune symptoms","No unusual drug reactions":"Unusual drug reactions",
    };
    const rosEntries = Object.entries(ros).filter(([,v])=>v==="safe"||v==="unsafe");
    if (rosEntries.length > 0) {
      add("REVIEW OF SYSTEMS");
      rosEntries.forEach(([safeKey, state]) => {
        const rKey = `ros__${safeKey}`;
        const text = state === "safe"
          ? getLabel(rKey,"safe", rosLookup[safeKey] ? safeKey : safeKey)
          : getLabel(rKey,"unsafe", rosLookup[safeKey] || safeKey);
        add(`  ${text}`);
      });
      blank();
    }

    if (noRegularMeds || medications.trim()) {
      add("MEDICATIONS");
      add(noRegularMeds ? "  No regular medications" : `  ${medications.trim()}`);
      blank();
    }
    if (nkda || allergies.trim()) {
      add("ALLERGIES");
      add(nkda ? "  NKDA" : `  ${allergies.trim()}`);
      blank();
    }

    // PMHx
    const pmhxF = pmhxButtons.filter(b => (features[b.key]||"null") !== "null")
      .map(b => features[b.key] === "safe" ? b.safe : b.unsafe);
    if (nsmh || pmhxF.length > 0 || pmhx.trim()) {
      add("MEDICAL HISTORY");
      if (nsmh) add("  No significant medical history");
      pmhxF.forEach(f => add(`  ${f}`));
      if (pmhx.trim()) add(`  ${pmhx.trim()}`);
      blank();
    }

    // Social history (expanded)
    const socLines = [];
    const smoker = features["soc_smoker"];
    const alcohol = features["soc_alcohol"];
    const drugs = features["soc_drugs"];
    const functional = features["soc_function"];
    if (smoker === "safe") socLines.push("Non-smoker");
    if (smoker === "unsafe") {
      let s = "Current smoker";
      if (cigsPerDay) s += `, ${cigsPerDay} cigarettes/day`;
      if (smokingYears) s += `, ${smokingYears} years`;
      if (packYears) s += ` (${packYears} pack years)`;
      socLines.push(s);
    }
    if (exSmokingYears) socLines.push(`Ex-smoker, stopped ${exSmokingYears} years ago` + (packYears ? ` (${packYears} pack years)` : ""));
    if (alcohol === "safe") socLines.push("No excess alcohol");
    if (alcohol === "unsafe") {
      let a = "Alcohol use";
      if (alcoholUnits) a += `: ${alcoholUnits} standard drinks/week`;
      if (alcoholType) a += ` (${alcoholType})`;
      socLines.push(a);
    }
    if (drugs === "safe") socLines.push("No illicit drugs");
    if (drugs === "unsafe") { socLines.push("Illicit/recreational drug use" + (drugDetails ? `: ${drugDetails}` : "")); }
    if (functional === "safe") socLines.push("Functionally independent");
    if (functional === "unsafe") {
      socLines.push("Functional dependence");
      if (livesWithWhom) socLines.push(`  Lives with: ${livesWithWhom}`);
      if (walkingAid) socLines.push(`  Mobility aid: ${walkingAid}`);
      if (stairsInHome) socLines.push(`  Stairs in home: ${stairsInHome}`);
      if (formalSupports) socLines.push(`  Formal supports: ${formalSupports}`);
      if (independentShower !== null) socLines.push(`  Showers independently: ${independentShower ? "Yes" : "No"}`);
      if (independentBills !== null) socLines.push(`  Manages own finances: ${independentBills ? "Yes" : "No"}`);
      if (fallsHistory !== null) socLines.push(`  Falls in last 12 months: ${fallsHistory ? "Yes" : "No"}`);
      if (frailty !== null) socLines.push(`  Frailty: ${frailty ? "Present" : "Not identified"}`);
      if (driving !== null) socLines.push(`  Driving: ${driving ? "Currently driving" : "Not driving"}`);
    }
    if (housingInsecurity) socLines.push("Housing insecurity");
    if (carerResponsibilities) socLines.push("Carer responsibilities");
    if (socLines.length > 0) { add("SOCIAL HISTORY"); socLines.forEach(f => add(`  ${f}`)); blank(); }

    const examLines = [];
    if (temp) examLines.push(`Temperature: ${temp}C`);
    if (bp || dbp) examLines.push(`BP: ${bp||"?"}/${dbp||"?"} mmHg`);
    if (hr) examLines.push(`HR: ${hr} bpm`);
    if (rr) examLines.push(`RR: ${rr} /min`);
    if (spo2) examLines.push(`SpO2: ${spo2}%`);
    Object.entries(examButtons).forEach(([sectionKey, btns]) => {
      const allBtns = [...btns, ...(examCustom[sectionKey]||[])];
      allBtns.forEach(b => {
        const s = features[b.key] || "null";
        if (s === "null") return;
        // Use custom text if set, otherwise default label
        if (customText[b.key]) {
          examLines.push(customText[b.key]);
        } else if (s === "safe") {
          examLines.push(getLabel(b.key,"safe",b.safe));
        } else {
          examLines.push(getLabel(b.key,"unsafe",b.unsafe));
        }
        // Add child features nested under this exam button
        if (s === "unsafe" && NESTED_FEATURES[b.key]) {
          NESTED_FEATURES[b.key].forEach(child => {
            const cs = childFeatures[child.key] || "null";
            if (cs === "null") return;
            const ctxt = customText[child.key] || (cs==="safe" ? child.safe : child.unsafe);
            examLines.push(`  ${ctxt}`);
          });
        }
      });
    });
    if (examLines.length > 0) { add("EXAMINATION"); examLines.forEach(f => add(`  ${f}`)); blank(); }

    const invLines = [];
    // Serial troponins
    if (trop1Result || trop1Time) invLines.push(`Troponin 1: ${trop1Result||"pending"}${trop1Time ? ` (${trop1Time})` : ""}`);
    if (trop2Result || trop2Time) invLines.push(`Troponin 2: ${trop2Result||"pending"}${trop2Time ? ` (${trop2Time})` : ""}${trop2Delta ? `  ${trop2Delta}` : ""}`);
    if (trop3Result || trop3Time) invLines.push(`Troponin 3: ${trop3Result||"pending"}${trop3Time ? ` (${trop3Time})` : ""}${trop3Delta ? `  ${trop3Delta}` : ""}`);
    // Other inv buttons (skip old single troponin)
    invButtons.filter(b => b.key !== "inv_trop").forEach(b => { const s = features[b.key]||"null"; if (s==="safe") invLines.push(b.safe); if(s==="unsafe") invLines.push(b.unsafe); });
    if (features["inv_ecg"]==="safe") invLines.push("ECG normal"+(ecgComment?`: ${ecgComment}`:""));
    else if (features["inv_ecg"]==="unsafe") invLines.push("ECG abnormal"+(ecgComment?`: ${ecgComment}`:""));
    else if (ecgComment) invLines.push(`ECG: ${ecgComment}`);
    if (features["inv_cxr"]==="safe") invLines.push("CXR normal"+(cxrComment?`: ${cxrComment}`:""));
    else if (features["inv_cxr"]==="unsafe") invLines.push("CXR abnormal"+(cxrComment?`: ${cxrComment}`:""));
    else if (cxrComment) invLines.push(`CXR: ${cxrComment}`);
    if (invLines.length > 0) { add("INVESTIGATIONS"); invLines.forEach(f => add(`  ${f}`)); blank(); }
    if (diagnosis.trim()) { add("DIAGNOSIS"); add(`  ${diagnosis.trim()}`); blank(); }
    if (plan.trim()) { add("PLAN"); add(`  ${plan.trim()}`); }
    return lines.join("\n") || "[No data entered]";
  };

  const generateAI = async () => {
    setAiError("");
    const storedKey = localStorage.getItem("cat_api_key") || "";
    if (!storedKey) { setShowKeyInput(true); return; }
    setIsGenerating(true);
    setOutput("");
    const reportData = generateReport();
    try {
      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-api-key": storedKey,
          "anthropic-version": "2023-06-01",
          "anthropic-dangerous-direct-browser-access": "true",
        },
        body: JSON.stringify({
          model: "claude-3-5-haiku-20241022",
          max_tokens: 1000,
          messages: [{ role: "user", content: "Write a clinical note in flowing prose paragraphs. Use ONLY this data:\n\n" + reportData }]
        })
      });
      const json = await res.json();
      const text = json?.content?.filter(b => b.type === "text").map(b => b.text).join("\n\n");
      if (text) { setOutput(text); }
      else {
        if (res.status === 401) { localStorage.removeItem("cat_api_key"); setShowKeyInput(true); setAiError("Invalid API key  please re-enter."); }
        else { throw new Error(json?.error?.message || JSON.stringify(json).slice(0,300)); }
      }
    } catch (e) { setAiError(e.message || "Network error"); setOutput(reportData); }
    finally { setIsGenerating(false); }
  };

  const submitApiKey = () => {
    const key = apiKeyInput.trim();
    if (!key) { setAiError("Please enter a key."); return; }
    localStorage.setItem("cat_api_key", key);
    setApiKeyInput(""); setShowKeyInput(false); setAiError("");
    generateAI();
  };
  const copyNote = () => {
    if(!output){alert("Generate a note first!");return;}
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(output).then(()=>alert("Copied!")).catch(()=>fallbackCopy(output));
    } else {
      fallbackCopy(output);
    }
  };
  const fallbackCopy = (text) => {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.cssText = "position:fixed;top:0;left:0;opacity:0;";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try { document.execCommand("copy"); alert("Copied!"); }
    catch { alert("Copy failed  use Download instead."); }
    document.body.removeChild(ta);
  };
  const emailNote = () => {
    if(!output){alert("Generate a note first!");return;}
    if(output.length>1500 && !confirm("Note may be truncated. Use Download instead?\n\nCancel to email anyway.")) return;
    const a = document.createElement("a");
    const subjectParts = [];
    if (bedNumber) subjectParts.push(`Bed ${bedNumber}`);
    if (patientInitials) subjectParts.push(patientInitials);
    if (presentation) subjectParts.push(presentation);
    const subject = subjectParts.length > 0 ? subjectParts.join("  ") : "Clinical Assessment";
    a.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${output.replace(/\n\n/g,"%0D%0A%0D%0A%0D%0A").replace(/\n/g,"%0D%0A%0D%0A")}`;
    a.style.display="none"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };
  const downloadNote = () => {
    if(!output){alert("Generate a note first!");return;}
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([output],{type:"text/plain"}));
    a.download = `${(presentation||"Clinical").replace(/[/\\]/g,"_")}_${new Date().toISOString().split("T")[0]}.txt`;
    a.click();
  };

  const toggleEnabled = (pres, key) => setUserConfig(prev => {
    const cur = prev[pres]?.enabled || MASTER_FEATURES[pres].map(f=>f.key);
    const next = cur.includes(key) ? cur.filter(k=>k!==key) : [...cur, key];
    return {...prev, [pres]: {...prev[pres], enabled: next}};
  });
  const toggleRedFlag = (pres, key) => setUserConfig(prev => {
    const cur = prev[pres]?.redFlags || [];
    const next = cur.includes(key) ? cur.filter(k=>k!==key) : [...cur, key];
    return {...prev, [pres]: {...prev[pres], redFlags: next}};
  });
  const resetConfig = (pres) => setUserConfig(prev => ({...prev, [pres]: {enabled: MASTER_FEATURES[pres].map(f=>f.key), redFlags:[]}}));
  const enableAll = (pres) => setUserConfig(prev => ({...prev, [pres]: {...prev[pres], enabled: MASTER_FEATURES[pres].map(f=>f.key)}}));
  const disableAll = (pres) => setUserConfig(prev => ({...prev, [pres]: {...prev[pres], enabled: []}}));

  const VitalGrid = ({ label, values, current, setter, colorFn }) => (
    <div className="mb-4">
      <div className="flex items-center justify-between mb-1">
        <span className="text-sm font-semibold text-gray-700">{label}</span>
        {current ? <span className={`text-sm font-bold px-2 py-0.5 rounded ${colorFn(current)}`}>{current}</span>
          : <span className="text-xs text-gray-400">not set</span>}
      </div>
      <div className="flex flex-wrap gap-1">
        {values.map(v => (
          <button key={v} type="button" onClick={() => setter(current === v ? "" : v)}
            className={`px-2 py-1.5 rounded text-xs font-medium transition-all ${colorFn(v).replace("100","200").replace("700","800")} hover:opacity-80 ${current===v?"ring-2 ring-offset-1 ring-gray-700 scale-110":""}`}>
            {v}
          </button>
        ))}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-100 pb-20">
      <div className="max-w-5xl mx-auto p-3">

        {/* Header */}
        <div className="bg-white rounded-lg shadow-sm p-3 mb-3 flex items-center justify-between">
          <div>
            <h1 className="text-xl font-bold text-slate-800">Clinical Assessment Tool</h1>
            <p className="text-xs text-slate-500">120 presentations  clinician-configured</p>
          </div>
          <div className="flex gap-2">
            <button onClick={() => setMode("assess")}
              className={`px-4 py-2 rounded text-sm font-medium ${mode==="assess"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
              Assess
            </button>
            <button onClick={() => setMode("configure")}
              className={`px-4 py-2 rounded text-sm font-medium ${mode==="configure"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
               Configure
            </button>
          </div>
        </div>

        {/* CONFIGURE MODE */}
        {mode === "configure" && (
          <div className="bg-white rounded-lg shadow-sm p-4">
            <h2 className="text-lg font-bold mb-1">Configure</h2>
            <p className="text-xs text-gray-500 mb-3">Edit labels, enable/disable features, set red flags. <strong>These reflect YOUR clinical preferences  not endorsed guidelines.</strong></p>

            {/* Tabs */}
            <div className="flex gap-2 mb-4 border-b">
              {[["presentation","Presentations"],["ros","Review of Systems"],["exam","Examination"]].map(([tab,label]) => (
                <button key={tab} onClick={()=>setConfigTab(tab)}
                  className={`px-3 py-2 text-sm font-medium border-b-2 transition-colors ${configTab===tab?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`}>
                  {label}
                </button>
              ))}
            </div>

            {/* PRESENTATION TAB */}
            {configTab === "presentation" && (<>
            <div className="grid grid-cols-2 gap-2 mb-4">
              <div>
                <label className="block text-xs font-semibold mb-1 text-gray-600">Category</label>
                <select value={configCategory} onChange={e => { setConfigCategory(e.target.value); setConfigPresentation(CATEGORIES[e.target.value][0]); }}
                  className="w-full px-3 py-2 border rounded text-sm">
                  {Object.keys(CATEGORIES).map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold mb-1 text-gray-600">Presentation</label>
                <select value={configPresentation} onChange={e => setConfigPresentation(e.target.value)}
                  className="w-full px-3 py-2 border rounded text-sm">
                  {CATEGORIES[configCategory].map(p => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>
            </div>
            <div className="flex gap-2 mb-4 flex-wrap">
              <button onClick={() => enableAll(configPresentation)} className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium hover:bg-blue-200">Enable All</button>
              <button onClick={() => disableAll(configPresentation)} className="px-3 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium hover:bg-gray-200">Disable All</button>
              <button onClick={() => resetConfig(configPresentation)} className="px-3 py-1 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Reset</button>
              <span className="text-xs text-gray-500 self-center ml-auto">{userConfig[configPresentation]?.redFlags?.length||0} red flags set</span>
            </div>
            <div className="border rounded overflow-hidden">
              <div className="grid grid-cols-12 bg-gray-100 px-3 py-2 text-xs font-semibold text-gray-600">
                <div className="col-span-1">Show</div>
                <div className="col-span-4">Safe state</div>
                <div className="col-span-4">Unsafe state</div>
                <div className="col-span-2 text-center">Edit</div>
                <div className="col-span-1 text-center"></div>
              </div>
              {(MASTER_FEATURES[configPresentation]||[]).map(f => {
                const isEnabled = (userConfig[configPresentation]?.enabled || MASTER_FEATURES[configPresentation].map(x=>x.key)).includes(f.key);
                const isRF = (userConfig[configPresentation]?.redFlags||[]).includes(f.key);
                const curSafe   = getLabel(f.key,"safe",f.safe);
                const curUnsafe = getLabel(f.key,"unsafe",f.unsafe);
                const isEditing = editingKey === f.key;
                const hasOverride = !!(userConfig.__overrides?.[f.key]);
                return (
                  <div key={f.key} className={`border-t ${isEnabled?"":"opacity-40"}`}>
                    <div className="grid grid-cols-12 px-3 py-2 items-center">
                      <div className="col-span-1"><input type="checkbox" checked={isEnabled} onChange={()=>toggleEnabled(configPresentation,f.key)} className="w-4 h-4 cursor-pointer"/></div>
                      <div className="col-span-4 text-green-700 font-medium text-xs">{curSafe}{hasOverride && <span className="ml-1 text-gray-400 text-xs"></span>}</div>
                      <div className="col-span-4 text-red-700 text-xs">{curUnsafe}</div>
                      <div className="col-span-2 flex gap-1 justify-center">
                        <button onClick={()=>{ setEditingKey(isEditing?null:f.key); setEditDraft({safe:curSafe,unsafe:curUnsafe}); }}
                          className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                          {isEditing?"":""}
                        </button>
                        {hasOverride && <button onClick={()=>resetOverride(f.key)} className="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs hover:bg-gray-200" title="Reset to factory"></button>}
                      </div>
                      <div className="col-span-1 flex justify-center"><input type="checkbox" checked={isRF} disabled={!isEnabled} onChange={()=>toggleRedFlag(configPresentation,f.key)} className="w-4 h-4 cursor-pointer accent-red-500"/></div>
                    </div>
                    {isEditing && (
                      <div className="px-3 pb-3 bg-blue-50 border-t">
                        <div className="grid grid-cols-2 gap-2 mt-2">
                          <div>
                            <label className="text-xs font-semibold text-green-700 block mb-1">Safe state</label>
                            <input type="text" value={editDraft.safe} onChange={e=>setEditDraft(p=>({...p,safe:e.target.value}))} className="w-full px-2 py-1.5 border rounded text-sm"/>
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-red-700 block mb-1">Unsafe state</label>
                            <input type="text" value={editDraft.unsafe} onChange={e=>setEditDraft(p=>({...p,unsafe:e.target.value}))} className="w-full px-2 py-1.5 border rounded text-sm"/>
                          </div>
                        </div>
                        <div className="flex justify-end gap-2 mt-2">
                          <button onClick={()=>setEditingKey(null)} className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs">Cancel</button>
                          <button onClick={()=>saveOverride(f.key,editDraft.safe,editDraft.unsafe)} disabled={!editDraft.safe.trim()||!editDraft.unsafe.trim()} className="px-3 py-1 bg-blue-600 text-white rounded text-xs disabled:opacity-40">Save</button>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Custom question builder */}
            <div className="mt-4 border border-dashed border-blue-300 rounded-lg p-3 bg-blue-50">
              <h3 className="text-sm font-semibold text-blue-800 mb-1"> Add custom question</h3>
              <p className="text-xs text-gray-500 mb-3">Type the safe and unsafe states for your question. It will be added to this presentation.</p>
              <div className="grid grid-cols-2 gap-2 mb-2">
                <div>
                  <label className="text-xs font-semibold text-green-700 block mb-1">Safe state (green)</label>
                  <input type="text" value={customQInput.safe} onChange={e=>setCustomQInput(p=>({...p,safe:e.target.value}))}
                    placeholder="e.g. No haemoptysis" className="w-full px-2 py-2 border rounded text-sm"/>
                </div>
                <div>
                  <label className="text-xs font-semibold text-red-700 block mb-1">Unsafe state (red)</label>
                  <input type="text" value={customQInput.unsafe} onChange={e=>setCustomQInput(p=>({...p,unsafe:e.target.value}))}
                    placeholder="e.g. Haemoptysis" className="w-full px-2 py-2 border rounded text-sm"/>
                </div>
              </div>
              <div className="flex items-center justify-between">
                <label className="flex items-center gap-2 text-sm cursor-pointer">
                  <input type="checkbox" checked={customQInput.isRF} onChange={e=>setCustomQInput(p=>({...p,isRF:e.target.checked}))}
                    className="w-4 h-4 accent-red-500"/>
                  <span className="text-gray-700">Mark as red flag </span>
                </label>
                <button onClick={() => addCustomQuestion(configPresentation)}
                  disabled={!customQInput.safe.trim() || !customQInput.unsafe.trim()}
                  className="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 disabled:opacity-40 disabled:cursor-not-allowed">
                  Add question
                </button>
              </div>
              {/* List existing custom questions for this presentation */}
              {(MASTER_FEATURES[configPresentation]||[]).filter(f=>f.custom).length > 0 && (
                <div className="mt-3 border-t pt-2">
                  <p className="text-xs font-semibold text-gray-500 mb-2">Custom questions for this presentation:</p>
                  {(MASTER_FEATURES[configPresentation]||[]).filter(f=>f.custom).map(f => (
                    <div key={f.key} className="flex items-center justify-between py-1 text-xs">
                      <span><span className="text-green-700 font-medium">{f.safe}</span> / <span className="text-red-700">{f.unsafe}</span></span>
                      <button onClick={() => deleteCustomQuestion(configPresentation, f.key)}
                        className="ml-2 px-2 py-0.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs">
                        Remove
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <p className="text-xs text-gray-400 mt-3 italic">Saved automatically. Red flags reflect your personal clinical preferences only.</p>
            <button onClick={() => setMode("assess")} className="mt-4 w-full py-3 bg-blue-600 text-white rounded font-medium hover:bg-blue-700"> Done  Go to Assessment</button>
            </>)}

            {/* ROS TAB */}
            {configTab === "ros" && (<>
              <p className="text-xs text-gray-500 mb-3">Edit existing ROS items or add new ones to any system. Changes apply immediately in the assessment.</p>
              {[
                ["Constitutional",    [["No weight loss","Weight loss"],["No weight gain","Weight gain"],["No fatigue","Fatigue"],["Afebrile","Fever/chills"],["No night sweats","Night sweats"],["Sleeping well","Insomnia"],["No chronic pain","Chronic pain"]]],
                ["Eyes",              [["Vision normal","Vision change"],["No double vision","Double vision"],["No red eye","Red eye"],["No eye discharge","Eye discharge"]]],
                ["Ears/Nose/Throat",  [["Hearing normal","Hearing change"],["No ear pain/discharge","Ear pain/discharge"],["No nasal congestion","Nasal congestion"],["No sore throat","Sore throat"],["Voice normal","Hoarseness"],["No mouth sores","Mouth sores"],["No dysphagia","Dysphagia"]]],
                ["Cardiovascular",    [["No chest pain","Chest pain"],["No palpitations","Palpitations"],["No orthopnea","Orthopnea"],["No PND","PND"],["No leg edema","Leg edema"],["No claudication","Claudication"],["No syncope","Syncope"]]],
                ["Respiratory",       [["No dyspnea at rest","Dyspnea at rest"],["No dyspnea on exertion","Dyspnea on exertion"],["No cough","Cough"],["No haemoptysis","Haemoptysis"],["No wheeze","Wheeze"],["No snoring","Snoring"]]],
                ["Gastrointestinal",  [["No heartburn","Heartburn"],["No abdominal pain","Abdominal pain"],["No nausea/vomiting","Nausea/vomiting"],["No difficulty swallowing","Dysphagia"],["No haematemesis","Haematemesis"],["No melaena","Melaena"],["No PR bleeding","PR bleeding"],["No diarrhea","Diarrhea"],["No constipation","Constipation"],["No jaundice","Jaundice"]]],
                ["Genitourinary",     [["No haematuria","Haematuria"],["No dysuria","Dysuria"],["No nocturia","Nocturia"],["No incontinence","Incontinence"],["No incomplete emptying","Incomplete emptying"],["Normal urinary frequency","Urinary frequency"],["No urinary urgency","Urinary urgency"]]],
                ["Musculoskeletal",   [["No joint pain/swelling","Joint pain/swelling"],["No muscle ache","Muscle ache"],["No back pain","Back pain"],["No knee pain","Knee pain"],["No shoulder pain","Shoulder pain"],["No hip pain","Hip pain"]]],
                ["Skin",              [["No rash","Rash"],["No hair loss","Hair loss"],["No skin growths","Skin growths"],["No non-healing sores","Non-healing sores"],["No itching","Itching"]]],
                ["Neurological",      [["No headache","Headache"],["No dizziness","Dizziness"],["No numbness/tingling","Numbness/tingling"],["No weakness","Weakness"],["No balance problems","Balance problems"],["No seizures","Seizures"],["No sudden neuro deficit","Sudden neuro deficit"]]],
                ["Psychiatric",       [["Mood normal","Low mood/depression"],["No anxiety","Anxiety"],["Memory intact","Memory problems"],["No suicidal ideation","Suicidal ideation"],["No substance use","Substance use"]]],
                ["Endocrine",         [["No polyuria","Polyuria"],["No polydipsia","Polydipsia"],["No polyphagia","Polyphagia"],["No heat/cold intolerance","Heat/cold intolerance"],["Weight stable","Weight change"]]],
                ["Haematological",    [["No abnormal bleeding/bruising","Abnormal bleeding/bruising"],["No new lumps/bumps","New lumps/bumps"],["No recurrent infections","Recurrent infections"],["No hypercoagulability","Hypercoagulability"]]],
                ["Allergic/Immunological",[["No seasonal allergies","Seasonal allergies"],["No food allergies","Food allergies"],["No frequent infections","Frequent infections"],["No autoimmune symptoms","Autoimmune symptoms"],["No unusual drug reactions","Unusual drug reactions"]]],
              ].map(([system, pairs]) => (
                <div key={system} className="mb-4 border rounded p-3">
                  <h3 className="text-sm font-bold text-gray-700 mb-2">{system}</h3>
                  {/* Existing items */}
                  {pairs.map(([safe,unsafe]) => {
                    const rKey = `ros__${safe}`;
                    const isEditing = editingKey === rKey;
                    const curSafe = getLabel(rKey,"safe",safe);
                    const curUnsafe = getLabel(rKey,"unsafe",unsafe);
                    const hasOv = !!(userConfig.__overrides?.[rKey]);
                    return (
                      <div key={safe} className="mb-1">
                        <div className="flex items-center gap-2">
                          <span className="text-green-700 text-xs font-medium w-40 truncate">{curSafe}</span>
                          <span className="text-gray-400 text-xs">/</span>
                          <span className="text-red-700 text-xs flex-1 truncate">{curUnsafe}</span>
                          <button onClick={()=>{ setEditingKey(isEditing?null:rKey); setEditDraft({safe:curSafe,unsafe:curUnsafe}); }} className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{isEditing?"":""}</button>
                          {hasOv && <button onClick={()=>resetOverride(rKey)} className="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs"></button>}
                        </div>
                        {isEditing && (
                          <div className="mt-1 p-2 bg-blue-50 rounded">
                            <div className="grid grid-cols-2 gap-2 mb-2">
                              <input type="text" value={editDraft.safe} onChange={e=>setEditDraft(p=>({...p,safe:e.target.value}))} placeholder="Safe state" className="px-2 py-1 border rounded text-xs"/>
                              <input type="text" value={editDraft.unsafe} onChange={e=>setEditDraft(p=>({...p,unsafe:e.target.value}))} placeholder="Unsafe state" className="px-2 py-1 border rounded text-xs"/>
                            </div>
                            <div className="flex justify-end gap-2">
                              <button onClick={()=>setEditingKey(null)} className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">Cancel</button>
                              <button onClick={()=>saveOverride(rKey,editDraft.safe,editDraft.unsafe)} className="px-2 py-1 bg-blue-600 text-white rounded text-xs">Save</button>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                  {/* Custom ROS items for this system */}
                  {(rosCustom[system]||[]).map((item,idx) => (
                    <div key={idx} className="flex items-center gap-2 mb-1">
                      <span className="text-green-700 text-xs w-40 truncate">{item.safe}</span>
                      <span className="text-gray-400 text-xs">/</span>
                      <span className="text-red-700 text-xs flex-1 truncate">{item.unsafe}</span>
                      <button onClick={()=>removeRosItem(system,idx)} className="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs"></button>
                    </div>
                  ))}
                  {/* Add new ROS item */}
                  <div className="mt-2 pt-2 border-t border-dashed flex gap-2 items-end">
                    <div className="flex-1">
                      <input type="text" value={rosAddInput[system]?.safe||""} onChange={e=>setRosAddInput(p=>({...p,[system]:{...(p[system]||{}),safe:e.target.value}}))}
                        placeholder="Safe state" className="w-full px-2 py-1 border rounded text-xs mb-1"/>
                      <input type="text" value={rosAddInput[system]?.unsafe||""} onChange={e=>setRosAddInput(p=>({...p,[system]:{...(p[system]||{}),unsafe:e.target.value}}))}
                        placeholder="Unsafe state" className="w-full px-2 py-1 border rounded text-xs"/>
                    </div>
                    <button onClick={()=>addRosItem(system)} disabled={!rosAddInput[system]?.safe?.trim()||!rosAddInput[system]?.unsafe?.trim()}
                      className="px-2 py-1 bg-blue-600 text-white rounded text-xs disabled:opacity-40 mb-0"> Add</button>
                  </div>
                </div>
              ))}
              <button onClick={() => setMode("assess")} className="mt-2 w-full py-3 bg-blue-600 text-white rounded font-medium hover:bg-blue-700"> Done  Go to Assessment</button>
            </>)}

            {/* EXAM TAB */}
            {configTab === "exam" && (<>
              <p className="text-xs text-gray-500 mb-3">Edit existing examination buttons or add new ones to any section.</p>
              {[
                ["General", "general", examButtons.general || []],
                ["Cardiovascular", "cvs", examButtons.cvs || []],
                ["Respiratory", "resp", examButtons.resp || []],
                ["Abdominal", "abdo", examButtons.abdo || []],
                ["Neurological", "neuro", examButtons.neuro || []],
                ["Musculoskeletal", "msk", examButtons.msk || []],
              ].map(([label, sectionKey, btns]) => (
                <div key={sectionKey} className="mb-4 border rounded p-3">
                  <h3 className="text-sm font-bold text-gray-700 mb-2">{label}</h3>
                  {[...btns, ...(examCustom[sectionKey]||[])].map(b => {
                    const eKey = `exam__${b.key}`;
                    const isEditing = editingKey === eKey;
                    const curSafe   = getLabel(b.key,"safe",b.safe);
                    const curUnsafe = getLabel(b.key,"unsafe",b.unsafe);
                    const hasOv = !!(userConfig.__overrides?.[b.key]);
                    const isCustom = !!(examCustom[sectionKey]||[]).find(x=>x.key===b.key);
                    return (
                      <div key={b.key} className="mb-1">
                        <div className="flex items-center gap-2">
                          <span className="text-green-700 text-xs font-medium w-40 truncate">{curSafe}</span>
                          <span className="text-gray-400 text-xs">/</span>
                          <span className="text-red-700 text-xs flex-1 truncate">{curUnsafe}</span>
                          <button onClick={()=>{ setEditingKey(isEditing?null:eKey); setEditDraft({safe:curSafe,unsafe:curUnsafe}); }} className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{isEditing?"":""}</button>
                          {hasOv && <button onClick={()=>resetOverride(b.key)} className="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs"></button>}
                          {isCustom && <button onClick={()=>removeExamItem(sectionKey,b.key)} className="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs"></button>}
                        </div>
                        {isEditing && (
                          <div className="mt-1 p-2 bg-blue-50 rounded">
                            <div className="grid grid-cols-2 gap-2 mb-2">
                              <input type="text" value={editDraft.safe} onChange={e=>setEditDraft(p=>({...p,safe:e.target.value}))} placeholder="Safe state" className="px-2 py-1 border rounded text-xs"/>
                              <input type="text" value={editDraft.unsafe} onChange={e=>setEditDraft(p=>({...p,unsafe:e.target.value}))} placeholder="Unsafe state" className="px-2 py-1 border rounded text-xs"/>
                            </div>
                            <div className="flex justify-end gap-2">
                              <button onClick={()=>setEditingKey(null)} className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs">Cancel</button>
                              <button onClick={()=>saveOverride(b.key,editDraft.safe,editDraft.unsafe)} className="px-2 py-1 bg-blue-600 text-white rounded text-xs">Save</button>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                  {/* Add new exam button */}
                  <div className="mt-2 pt-2 border-t border-dashed flex gap-2 items-end">
                    <div className="flex-1">
                      <input type="text" value={examAddInput[sectionKey]?.safe||""} onChange={e=>setExamAddInput(p=>({...p,[sectionKey]:{...(p[sectionKey]||{}),safe:e.target.value}}))}
                        placeholder="Safe state" className="w-full px-2 py-1 border rounded text-xs mb-1"/>
                      <input type="text" value={examAddInput[sectionKey]?.unsafe||""} onChange={e=>setExamAddInput(p=>({...p,[sectionKey]:{...(p[sectionKey]||{}),unsafe:e.target.value}}))}
                        placeholder="Unsafe state" className="w-full px-2 py-1 border rounded text-xs"/>
                    </div>
                    <button onClick={()=>addExamItem(sectionKey)} disabled={!examAddInput[sectionKey]?.safe?.trim()||!examAddInput[sectionKey]?.unsafe?.trim()}
                      className="px-2 py-1 bg-blue-600 text-white rounded text-xs disabled:opacity-40"> Add</button>
                  </div>
                </div>
              ))}
              <button onClick={() => setMode("assess")} className="mt-2 w-full py-3 bg-blue-600 text-white rounded font-medium hover:bg-blue-700"> Done  Go to Assessment</button>
            </>)}
          </div>
        )}

        {/* ASSESS MODE */}
        {mode === "assess" && (
          <>
            {/* Patient demographics */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <div className="grid grid-cols-4 gap-3">
                <div>
                  <label className="block text-xs font-semibold text-gray-500 mb-1">Bed</label>
                  <input type="text" value={bedNumber} onChange={e=>setBedNumber(e.target.value)}
                    placeholder="e.g. 4B" className="w-full px-3 py-2.5 border rounded text-base"/>
                </div>
                <div>
                  <label className="block text-xs font-semibold text-gray-500 mb-1">Initials</label>
                  <input type="text" value={patientInitials} onChange={e=>setPatientInitials(e.target.value.toUpperCase())}
                    placeholder="e.g. JDS" maxLength={5} className="w-full px-3 py-2.5 border rounded text-base tracking-widest font-mono"/>
                </div>
                <div>
                  <label className="block text-xs font-semibold text-gray-500 mb-1">Age</label>
                  <input type="number" value={patientAge} onChange={e=>setPatientAge(e.target.value)}
                    placeholder="e.g. 67" className="w-full px-3 py-2.5 border rounded text-base"/>
                </div>
                <div>
                  <label className="block text-xs font-semibold text-gray-500 mb-1">Sex</label>
                  <div className="flex gap-2 h-10">
                    {["Male","Female","Other"].map(s => (
                      <button key={s} type="button" onClick={() => setPatientSex(patientSex === s ? "" : s)}
                        className={`flex-1 rounded text-sm font-medium transition-all ${patientSex === s ? "bg-blue-600 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                        {s === "Male" ? "M" : s === "Female" ? "F" : "O"}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </section>

            {/* Presenting Complaint */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <label className="block font-semibold mb-2">Presenting Complaint</label>
              <select value={presentation} onChange={e => { setPresentation(e.target.value); setFeatures({}); }}
                className="w-full px-3 py-3 border rounded text-base">
                <option value="">-- Select presentation --</option>
                {Object.entries(CATEGORIES).map(([cat, pres]) => (
                  <optgroup key={cat} label={cat}>
                    {pres.map(p => <option key={p} value={p}>{p}</option>)}
                  </optgroup>
                ))}
              </select>
            </section>

            {/* HOPC */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <label className="block font-semibold mb-2">HOPC</label>
              <textarea value={hopc} onChange={e=>setHopc(e.target.value)}
                placeholder="Site, onset, duration, character, severity, aggravating/relieving factors..."
                className="w-full px-3 py-3 border rounded h-24 text-base"/>
            </section>

            {/* Presentation Features */}
            {presentation && getEnabledFeatures(presentation).length > 0 && (
              <details open className="bg-white rounded-lg shadow-sm p-3 mb-3">
                <summary className="font-semibold cursor-pointer mb-2">
                  History: {presentation}
                  {(userConfig[presentation]?.redFlags?.length||0) > 0 && (
                    <span className="text-xs text-amber-600 ml-2"> = your red flags</span>
                  )}
                </summary>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
                  {getEnabledFeatures(presentation).map(f => (
                    <Btn key={f.key} btn={f} />
                  ))}
                </div>
              </details>
            )}

            {/* Diagnosis red flags */}
            {presentation && DIAGNOSES[presentation] && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                <p className="text-xs font-semibold text-red-700"> Consider excluding: {DIAGNOSES[presentation]}</p>
              </div>
            )}

            {/* Review of Systems */}
            <details className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <summary className="font-semibold cursor-pointer">Review of Systems</summary>
              <p className="text-xs text-gray-400 mt-1 mb-3">Tap once =  normal/absent  tap again =  abnormal/present  tap again = clear</p>
              {[
                ["Constitutional", [
                  ["No weight loss","Weight loss"],["No weight gain","Weight gain"],["No fatigue","Fatigue"],
                  ["Afebrile","Fever/chills"],["No night sweats","Night sweats"],["Sleeping well","Insomnia"],["No chronic pain","Chronic pain"],
                ]],
                ["Eyes", [
                  ["Vision normal","Vision change"],["No double vision","Double vision"],
                  ["No red eye","Red eye"],["No eye discharge","Eye discharge"],
                ]],
                ["Ears/Nose/Throat", [
                  ["Hearing normal","Hearing change"],["No ear pain/discharge","Ear pain/discharge"],
                  ["No nasal congestion","Nasal congestion"],["No sore throat","Sore throat"],
                  ["Voice normal","Hoarseness"],["No mouth sores","Mouth sores"],["No dysphagia","Dysphagia"],
                ]],
                ["Cardiovascular", [
                  ["No chest pain","Chest pain"],["No palpitations","Palpitations"],["No orthopnea","Orthopnea"],
                  ["No PND","PND"],["No leg edema","Leg edema"],["No claudication","Claudication"],["No syncope","Syncope"],
                ]],
                ["Respiratory", [
                  ["No dyspnea at rest","Dyspnea at rest"],["No dyspnea on exertion","Dyspnea on exertion"],
                  ["No cough","Cough"],["No haemoptysis","Haemoptysis"],["No wheeze","Wheeze"],["No snoring","Snoring"],
                ]],
                ["Gastrointestinal", [
                  ["No heartburn","Heartburn"],["No abdominal pain","Abdominal pain"],["No nausea/vomiting","Nausea/vomiting"],
                  ["No difficulty swallowing","Dysphagia"],["No haematemesis","Haematemesis"],["No melaena","Melaena"],
                  ["No PR bleeding","PR bleeding"],["No diarrhea","Diarrhea"],["No constipation","Constipation"],["No jaundice","Jaundice"],
                ]],
                ["Genitourinary", [
                  ["No haematuria","Haematuria"],["No dysuria","Dysuria"],["No nocturia","Nocturia"],
                  ["No incontinence","Incontinence"],["No incomplete emptying","Incomplete emptying"],
                  ["Normal urinary frequency","Urinary frequency"],["No urinary urgency","Urinary urgency"],
                ]],
                ["Musculoskeletal", [
                  ["No joint pain/swelling","Joint pain/swelling"],["No muscle ache","Muscle ache"],
                  ["No back pain","Back pain"],["No knee pain","Knee pain"],["No shoulder pain","Shoulder pain"],["No hip pain","Hip pain"],
                ]],
                ["Skin", [
                  ["No rash","Rash"],["No hair loss","Hair loss"],["No skin growths","Skin growths"],
                  ["No non-healing sores","Non-healing sores"],["No itching","Itching"],
                ]],
                ["Neurological", [
                  ["No headache","Headache"],["No dizziness","Dizziness"],["No numbness/tingling","Numbness/tingling"],
                  ["No weakness","Weakness"],["No balance problems","Balance problems"],["No seizures","Seizures"],
                  ["No sudden neuro deficit","Sudden neuro deficit"],
                ]],
                ["Psychiatric", [
                  ["Mood normal","Low mood/depression"],["No anxiety","Anxiety"],["Memory intact","Memory problems"],
                  ["No suicidal ideation","Suicidal ideation"],["No substance use","Substance use"],
                ]],
                ["Endocrine", [
                  ["No polyuria","Polyuria"],["No polydipsia","Polydipsia"],["No polyphagia","Polyphagia"],
                  ["No heat/cold intolerance","Heat/cold intolerance"],["Weight stable","Weight change"],
                ]],
                ["Haematological", [
                  ["No abnormal bleeding/bruising","Abnormal bleeding/bruising"],["No new lumps/bumps","New lumps/bumps"],
                  ["No recurrent infections","Recurrent infections"],["No hypercoagulability","Hypercoagulability"],
                ]],
                ["Allergic/Immunological", [
                  ["No seasonal allergies","Seasonal allergies"],["No food allergies","Food allergies"],
                  ["No frequent infections","Frequent infections"],["No autoimmune symptoms","Autoimmune symptoms"],
                  ["No unusual drug reactions","Unusual drug reactions"],
                ]],
              ].map(([system, pairs]) => (
                <div key={system} className="mb-3">
                  <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">{system}</h4>
                  <div className="flex flex-wrap gap-1">
                    {[...pairs, ...(rosCustom[system]||[]).map(c=>([c.safe,c.unsafe]))].map(([safe, unsafe]) => {
                      const rKey = `ros__${safe}`;
                      const curSafe   = getLabel(rKey,"safe",safe);
                      const curUnsafe = getLabel(rKey,"unsafe",unsafe);
                      const state = ros[safe];
                      return (
                        <button key={safe} type="button" onClick={() => toggleRos(safe)}
                          className={`px-2 py-1.5 rounded text-xs font-medium transition-all text-white ${
                            state === "safe"   ? "bg-green-600 hover:bg-green-700" :
                            state === "unsafe" ? "bg-red-600 hover:bg-red-700" :
                            "bg-gray-500 hover:bg-gray-600"
                          }`}>
                          {state === "safe" ? curSafe : state === "unsafe" ? curUnsafe : curUnsafe}
                        </button>
                      );
                    })}
                  </div>
                </div>
              ))}
            </details>

            {/* Medications */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <label className="block font-semibold mb-2">Medications</label>
              <button type="button" onClick={() => { setNoRegularMeds(!noRegularMeds); setMedications(""); }}
                className={`mb-2 px-4 py-2 rounded font-medium text-sm ${noRegularMeds?"bg-green-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                No regular medications
              </button>
              {!noRegularMeds && <textarea value={medications} onChange={e=>setMedications(e.target.value)} placeholder="Current medications..." className="w-full px-3 py-2 border rounded h-16 text-base"/>}
            </section>

            {/* Allergies */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <label className="block font-semibold mb-2">Allergies</label>
              <button type="button" onClick={() => { setNkda(!nkda); setAllergies(""); }}
                className={`mb-2 px-4 py-2 rounded font-medium text-sm ${nkda?"bg-green-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                NKDA
              </button>
              {!nkda && <input type="text" value={allergies} onChange={e=>setAllergies(e.target.value)} placeholder="Drug allergies..." className="w-full px-3 py-2 border rounded text-base"/>}
            </section>

            {/* Past Medical History  after ROS */}
            <details className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <summary className="font-semibold cursor-pointer mb-2">Past Medical History</summary>
              <button type="button" onClick={() => setNsmh(!nsmh)}
                className={`mb-3 px-4 py-2 rounded font-medium text-sm ${nsmh?"bg-green-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                No significant medical history
              </button>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                {pmhxButtons.map(b => <Btn key={b.key} btn={b}/>)}
              </div>
              <textarea value={pmhx} onChange={e=>setPmhx(e.target.value)} placeholder="Additional medical history..." className="w-full px-3 py-2 border rounded h-16 text-base"/>
            </details>

            {/* Social History  expanded with 2nd tier */}
            <details className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <summary className="font-semibold cursor-pointer mb-2">Social History</summary>

              {/* Smoking */}
              <div className="mb-4">
                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Smoking</h4>
                <div className="flex gap-2 flex-wrap mb-2">
                  {[{key:"soc_smoker",safe:"Non-smoker",unsafe:"Current smoker"},{key:"soc_exsmoker",safe:"Never smoked",unsafe:"Ex-smoker"}].map(b => (
                    <button key={b.key} type="button" onClick={() => toggleFeature(b.key)}
                      className={`px-3 py-2 rounded text-sm font-medium ${features[b.key]==="safe"?"bg-green-600 text-white":features[b.key]==="unsafe"?"bg-orange-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                      {features[b.key]==="safe" ? b.safe : features[b.key]==="unsafe" ? b.unsafe : `${b.safe} / ${b.unsafe}`}
                    </button>
                  ))}
                </div>
                {features["soc_smoker"] === "unsafe" && (
                  <div className="grid grid-cols-3 gap-2 bg-orange-50 rounded p-2">
                    <div><label className="text-xs text-gray-500 block mb-1">Cigs/day</label><input type="number" value={cigsPerDay} onChange={e=>setCigsPerDay(e.target.value)} placeholder="20" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                    <div><label className="text-xs text-gray-500 block mb-1">Years smoking</label><input type="number" value={smokingYears} onChange={e=>setSmokingYears(e.target.value)} placeholder="10" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                    <div><label className="text-xs text-gray-500 block mb-1">Pack years</label><input type="number" value={packYears} onChange={e=>setPackYears(e.target.value)} placeholder="10" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                  </div>
                )}
                {features["soc_exsmoker"] === "unsafe" && (
                  <div className="grid grid-cols-3 gap-2 bg-yellow-50 rounded p-2">
                    <div><label className="text-xs text-gray-500 block mb-1">Stopped (years ago)</label><input type="number" value={exSmokingYears} onChange={e=>setExSmokingYears(e.target.value)} placeholder="5" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                    <div><label className="text-xs text-gray-500 block mb-1">Pack years</label><input type="number" value={packYears} onChange={e=>setPackYears(e.target.value)} placeholder="20" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                  </div>
                )}
              </div>

              {/* Alcohol */}
              <div className="mb-4">
                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Alcohol</h4>
                <div className="flex gap-2 mb-2">
                  {[{k:"safe",l:"No excess alcohol"},{k:"unsafe",l:"Alcohol use"}].map(({k,l}) => (
                    <button key={k} type="button" onClick={() => setFeatures(p=>({...p, soc_alcohol: p.soc_alcohol===k ? null : k}))}
                      className={`px-3 py-2 rounded text-sm font-medium ${features["soc_alcohol"]===k?(k==="safe"?"bg-green-600 text-white":"bg-orange-500 text-white"):"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                      {l}
                    </button>
                  ))}
                </div>
                {features["soc_alcohol"] === "unsafe" && (
                  <div className="grid grid-cols-2 gap-2 bg-orange-50 rounded p-2">
                    <div><label className="text-xs text-gray-500 block mb-1">Standard drinks/week</label><input type="number" value={alcoholUnits} onChange={e=>setAlcoholUnits(e.target.value)} placeholder="14" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                    <div><label className="text-xs text-gray-500 block mb-1">Type (beer/wine/spirits)</label><input type="text" value={alcoholType} onChange={e=>setAlcoholType(e.target.value)} placeholder="Beer" className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                  </div>
                )}
              </div>

              {/* Illicit drugs */}
              <div className="mb-4">
                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Illicit/Recreational Drugs</h4>
                <div className="flex gap-2 mb-2">
                  {[{k:"safe",l:"No illicit drugs"},{k:"unsafe",l:"Drug use"}].map(({k,l}) => (
                    <button key={k} type="button" onClick={() => setFeatures(p=>({...p, soc_drugs: p.soc_drugs===k ? null : k}))}
                      className={`px-3 py-2 rounded text-sm font-medium ${features["soc_drugs"]===k?(k==="safe"?"bg-green-600 text-white":"bg-orange-500 text-white"):"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                      {l}
                    </button>
                  ))}
                </div>
                {features["soc_drugs"] === "unsafe" && (
                  <div className="bg-orange-50 rounded p-2">
                    <label className="text-xs text-gray-500 block mb-1">Specify (substance, route, frequency)</label>
                    <input type="text" value={drugDetails} onChange={e=>setDrugDetails(e.target.value)} placeholder="e.g. Cannabis daily, MDMA occasional" className="w-full px-2 py-1.5 border rounded text-sm"/>
                  </div>
                )}
              </div>

              {/* Functional status */}
              <div className="mb-2">
                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Functional Status</h4>
                <div className="flex gap-2 mb-2">
                  {[{k:"safe",l:"Functionally independent"},{k:"unsafe",l:"Functional dependence"}].map(({k,l}) => (
                    <button key={k} type="button" onClick={() => setFeatures(p=>({...p, soc_function: p.soc_function===k ? null : k}))}
                      className={`px-3 py-2 rounded text-sm font-medium ${features["soc_function"]===k?(k==="safe"?"bg-green-600 text-white":"bg-red-600 text-white"):"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                      {l}
                    </button>
                  ))}
                </div>
                {features["soc_function"] === "unsafe" && (
                  <div className="bg-red-50 rounded p-3 space-y-2">
                    <div className="grid grid-cols-2 gap-2">
                      <div><label className="text-xs text-gray-500 block mb-1">Lives with</label><input type="text" value={livesWithWhom} onChange={e=>setLivesWithWhom(e.target.value)} placeholder="Partner, alone, family..." className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                      <div><label className="text-xs text-gray-500 block mb-1">Mobility aid</label><input type="text" value={walkingAid} onChange={e=>setWalkingAid(e.target.value)} placeholder="None, stick, frame, wheelchair..." className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                      <div><label className="text-xs text-gray-500 block mb-1">Stairs at home</label><input type="text" value={stairsInHome} onChange={e=>setStairsInHome(e.target.value)} placeholder="None, entry only, throughout..." className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                      <div><label className="text-xs text-gray-500 block mb-1">Formal supports</label><input type="text" value={formalSupports} onChange={e=>setFormalSupports(e.target.value)} placeholder="HCP 3x/week, NDIS, RAC..." className="w-full px-2 py-1.5 border rounded text-sm"/></div>
                    </div>
                    <div className="flex gap-3 flex-wrap">
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Showers independently?</p>
                        <div className="flex gap-2">
                          {[true,false].map(v => <button key={String(v)} type="button" onClick={()=>setIndependentShower(independentShower===v?null:v)} className={`px-3 py-1.5 rounded text-xs font-medium ${independentShower===v?(v?"bg-green-600 text-white":"bg-red-600 text-white"):"bg-gray-200 text-gray-700"}`}>{v?"Yes":"No"}</button>)}
                        </div>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Manages own finances?</p>
                        <div className="flex gap-2">
                          {[true,false].map(v => <button key={String(v)} type="button" onClick={()=>setIndependentBills(independentBills===v?null:v)} className={`px-3 py-1.5 rounded text-xs font-medium ${independentBills===v?(v?"bg-green-600 text-white":"bg-red-600 text-white"):"bg-gray-200 text-gray-700"}`}>{v?"Yes":"No"}</button>)}
                        </div>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Falls in last 12 months?</p>
                        <div className="flex gap-2">
                          {[true,false].map(v => <button key={String(v)} type="button" onClick={()=>setFallsHistory(fallsHistory===v?null:v)} className={`px-3 py-1.5 rounded text-xs font-medium ${fallsHistory===v?(v?"bg-red-600 text-white":"bg-green-600 text-white"):"bg-gray-200 text-gray-700"}`}>{v?"Yes":"No"}</button>)}
                        </div>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Frailty?</p>
                        <div className="flex gap-2">
                          {[true,false].map(v => <button key={String(v)} type="button" onClick={()=>setFrailty(frailty===v?null:v)} className={`px-3 py-1.5 rounded text-xs font-medium ${frailty===v?(v?"bg-red-600 text-white":"bg-green-600 text-white"):"bg-gray-200 text-gray-700"}`}>{v?"Yes":"No"}</button>)}
                        </div>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Currently driving?</p>
                        <div className="flex gap-2">
                          {[true,false].map(v => <button key={String(v)} type="button" onClick={()=>setDriving(driving===v?null:v)} className={`px-3 py-1.5 rounded text-xs font-medium ${driving===v?(v?"bg-blue-600 text-white":"bg-gray-600 text-white"):"bg-gray-200 text-gray-700"}`}>{v?"Yes":"No"}</button>)}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Context flags */}
              <div className="mb-2">
                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Context</h4>
                <div className="flex flex-wrap gap-2">
                  {[
                    {label:"Housing insecurity", state:housingInsecurity, setter:setHousingInsecurity},
                    {label:"Carer responsibilities", state:carerResponsibilities, setter:setCarerResponsibilities},
                  ].map(({label,state,setter}) => (
                    <button key={label} type="button" onClick={()=>setter(state?null:true)}
                      className={`px-3 py-2 rounded text-sm font-medium ${state?"bg-orange-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`}>
                      {label}
                    </button>
                  ))}
                </div>
              </div>
            </details>

            {/* Examination */}
            <details open className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <summary className="font-semibold cursor-pointer mb-2">Examination</summary>
              <h4 className="text-xs font-semibold text-gray-500 uppercase mt-3 mb-2">Vital Signs</h4>
              <p className="text-xs text-gray-400 mb-3">Tap to select  tap again to deselect   normal   borderline   abnormal</p>

              <VitalGrid label="Temp (C)"
                values={["35.0","35.5","36.0","36.5","37.0","37.5","38.0","38.5","39.0","39.5","40.0","40.5"]}
                current={temp} setter={setTemp}
                colorFn={v => { const n=parseFloat(v); return n<36?"bg-blue-100 text-blue-700": n<=37.5?"bg-green-100 text-green-700": n<=38.4?"bg-orange-100 text-orange-700":"bg-red-100 text-red-700"; }}
              />

              <div className="mb-4">
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm font-semibold text-gray-700">Blood Pressure (mmHg)</span>
                  {(bp||dbp) ? <span className={`text-sm font-bold px-2 py-0.5 rounded ${parseInt(bp)<90?"bg-red-100 text-red-700":parseInt(bp)<=119?"bg-green-100 text-green-700":parseInt(bp)<=139?"bg-orange-100 text-orange-700":"bg-red-100 text-red-700"}`}>{bp||"?"}/{dbp||"?"}</span>
                    : <span className="text-xs text-gray-400">not set</span>}
                </div>
                <p className="text-xs text-gray-500 mb-1">Systolic</p>
                <div className="flex flex-wrap gap-1 mb-2">
                  {["70","80","90","100","110","120","130","140","150","160","170","180","190","200"].map(v => {
                    const n=parseInt(v); const c=n<90?"bg-red-200 text-red-800":n<=119?"bg-green-200 text-green-800":n<=139?"bg-orange-200 text-orange-800":"bg-red-200 text-red-800";
                    return <button key={v} type="button" onClick={()=>setBp(bp===v?"":v)} className={`px-2 py-1.5 rounded text-xs font-medium ${c} ${bp===v?"ring-2 ring-offset-1 ring-gray-700 scale-110":""}`}>{v}</button>;
                  })}
                </div>
                <p className="text-xs text-gray-500 mb-1">Diastolic</p>
                <div className="flex flex-wrap gap-1">
                  {["40","45","50","55","60","65","70","75","80","85","90","95","100","105","110","120"].map(v => {
                    const n=parseInt(v); const c=n<60?"bg-red-200 text-red-800":n<=79?"bg-green-200 text-green-800":n<=89?"bg-orange-200 text-orange-800":"bg-red-200 text-red-800";
                    return <button key={v} type="button" onClick={()=>setDbp(dbp===v?"":v)} className={`px-2 py-1.5 rounded text-xs font-medium ${c} ${dbp===v?"ring-2 ring-offset-1 ring-gray-700 scale-110":""}`}>{v}</button>;
                  })}
                </div>
              </div>

              <VitalGrid label="Heart Rate (bpm)"
                values={["40","45","50","55","60","65","70","75","80","85","90","95","100","110","120","130","140","150"]}
                current={hr} setter={setHr}
                colorFn={v => { const n=parseInt(v); return n<50?"bg-red-100 text-red-700": n<=100?"bg-green-100 text-green-700": n<=120?"bg-orange-100 text-orange-700":"bg-red-100 text-red-700"; }}
              />
              <VitalGrid label="Resp Rate (/min)"
                values={["8","10","12","14","16","18","20","22","24","26","28","30","35","40"]}
                current={rr} setter={setRr}
                colorFn={v => { const n=parseInt(v); return n<10?"bg-red-100 text-red-700": n<=20?"bg-green-100 text-green-700": n<=25?"bg-orange-100 text-orange-700":"bg-red-100 text-red-700"; }}
              />
              <VitalGrid label="SpO2 (%)"
                values={["82","84","86","88","90","91","92","93","94","95","96","97","98","99","100"]}
                current={spo2} setter={setSpo2}
                colorFn={v => { const n=parseInt(v); return n<92?"bg-red-100 text-red-700": n<=94?"bg-orange-100 text-orange-700":"bg-green-100 text-green-700"; }}
              />

              {[["General","general",examButtons.general],["Cardiovascular","cvs",examButtons.cvs],["Respiratory","resp",examButtons.resp],["Abdominal","abdo",examButtons.abdo],["Neurological","neuro",examButtons.neuro],["Musculoskeletal","msk",examButtons.msk]].map(([label,sectionKey,btns]) => (
                <div key={label}>
                  <h4 className="text-xs font-semibold text-gray-500 uppercase mt-3 mb-2">{label}</h4>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                    {[...btns,...(examCustom[sectionKey]||[])].map(b => {
                      const overSafe   = getLabel(b.key,"safe",b.safe);
                      const overUnsafe = getLabel(b.key,"unsafe",b.unsafe);
                      const overBtn = {...b, safe:overSafe, unsafe:overUnsafe};
                      return <Btn key={b.key} btn={overBtn}/>;
                    })}
                  </div>
                </div>
              ))}
            </details>

            {/* Investigations */}
            <details className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <summary className="font-semibold cursor-pointer mb-2">Investigations</summary>

              {/* Serial Troponins */}
              <div className="mb-4">
                <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Serial Troponins</h4>
                <div className="space-y-2">
                  {[
                    ["Troponin 1", trop1Result, setTrop1Result, trop1Time, setTrop1Time, null, null],
                    ["Troponin 2", trop2Result, setTrop2Result, trop2Time, setTrop2Time, trop2Delta, setTrop2Delta],
                    ["Troponin 3", trop3Result, setTrop3Result, trop3Time, setTrop3Time, trop3Delta, setTrop3Delta],
                  ].map(([label, result, setResult, time, setTime, delta, setDelta]) => (
                    <div key={label} className="bg-gray-50 rounded p-2">
                      <p className="text-xs font-semibold text-gray-600 mb-1">{label}</p>
                      <div className="flex gap-2 flex-wrap">
                        <div className="flex-1 min-w-24">
                          <label className="text-xs text-gray-400 block mb-0.5">Result (ng/L)</label>
                          <input type="text" value={result} onChange={e=>setResult(e.target.value)} placeholder="e.g. 8" className="w-full px-2 py-1.5 border rounded text-sm"/>
                        </div>
                        <div className="flex-1 min-w-24">
                          <label className="text-xs text-gray-400 block mb-0.5">Time drawn</label>
                          <input type="text" value={time} onChange={e=>setTime(e.target.value)} placeholder="e.g. 14:30" className="w-full px-2 py-1.5 border rounded text-sm"/>
                        </div>
                        {setDelta && (
                          <div className="flex-1 min-w-24">
                            <label className="text-xs text-gray-400 block mb-0.5"> from prior</label>
                            <input type="text" value={delta} onChange={e=>setDelta(e.target.value)} placeholder="e.g. +3" className="w-full px-2 py-1.5 border rounded text-sm"/>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Other bloods */}
              <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Other Bloods</h4>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                {invButtons.filter(b=>b.key!=="inv_trop").map(b => <Btn key={b.key} btn={b}/>)}
              </div>

              {/* ECG & CXR */}
              <div className="space-y-2">
                {[["ECG","inv_ecg",ecgComment,setEcgComment,"ECG findings..."],["CXR","inv_cxr",cxrComment,setCxrComment,"CXR findings..."]].map(([label,key,val,setter,ph]) => (
                  <div key={key}>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">{label}</label>
                    <div className="flex gap-2">
                      <button type="button" onClick={()=>toggleFeature(key)} className={`flex-shrink-0 ${getButtonClass(features[key]||"null",false)} w-32`}>
                        {features[key]==="safe"?`${label} normal`:features[key]==="unsafe"?`${label} abnormal`:`${label} (tap)`}
                      </button>
                      <input type="text" value={val} onChange={e=>setter(e.target.value)} placeholder={ph} className="flex-1 px-3 py-2 border rounded text-sm"/>
                    </div>
                  </div>
                ))}
              </div>
            </details>

            {/* Diagnosis */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <label className="block font-semibold mb-2">Diagnosis</label>
              <input type="text" value={diagnosis} onChange={e=>setDiagnosis(e.target.value)} placeholder="Primary diagnosis..." className="w-full px-3 py-3 border rounded text-base"/>
            </section>

            {/* Plan */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <label className="block font-semibold mb-2">Plan</label>
              <textarea value={plan} onChange={e=>setPlan(e.target.value)} placeholder="Non-pharm, pharm, education, referrals, disposition, follow-up..." className="w-full px-3 py-3 border rounded h-24 text-base"/>
            </section>

            {/* Output buttons */}
            <section className="bg-white rounded-lg shadow-sm p-3 mb-3">
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                <button onClick={()=>setOutput(generateReport())} className="px-4 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium"> Structured Report</button>
                <button onClick={generateAI} disabled={isGenerating} className="px-4 py-3 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 flex items-center justify-center gap-2 text-sm font-medium">
                  {isGenerating ? <><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"/>Generating...</> : " AI Prose Note"}
                </button>
                <button onClick={copyNote} className="px-4 py-3 bg-slate-600 text-white rounded hover:bg-slate-700 text-sm font-medium"> Copy</button>
                <button onClick={downloadNote} className="px-4 py-3 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm font-medium"> Download</button>
                <button onClick={emailNote} className="px-4 py-3 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-medium col-span-2 md:col-span-1"> Email</button>
              </div>
              {showKeyInput && (
                <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                  <p className="text-sm font-semibold text-blue-800 mb-1"> Anthropic API Key Required</p>
                  <p className="text-xs text-blue-600 mb-2">Enter your key  saved to this device only.</p>
                  <div className="flex gap-2">
                    <input type="password" value={apiKeyInput} onChange={e=>setApiKeyInput(e.target.value)}
                      onKeyDown={e=>e.key==="Enter"&&submitApiKey()}
                      placeholder="sk-ant-..." className="flex-1 px-3 py-2 border rounded text-sm font-mono"
                      autoComplete="off" autoCorrect="off" autoCapitalize="none" spellCheck="false"/>
                    <button onClick={submitApiKey} className="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium">Save & Generate</button>
                    <button onClick={()=>{setShowKeyInput(false);setAiError("");}} className="px-3 py-2 bg-gray-200 text-gray-700 rounded text-sm"></button>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">Get your key at console.anthropic.com  API Keys</p>
                </div>
              )}
              {aiError && !showKeyInput && (
                <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700 flex justify-between gap-2">
                  <span><strong>AI error:</strong> {aiError}</span>
                  <button onClick={()=>{localStorage.removeItem("cat_api_key");setShowKeyInput(true);setAiError("");}} className="underline shrink-0">Re-enter key</button>
                </div>
              )}
              <div className="mt-2 flex justify-between items-center">
                <p className="text-xs text-gray-400">AI note uses your Anthropic API key (stored on this device)</p>
                <button onClick={()=>{localStorage.removeItem("cat_api_key");setShowKeyInput(true);}} className="text-xs text-gray-400 underline">Clear key</button>
              </div>
            </section>

            {/* Output */}
            <section className="bg-white rounded-lg shadow-sm p-3">
              <h3 className="font-semibold mb-2">Generated Note <span className="text-xs font-normal text-gray-500">(editable)</span></h3>
              <textarea value={output} onChange={e=>setOutput(e.target.value)} placeholder="Your generated note appears here..." className="w-full h-64 px-3 py-2 border rounded font-mono text-xs md:text-sm"/>
            </section>
          </>
        )}
      </div>
    </div>
  );
}

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
